<script src="js/config.js"></script>
<script src="js/supabase-db.js"></script> 
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. เรียกใช้ UI พื้นฐานจาก config.js
        if (typeof initAppUI === 'function') initAppUI();

        // 2. ตรวจสอบ Session (ถ้าล็อกอินค้างไว้ให้ไป Dashboard ทันที)
        // เพิ่มส่วนนี้เพื่อทำ Auto-Redirect
        if (sysDB) {
            const { data: { session } } = await sysDB.auth.getSession();
            if (session) {
                // หากมีเซสชันอยู่แล้ว ให้ข้ามไปหน้าแดชบอร์ด
                window.location.href = 'teacher-dashboard.html';
                return; // หยุดการทำงานด้านล่าง
            }
        }

        // 3. ตรวจสอบข้อมูลอีเมลใน localStorage (สำหรับ Remember Me)
        const savedEmail = localStorage.getItem('teacher_remember_email');
        if (savedEmail) {
            document.getElementById('email').value = savedEmail;
            document.getElementById('rememberMe').checked = true;
        }
    });

    // --- ฟังก์ชัน handleLogin อื่นๆ คงเดิม ---
    async function handleLogin(e) {
        e.preventDefault();
        if (!sysDB) { alert("ไม่สามารถเชื่อมต่อระบบได้ กรุณารีเฟรชหน้าเว็บ"); return; }

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const rememberMe = document.getElementById('rememberMe').checked;
        const btn = document.getElementById('btnLogin');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบ...';

        try {
            const { data, error } = await sysDB.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) throw error;

            // จัดการ Remember Me (จำแค่อีเมลเพื่อให้การล็อกอินครั้งหน้าเร็วขึ้น)
            if (rememberMe) {
                localStorage.setItem('teacher_remember_email', email);
            } else {
                localStorage.removeItem('teacher_remember_email');
            }

            window.location.href = 'teacher-dashboard.html';

        } catch (err) {
            console.error(err);
            alert('❌ เข้าสู่ระบบไม่สำเร็จ: อีเมลหรือรหัสผ่านไม่ถูกต้อง');
            btn.disabled = false;
            btn.innerHTML = 'เข้าสู่ระบบ <i class="fas fa-sign-in-alt"></i>';
        }
    }

    function togglePass() {
        const input = document.getElementById('password');
        const icon = document.querySelector('.toggle-password');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }
</script>
