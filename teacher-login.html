<script src="js/config.js"></script>
<script src="js/supabase-db.js"></script> 
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. อัปเดตข้อมูลจาก config.js (ชื่อแอป, สโลแกน, ฟุตเตอร์)
        if (typeof initAppUI === 'function') initAppUI();

        // 2. เช็ค Session ทันที (ถ้า Login ค้างไว้ ให้ไป Dashboard เลย)
        if (sysDB) {
            const { data: { session } } = await sysDB.auth.getSession();
            if (session) {
                window.location.href = 'teacher-dashboard.html';
                return;
            }
        }

        // 3. ตรวจสอบ "จำอีเมล" (Remember Me)
        // ใช้ "if (emailInput)" เพื่อป้องกันกรณีหาช่องกรอกไม่เจอแล้วเกิด Error
        const emailInput = document.getElementById('email');
        const rememberSwitch = document.getElementById('rememberMe');
        const savedEmail = localStorage.getItem('teacher_remember_email');

        if (savedEmail && emailInput) {
            emailInput.value = savedEmail;
            if (rememberSwitch) rememberSwitch.checked = true;
        }
    });

    async function handleLogin(e) {
        e.preventDefault();
        if (!sysDB) { 
            alert("ระบบฐานข้อมูลยังไม่พร้อมใช้งาน กรุณาลองใหม่อีกครั้ง"); 
            return; 
        }

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const rememberMe = document.getElementById('rememberMe').checked;
        const btn = document.getElementById('btnLogin');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบ...';

        try {
            const { data, error } = await sysDB.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) throw error;

            // บันทึกการจดจำอีเมล
            if (rememberMe) {
                localStorage.setItem('teacher_remember_email', email);
            } else {
                localStorage.removeItem('teacher_remember_email');
            }

            window.location.href = 'teacher-dashboard.html';

        } catch (err) {
            console.error(err);
            alert('❌ เข้าสู่ระบบไม่สำเร็จ: อีเมลหรือรหัสผ่านไม่ถูกต้อง');
            btn.disabled = false;
            btn.innerHTML = 'เข้าสู่ระบบ <i class="fas fa-sign-in-alt"></i>';
        }
    }
</script>
