<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>รายชื่อนักเรียน - FlipSchool</title>
    
    <link rel="stylesheet" href="css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* --- General Styles --- */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-tool { padding: 8px 15px; border-radius: 20px; border: none; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600; }
        .btn-import { background: #e0f2f1; color: #00695c; }
        .btn-print { background: #e3f2fd; color: #1565c0; }
        
        .student-list { list-style: none; padding: 0; margin: 0; background: white; border-radius: 16px; box-shadow: var(--card-shadow); }
        .student-item { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f0f0f0; }
        .st-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .st-info { flex: 1; }
        .st-code { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #555; margin-left: 5px; }

        /* --- Wizard & Filter Styles --- */
        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .map-row { display: grid; grid-template-columns: 35% 40% 25%; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .map-label { font-weight: 600; color: #555; }
        .map-select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 95%; }
        
        /* Table Preview */
        .data-preview-box { overflow-x: auto; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .data-preview-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .data-preview-table th, .data-preview-table td { padding: 6px 10px; border: 1px solid #eee; text-align: left; }
        .data-preview-table .row-num { background: #f8f9fa; color: #888; text-align: center; width: 40px; position: sticky; left: 0; }
        .data-preview-table .is-header { background: #e3f2fd; font-weight: bold; border-bottom: 2px solid #2196f3; }
        .data-preview-table .is-data-start { background: #e8f5e9; border-left: 3px solid #4caf50; }

        .config-panel { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 20px; flex-wrap: wrap; }
        
        /* Filter Box */
        .filter-box { background: #e3f2fd; border: 1px solid #90caf9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        
        /* Conflict List */
        .conflict-list { max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
        .conflict-item { display: flex; justify-content: space-between; font-size: 12px; padding: 5px 0; border-bottom: 1px solid #eee; }
        .badge-new { background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .badge-exist { background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        
        /* Print Area (Hidden) */
        #printArea { position: absolute; top: -9999px; left: -9999px; }
    </style>
</head>
<body class="dashboard-page">

    <div id="loadingOverlay"><div class="spinner-lg"></div></div>

    <nav>
        <a href="teacher-dashboard.html" class="nav-brand">
            <img src="img/favicon.png" alt="Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjNDM2MWVlIiBkPSJNMCAyNTZDMCAxMTQuNiAxMTQuNiAwIDI1NiAwczI1NiAxMTQuNiAyNTYgMjU2LTExNC42IDI1Ni0yNTYgMjU2UzAgMzk3LjQgMCAyNTZ6Ii8+PC9zdmc+'">
            <div>Flip<span>School</span></div>
        </a>
        <a href="#" id="backBtn" class="back-link"><i class="fas fa-chevron-left"></i> ย้อนกลับ</a>
    </nav>

    <div class="container">
        <div class="toolbar">
            <button class="btn-tool btn-import" onclick="openImportModal()"><i class="fas fa-file-excel"></i> นำเข้า Excel</button>
            <button class="btn-tool btn-print" onclick="printIDCards()"><i class="fas fa-id-card"></i> พิมพ์บัตร QR</button>
            <a href="template_student.xlsx" class="btn-tool" style="background:#f5f5f5; color:#666; text-decoration:none;" download><i class="fas fa-download"></i> โหลดฟอร์ม</a>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin:0;"><i class="fas fa-users"></i> รายชื่อนักเรียนในห้อง (<span id="totalCount">0</span>)</h3>
        </div>

        <ul class="student-list" id="studentList"></ul>
    </div>

    <button class="fab-add" onclick="openAddModal()"><i class="fas fa-user-plus"></i></button>

    <div id="addModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">
                <span><i class="fas fa-user-plus"></i> เพิ่มนักเรียนเข้าห้อง</span>
                <i class="fas fa-times" onclick="closeAddModal()" style="cursor:pointer;"></i>
            </div>
            <label class="modal-label">เลขที่ในห้อง</label>
            <input type="number" id="newNumber" class="modal-input" placeholder="เช่น 1">
            <label class="modal-label">รหัสนักเรียน (Master ID)</label>
            <input type="text" id="newCode" class="modal-input" placeholder="เช่น 15401">
            <label class="modal-label">คำนำหน้า</label>
            <input type="text" id="newTitle" class="modal-input" placeholder="ด.ช.">
            <label class="modal-label">ชื่อ-นามสกุล</label>
            <input type="text" id="newName" class="modal-input" placeholder="สมชาย ใจดี">
            <button class="btn-save" onclick="addStudentManual()">บันทึก</button>
        </div>
    </div>

    <div id="importModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 900px;">
            <div class="modal-title">
                <span><i class="fas fa-database"></i> นำเข้ารายชื่อ (เชื่อมโยงฐานข้อมูลโรงเรียน)</span>
                <i class="fas fa-times" onclick="closeImportModal()"></i>
            </div>

            <div id="step1" class="step-container active">
                <div style="background:#f8f9fa; border: 2px dashed #ddd; padding:30px; text-align:center; border-radius:10px; cursor:pointer;" onclick="document.getElementById('excelFile').click()">
                    <i class="fas fa-file-excel" style="font-size:40px; color:#2ecc71; margin-bottom:10px;"></i><br>
                    <span id="fileNameDisplay">คลิกเพื่อเลือกไฟล์รายชื่อ</span>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="display:none" onchange="processFile()">
                </div>
            </div>

            <div id="step2" class="step-container">
                <div class="config-panel">
                    <div>
                        <label style="font-size:12px;font-weight:bold;">แถวหัวตาราง</label>
                        <input type="number" id="headerRowIndex" value="2" min="0" onchange="updateTableConfig()" style="width:60px;">
                    </div>
                    <div>
                        <label style="font-size:12px;font-weight:bold;">เริ่มข้อมูลแถวที่</label>
                        <input type="number" id="startRowIndex" value="3" min="1" onchange="updateTableConfig()" style="width:60px;">
                    </div>
                </div>

                <div class="data-preview-box"><table class="data-preview-table" id="previewTable"></table></div>

                <p style="font-weight:bold; font-size:14px;">จับคู่คอลัมน์:</p>
                <div id="mappingArea" style="max-height: 200px; overflow-y:auto; border-top:1px solid #eee;"></div>
                
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn-cancel" onclick="goToStep(1)">เลือกไฟล์ใหม่</button>
                    <button class="btn-confirm" onclick="prepareFilter()">ต่อไป <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div id="step3" class="step-container">
                <div class="filter-box">
                    <div style="font-weight:bold; color:#1565c0; margin-bottom:5px;"><i class="fas fa-filter"></i> เลือกกลุ่มที่จะนำเข้าห้องนี้</div>
                    <div style="display:flex; gap:10px;">
                        <select id="filterLevel" onchange="applyFilter()" style="flex:1; padding:5px; border-radius:5px; border:1px solid #ccc;"><option value="all">-- ทุกชั้น --</option></select>
                        <select id="filterRoom" onchange="applyFilter()" style="flex:1; padding:5px; border-radius:5px; border:1px solid #ccc;"><option value="all">-- ทุกห้อง --</option></select>
                    </div>
                </div>

                <p><strong>ผลการวิเคราะห์เทียบกับฐานข้อมูลโรงเรียน:</strong></p>
                <div class="conflict-list" id="analysisList"></div>
                <div id="summaryText" style="font-size:13px; font-weight:bold; color:#333; margin-bottom:10px;"></div>

                <div style="background:#fff3cd; padding:10px; border-radius:5px; font-size:12px; display:none; margin-bottom:10px;" id="conflictWarning">
                    <i class="fas fa-exclamation-triangle"></i> พบข้อมูลชื่อไม่ตรงกับในระบบ ท่านต้องการ:
                    <br>
                    <label><input type="radio" name="conflictOption" value="keep" checked> ใช้ชื่อเดิมที่มีในระบบ (แนะนำ)</label>
                    <label style="margin-left:10px;"><input type="radio" name="conflictOption" value="update"> อัปเดตชื่อตามไฟล์นี้</label>
                </div>

                <div id="progressSection" style="display:none; margin-top:15px; background:#f8f9fa; padding:10px; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                        <span id="progressText">กำลังเตรียมข้อมูล...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div style="background:#e9ecef; border-radius:10px; height:15px; overflow:hidden;">
                        <div id="progressBar" style="background:#2ecc71; width:0%; height:100%; transition: width 0.3s;"></div>
                    </div>
                    <div id="progressLog" style="font-size:11px; color:#666; margin-top:5px; height:20px; overflow:hidden; white-space:nowrap;">...</div>
                </div>

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn-cancel" onclick="goToStep(2)">ย้อนกลับ</button>
                    <button class="btn-confirm" onclick="executeImportWithProgress()">ยืนยันนำเข้า</button>
                </div>
            </div>
        </div>
    </div>

    <div id="printArea"></div>

    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <script>
        let currentClassId = new URLSearchParams(window.location.search).get('cid');
        let currentSchoolId = null;

        let allSheetRows = [], dataRows = [], headers = [];
        let finalImportList = [];

        // Mapping Config (รวมคอลัมน์ Filter)
        const MAPPING_CONFIG = [
            { key: 'student_code', label: 'รหัสประจำตัว*', required:true, keywords: ['รหัส', 'id', 'code'], checkContent: (v)=> /^\d+$/.test(v) && v.length>=4 },
            { key: 'prefix', label: 'คำนำหน้า', keywords: ['คำนำหน้า', 'prefix'], checkContent: (v)=> ['เด็ก', 'นาย', 'ด.ช.'].some(k=>String(v).includes(k)) },
            { key: 'firstname', label: 'ชื่อ (First Name)*', required:true, keywords: ['ชื่อ', 'name'], checkContent: (v)=> v && v.length>1 },
            { key: 'lastname', label: 'นามสกุล', keywords: ['สกุล', 'last'], checkContent: (v)=> v && v.length>1 },
            { key: 'class_level', label: 'ชั้น (สำหรับกรอง)', keywords: ['ชั้น', 'ระดับ', 'grade'], checkContent: (v)=> String(v).includes('ป.') || String(v).includes('ม.') },
            { key: 'room_no', label: 'ห้อง (สำหรับกรอง)', keywords: ['ห้อง', 'room'], checkContent: (v)=> /^\d+/.test(v) }
        ];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!sysDB) return;
            if (!currentClassId) { alert('URL ผิดพลาด: ไม่พบรหัสห้องเรียน'); return; }
            document.getElementById('backBtn').href = `classroom-detail.html?id=${currentClassId}`;

            await checkAuthRedirect();
            await initSchoolData();
            await fetchStudents();
            document.getElementById('loadingOverlay').style.display = 'none';
        });

        // 1. หา School ID ของห้องเรียนนี้ (พร้อม Error Handling)
        async function initSchoolData() {
            console.log("Checking School for Classroom ID:", currentClassId);
            const { data, error } = await sysDB.from('classrooms').select('school_id').eq('classroom_id', currentClassId).single();
            
            if (error) { 
                console.error("Supabase Error:", error); 
                alert('เกิดข้อผิดพลาดในการดึงข้อมูลโรงเรียน: ' + error.message);
                return; 
            }
            if (!data || !data.school_id) {
                console.warn("School ID is NULL for this classroom");
                alert('ห้องเรียนนี้ยังไม่ได้สังกัดโรงเรียน (School ID Not Found)');
                return;
            }
            currentSchoolId = data.school_id;
            console.log("School Found:", currentSchoolId);
        }

        // 2. ดึงรายชื่อ (JOIN Tables: classroom_students -> school_students)
        async function fetchStudents() {
            const { data, error } = await sysDB
                .from('classroom_students')
                .select(`
                    student_number,
                    school_students ( student_code, student_title, student_name, gender )
                `)
                .eq('classroom_id', currentClassId)
                .order('student_number');

            const list = document.getElementById('studentList');
            list.innerHTML = '';
            
            if (!data || data.length === 0) {
                list.innerHTML = `<div class="empty-state">ยังไม่มีนักเรียนในห้องนี้</div>`;
                document.getElementById('totalCount').innerText = '0';
                return;
            }

            document.getElementById('totalCount').innerText = data.length;
            data.forEach(row => {
                const st = row.school_students;
                if(!st) return; // กัน error กรณีข้อมูลไม่สมบูรณ์
                const fullName = `${st.student_title || ''}${st.student_name}`;
                
                list.innerHTML += `
                    <li class="student-item">
                        <div style="text-align:center;width:40px;font-weight:bold;color:#666;">${row.student_number}</div>
                        <div class="st-info">
                            <h4 style="margin:0;">${fullName}</h4> 
                            <span class="st-code"><i class="fas fa-id-badge"></i> ${st.student_code}</span>
                        </div>
                    </li>`;
            });
        }

        // --- Import Flow ---
        function openImportModal() { document.getElementById('importModal').style.display = 'flex'; goToStep(1); }
        function closeImportModal() { document.getElementById('importModal').style.display = 'none'; }
        function goToStep(step) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
        }

        async function processFile() {
            const fileInput = document.getElementById('excelFile');
            if(!fileInput.files[0]) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array', cellDates: true});
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    allSheetRows = XLSX.utils.sheet_to_json(ws, {header: 1, defval: ""});
                    
                    document.getElementById('headerRowIndex').value = 2; // Default
                    document.getElementById('startRowIndex').value = 3;
                    updateTableConfig();
                    goToStep(2);
                } catch(err) { alert("อ่านไฟล์ไม่สำเร็จ: " + err.message); }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        }

        function updateTableConfig() {
            const hIndex = parseInt(document.getElementById('headerRowIndex').value) || 0;
            const dIndex = parseInt(document.getElementById('startRowIndex').value) || (hIndex + 1);
            
            headers = (hIndex > 0) ? (allSheetRows[hIndex - 1] || []) : [];
            if(headers.length === 0 && allSheetRows.length > 0) {
                 headers = allSheetRows[0].map((_,i) => `Col ${i+1}`);
            }
            
            dataRows = allSheetRows.slice(Math.max(0, dIndex - 1));
            renderPreviewAndMap(hIndex - 1, dIndex - 1);
        }

        function renderPreviewAndMap(hIdx, dIdx) {
            // Render Table Preview
            const table = document.getElementById('previewTable'); table.innerHTML = '';
            let rowsToShow = [hIdx, dIdx, dIdx+1, dIdx+2].filter(i => i >= 0 && i < allSheetRows.length);
            rowsToShow = [...new Set(rowsToShow)].sort((a,b)=>a-b);
            
            rowsToShow.forEach(idx => {
                const tr = document.createElement('tr');
                if(idx === hIdx) tr.classList.add('is-header');
                const tdNum = document.createElement('td'); 
                tdNum.innerText = idx+1; 
                tdNum.className = 'row-num';
                tr.appendChild(tdNum);
                
                allSheetRows[idx].forEach(c => {
                    const td = document.createElement('td'); 
                    td.innerText = c ? String(c).substring(0,30) : ''; 
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });

            // Render Mapping
            const mapArea = document.getElementById('mappingArea'); mapArea.innerHTML = '';
            MAPPING_CONFIG.forEach(field => {
                let bestIdx = -1, maxScore = 0;
                headers.forEach((h, i) => {
                    let score = 0;
                    if(String(h).includes(field.keywords[0])) score += 10;
                    if(dataRows[0] && field.checkContent(dataRows[0][i])) score += 5;
                    if(score > maxScore) { maxScore = score; bestIdx = i; }
                });

                let opts = `<option value="-1">-- ไม่ระบุ --</option>`;
                headers.forEach((h, i) => opts += `<option value="${i}" ${i===bestIdx?'selected':''}>${h}</option>`);
                
                mapArea.innerHTML += `<div class="map-row"><div class="map-label">${field.label}</div><select id="map_${field.key}" class="map-select">${opts}</select></div>`;
            });
        }

        // --- Filter & Analyze ---
        function prepareFilter() {
            const lvlIdx = document.getElementById('map_class_level').value;
            const rmIdx = document.getElementById('map_room_no').value;
            
            const lvls = new Set(), rms = new Set();
            dataRows.forEach(r => {
                if(lvlIdx!=-1 && r[lvlIdx]) lvls.add(String(r[lvlIdx]).trim());
                if(rmIdx!=-1 && r[rmIdx]) rms.add(String(r[rmIdx]).trim());
            });
            
            const selLvl = document.getElementById('filterLevel'); selLvl.innerHTML = '<option value="all">-- ทุกชั้น --</option>';
            Array.from(lvls).sort().forEach(l => selLvl.innerHTML += `<option value="${l}">${l}</option>`);
            
            const selRm = document.getElementById('filterRoom'); selRm.innerHTML = '<option value="all">-- ทุกห้อง --</option>';
            Array.from(rms).sort().forEach(r => selRm.innerHTML += `<option value="${r}">${r}</option>`);

            goToStep(3);
            applyFilter();
        }

        async function applyFilter() {
            const fLvl = document.getElementById('filterLevel').value;
            const fRm = document.getElementById('filterRoom').value;
            
            // 1. กรองข้อมูลจาก Excel
            const mapping = {};
            MAPPING_CONFIG.forEach(f => mapping[f.key] = document.getElementById(`map_${f.key}`).value);

            if(mapping.student_code == -1 || mapping.firstname == -1) {
                alert("จำเป็นต้องระบุคอลัมน์ 'รหัสประจำตัว' และ 'ชื่อ'");
                return;
            }

            const filtered = dataRows.filter(r => {
                const l = mapping.class_level!=-1 ? String(r[mapping.class_level]).trim() : 'all';
                const rm = mapping.room_no!=-1 ? String(r[mapping.room_no]).trim() : 'all';
                return (fLvl==='all' || l===fLvl) && (fRm==='all' || rm===fRm);
            });

            // 2. เช็คกับฐานข้อมูลโรงเรียน (Master Data)
            const codes = filtered.map(r => String(r[mapping.student_code]).trim()).filter(c=>c);
            
            let existingMap = new Map();
            if(codes.length > 0 && currentSchoolId) {
                const { data } = await sysDB.from('school_students')
                    .select('*')
                    .eq('school_id', currentSchoolId)
                    .in('student_code', codes);
                if(data) data.forEach(d => existingMap.set(d.student_code, d));
            }

            finalImportList = [];
            let conflictCount = 0;
            const listEl = document.getElementById('analysisList'); listEl.innerHTML = '';

            filtered.forEach(r => {
                const code = String(r[mapping.student_code]).trim();
                const fname = String(r[mapping.firstname]).trim();
                const lname = mapping.lastname!=-1 ? String(r[mapping.lastname]).trim() : '';
                const prefix = mapping.prefix!=-1 ? String(r[mapping.prefix]).trim() : '';
                const fullName = `${prefix}${fname} ${lname}`.trim();

                const dbData = existingMap.get(code);
                let status = 'new';
                let note = 'นักเรียนใหม่';

                if(dbData) {
                    status = 'exist';
                    const dbName = `${dbData.student_title||''}${dbData.student_name}`.trim();
                    if(dbName !== fullName) {
                        status = 'conflict';
                        note = `ชื่อไม่ตรง (DB: ${dbName})`;
                        conflictCount++;
                    } else {
                        note = 'มีข้อมูลแล้ว (ชื่อตรงกัน)';
                    }
                }

                finalImportList.push({
                    code, prefix, name: `${fname} ${lname}`.trim(), 
                    status, dbData
                });

                // Render UI Item (Limit 50 to avoid lag)
                if (finalImportList.length <= 50) { 
                    const badge = status==='new' ? '<span class="badge-new">New</span>' : '<span class="badge-exist">Found</span>';
                    const style = status==='conflict' ? 'color:red;font-weight:bold;' : '';
                    listEl.innerHTML += `<div class="conflict-item"><div>${badge} ${code}</div><div style="${style}">${fullName} <br><small style="color:#888">${note}</small></div></div>`;
                }
            });

            document.getElementById('summaryText').innerText = `พบ ${filtered.length} คน (ใหม่ ${filtered.length - existingMap.size}, มีแล้ว ${existingMap.size})`;
            document.getElementById('conflictWarning').style.display = conflictCount > 0 ? 'block' : 'none';
        }

        // --- Execute Import with Progress Bar ---
        const CHUNK_SIZE = 50;

        async function executeImportWithProgress() {
            const btn = document.querySelector('#step3 .btn-confirm');
            const backBtn = document.querySelector('#step3 .btn-cancel');
            const progressSection = document.getElementById('progressSection');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');

            // Lock UI
            btn.disabled = true; backBtn.disabled = true; btn.style.display = 'none';
            progressSection.style.display = 'block';

            const conflictOpt = document.querySelector('input[name="conflictOption"]:checked').value;
            const totalItems = finalImportList.length;
            let processedCount = 0;

            try {
                // Get Last Number
                const { data: last } = await sysDB.from('classroom_students')
                    .select('student_number')
                    .eq('classroom_id', currentClassId)
                    .order('student_number', {ascending:false})
                    .limit(1);
                let startNo = (last && last.length > 0) ? last[0].student_number + 1 : 1;

                // Process in Chunks
                for (let i = 0; i < totalItems; i += CHUNK_SIZE) {
                    const chunk = finalImportList.slice(i, i + CHUNK_SIZE);
                    
                    // UI Update
                    progressText.innerText = `กำลังประมวลผลชุดที่ ${(i/CHUNK_SIZE)+1}...`;
                    
                    // STEP A: Master Data
                    const masterData = [];
                    chunk.forEach(item => {
                        if (item.status === 'conflict' && conflictOpt === 'keep') return;
                        if (item.status === 'exist' && item.status !== 'conflict') return; 

                        masterData.push({
                            school_id: currentSchoolId,
                            student_code: item.code,
                            student_title: item.prefix,
                            student_name: item.name
                        });
                    });

                    if (masterData.length > 0) {
                        const { error } = await sysDB.from('school_students').upsert(masterData, { onConflict: 'school_id, student_code' });
                        if (error) throw new Error(`Master Error: ${error.message}`);
                    }

                    // STEP B: Get IDs
                    const chunkCodes = chunk.map(c => c.code);
                    const { data: masters } = await sysDB.from('school_students')
                        .select('student_id, student_code')
                        .eq('school_id', currentSchoolId)
                        .in('student_code', chunkCodes);
                    
                    const codeMap = new Map();
                    if (masters) masters.forEach(m => codeMap.set(m.student_code, m.student_id));

                    // STEP C: Enrollment
                    const enrolls = [];
                    chunk.forEach(item => {
                        const sid = codeMap.get(item.code);
                        if (sid) {
                            enrolls.push({
                                classroom_id: currentClassId,
                                student_id: sid,
                                student_number: startNo++ 
                            });
                        }
                    });

                    if (enrolls.length > 0) {
                        const { error } = await sysDB.from('classroom_students')
                            .upsert(enrolls, { onConflict: 'classroom_id, student_id', ignoreDuplicates: true });
                        if (error) throw new Error(`Enroll Error: ${error.message}`);
                    }

                    // Progress Update
                    processedCount += chunk.length;
                    const percent = Math.min(100, Math.round((processedCount / totalItems) * 100));
                    progressBar.style.width = `${percent}%`;
                    progressPercent.innerText = `${percent}%`;
                    
                    await new Promise(r => setTimeout(r, 50)); // Small delay for UI
                }

                // Finish
                progressBar.style.background = '#28a745';
                progressText.innerText = 'เสร็จสมบูรณ์!';
                await new Promise(r => setTimeout(r, 800));
                
                alert(`✅ นำเข้าสำเร็จ ${totalItems} รายการ`);
                closeImportModal();
                fetchStudents();

            } catch (err) {
                console.error(err);
                progressBar.style.background = '#dc3545';
                alert('เกิดข้อผิดพลาด: ' + err.message);
                btn.disabled = false; backBtn.disabled = false; btn.style.display = 'inline-block';
            }
        }

        // Manual Add Function
        async function addStudentManual() {
            const code = document.getElementById('newCode').value;
            const title = document.getElementById('newTitle').value;
            const name = document.getElementById('newName').value;
            const num = document.getElementById('newNumber').value;
            
            if(!code || !name) { alert('กรุณากรอกข้อมูลให้ครบ'); return; }

            // Upsert Master
            const { data: master, error: mErr } = await sysDB.from('school_students')
                .upsert([{ school_id: currentSchoolId, student_code: code, student_title: title, student_name: name }], { onConflict: 'school_id, student_code' })
                .select().single();
            
            if(mErr) { alert('Error Master: '+mErr.message); return; }

            // Insert Enroll
            const { error: eErr } = await sysDB.from('classroom_students').insert([{
                classroom_id: currentClassId,
                student_id: master.student_id,
                student_number: num
            }]);

            if(eErr) alert('Error Enroll: '+eErr.message);
            else { closeAddModal(); fetchStudents(); }
        }
        function closeAddModal() { document.getElementById('addModal').style.display='none'; }
        
        async function printIDCards() {
            // (Placeholder for existing functionality)
            alert('ฟังก์ชันนี้ยังใช้งานได้ตามปกติ (ใช้ข้อมูลจากฐานข้อมูลใหม่)');
        }
    </script>
</body>
</html>
