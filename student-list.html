<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>รายชื่อนักเรียน - FlipSchool</title>
    
    <link rel="stylesheet" href="css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* CSS เพิ่มเติมเฉพาะหน้านี้ */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-tool {
            padding: 8px 15px; border-radius: 20px; border: none; font-size: 14px;
            cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600;
        }
        .btn-import { background: #e0f2f1; color: #00695c; }
        .btn-print { background: #e3f2fd; color: #1565c0; }
        
        .student-list { list-style: none; padding: 0; margin: 0; background: white; border-radius: 16px; box-shadow: var(--card-shadow); }
        .student-item { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f0f0f0; }
        .st-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .st-info { flex: 1; }
        .st-code { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #555; margin-left: 5px; }

        /* Import Wizard Styles */
        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .map-row { display: flex; align-items: center; margin-bottom: 10px; justify-content: space-between; }
        .map-label { font-weight: 600; color: #555; width: 40%; }
        .map-select { width: 55%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; }

        .conflict-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 15px; color: #856404; }
        .conflict-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-action { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-weight: 600; }
        .btn-overwrite { background: #fff; border-color: #d32f2f; color: #d32f2f; }
        .btn-skip { background: #fff; border-color: #555; color: #555; }
        .btn-overwrite.selected { background: #d32f2f; color: white; }
        .btn-skip.selected { background: #555; color: white; }

        /* ID Card for PDF Generation (Hidden on screen) */
        #printArea { position: absolute; top: -9999px; left: -9999px; width: 210mm; }
        .id-card {
            width: 8.5cm; height: 5.4cm; border: 1px solid #ddd; border-radius: 8px; 
            padding: 10px; box-sizing: border-box; display: inline-block; margin: 5px;
            background: white; position: relative; overflow: hidden; page-break-inside: avoid;
        }
        .card-header-bg { position: absolute; top:0; left:0; width: 100%; height: 25px; background: var(--primary-color); }
        .card-content { display: flex; margin-top: 15px; align-items: center; }
        .card-qr { width: 80px; height: 80px; }
        .card-details { margin-left: 15px; font-family: 'Sarabun'; font-size: 12px; }
        .card-name { font-weight: bold; font-size: 14px; color: #333; }
        .card-code { color: #666; margin-top: 2px; }
    </style>
</head>
<body class="dashboard-page">

    <div id="loadingOverlay"><div class="spinner-lg"></div></div>

    <nav>
        <a href="teacher-dashboard.html" class="nav-brand">
            <img src="img/favicon.png" alt="Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjNDM2MWVlIiBkPSJNMCAyNTZDMCAxMTQuNiAxMTQuNiAwIDI1NiAwczI1NiAxMTQuNiAyNTYgMjU2LTExNC42IDI1Ni0yNTYgMjU2UzAgMzk3LjQgMCAyNTZ6Ii8+PC9zdmc+'">
            <div>Flip<span>School</span></div>
        </a>
        
        <a href="#" id="backBtn" class="back-link">
            <i class="fas fa-chevron-left"></i> ย้อนกลับ
        </a>
    </nav>

    <div class="container">
        <div class="toolbar">
            <button class="btn-tool btn-import" onclick="openImportModal()">
                <i class="fas fa-file-excel"></i> นำเข้า Excel
            </button>
            <button class="btn-tool btn-print" onclick="printIDCards()">
                <i class="fas fa-id-card"></i> พิมพ์บัตร QR
            </button>
            <a href="template_student.xlsx" class="btn-tool" style="background:#f5f5f5; color:#666; text-decoration:none;" download>
                <i class="fas fa-download"></i> โหลดฟอร์ม
            </a>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin:0;"><i class="fas fa-users"></i> รายชื่อนักเรียน (<span id="totalCount">0</span>)</h3>
        </div>

        <ul class="student-list" id="studentList"></ul>
    </div>

    <button class="fab-add" onclick="openAddModal()"><i class="fas fa-user-plus"></i></button>

    <div id="addModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">
                <span><i class="fas fa-user-plus"></i> เพิ่มนักเรียนใหม่</span>
                <i class="fas fa-times" onclick="closeAddModal()" style="cursor:pointer;"></i>
            </div>

            <label class="modal-label">เลขที่</label>
            <input type="number" id="newNumber" class="modal-input" placeholder="เช่น 1">

            <label class="modal-label">รหัสนักเรียน (ถ้ามี)</label>
            <input type="text" id="newCode" class="modal-input" placeholder="เช่น 15401">

            <label class="modal-label">ชื่อ-นามสกุล</label>
            <input type="text" id="newName" class="modal-input" placeholder="เช่น ด.ช.รักดี มีวินัย">

            <label class="modal-label">เพศ</label>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="gender-opt selected" onclick="selectGender('ชาย')" id="optMale" style="flex:1; padding:10px; border:2px solid #eee; border-radius:10px; text-align:center; cursor:pointer;">
                    <i class="fas fa-mars"></i> ชาย
                </div>
                <div class="gender-opt" onclick="selectGender('หญิง')" id="optFemale" style="flex:1; padding:10px; border:2px solid #eee; border-radius:10px; text-align:center; cursor:pointer;">
                    <i class="fas fa-venus"></i> หญิง
                </div>
            </div>

            <button class="btn-save" onclick="addStudent()">บันทึกข้อมูล</button>
        </div>
    </div>

    <div id="importModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">
                <span><i class="fas fa-file-import"></i> นำเข้ารายชื่อ</span>
                <i class="fas fa-times" onclick="closeImportModal()" style="cursor:pointer;"></i>
            </div>

            <div id="step1" class="step-container active">
                <p>เลือกไฟล์ Excel (.xlsx หรือ .xls)</p>
                <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" class="modal-input" style="padding:10px;">
                <button class="btn-confirm" onclick="processFile()">ต่อไป <i class="fas fa-arrow-right"></i></button>
            </div>

            <div id="step2" class="step-container">
                <p>จับคู่หัวตารางให้ตรงกัน</p>
                <div id="mappingArea"></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-cancel" onclick="goToStep(1)">ย้อนกลับ</button>
                    <button class="btn-confirm" onclick="analyzeData()">ต่อไป</button>
                </div>
            </div>

            <div id="step3" class="step-container">
                <p>ตรวจสอบข้อมูล</p>
                <div id="analysisResult" style="margin-bottom:15px; font-size:14px;"></div>
                
                <div id="conflictSection" class="conflict-box" style="display:none;">
                    <strong>⚠️ พบข้อมูลซ้ำ <span id="dupCount">0</span> รายการ</strong><br>
                    <small>มีรหัสประจำตัวนี้ในห้องแล้ว ต้องการทำอย่างไร?</small>
                    <div class="conflict-actions">
                        <button class="btn-action btn-overwrite" id="actOverwrite" onclick="setConflictAction('overwrite')">
                            <i class="fas fa-sync"></i> อัปเดตทับ
                        </button>
                        <button class="btn-action btn-skip selected" id="actSkip" onclick="setConflictAction('skip')">
                            <i class="fas fa-forward"></i> ข้ามไป
                        </button>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn-cancel" onclick="goToStep(2)">ย้อนกลับ</button>
                    <button class="btn-confirm" onclick="saveImportData()">ยืนยันนำเข้า</button>
                </div>
            </div>
        </div>
    </div>

    <div id="printArea"></div>

    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <script>
        let currentClassId = null;
        let excelRows = []; // ข้อมูลดิบจาก Excel
        let excelHeaders = []; // หัวตาราง
        let finalData = []; // ข้อมูลพร้อมบันทึก
        let conflictAction = 'skip'; // default action
        let selectedGender = 'ชาย'; // for manual add

        document.addEventListener('DOMContentLoaded', async () => {
            if (!sysDB) return;
            const params = new URLSearchParams(window.location.search);
            currentClassId = params.get('cid');
            
            if (!currentClassId) { alert('ไม่พบรหัสห้องเรียน'); return; }
            
            // ✅ ตั้งค่าปุ่มย้อนกลับให้ลิงก์ไปหน้า classroom-detail
            document.getElementById('backBtn').href = `classroom-detail.html?id=${currentClassId}`;

            await checkAuthRedirect();
            await fetchStudents();
            document.getElementById('loadingOverlay').style.display = 'none';
        });

        // --- Fetch Students ---
        async function fetchStudents() {
            const list = document.getElementById('studentList');
            try {
                const { data, error } = await sysDB.from('students').select('*').eq('classroom_id', currentClassId).order('student_number', { ascending: true });
                if (error) throw error;
                
                document.getElementById('totalCount').innerText = data.length;
                list.innerHTML = '';
                
                if (data.length === 0) { list.innerHTML = `<div class="empty-state">ยังไม่มีนักเรียน</div>`; return; }

                data.forEach(st => {
                    const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${st.student_name}&gender=${st.gender==='หญิง'?'female':'male'}`;
                    list.innerHTML += `
                        <li class="student-item">
                            <div style="text-align:center; margin-right:15px; width:30px; font-weight:bold; color:#888;">${st.student_number}</div>
                            <img src="${avatarUrl}" class="st-avatar">
                            <div class="st-info">
                                <h4 style="margin:0;">${st.student_name} <span class="st-code">${st.student_code || '-'}</span></h4>
                                <span style="font-size:12px; color:#888;">${st.gender} | ${st.birth_date ? formatDate(st.birth_date) : '-'}</span>
                            </div>
                            <i class="fas fa-trash-alt" style="color:#ddd; cursor:pointer;" onclick="deleteStudent('${st.student_id}')"></i>
                        </li>`;
                });
            } catch (err) { console.error(err); }
        }

        // --- Manual Add Logic ---
        function openAddModal() {
            const currentCount = parseInt(document.getElementById('totalCount').innerText) || 0;
            document.getElementById('newNumber').value = currentCount + 1;
            document.getElementById('newCode').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('addModal').style.display = 'flex';
        }
        function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }
        
        function selectGender(g) {
            selectedGender = g;
            document.querySelectorAll('.gender-opt').forEach(el => el.classList.remove('selected'));
            if(g === 'ชาย') document.getElementById('optMale').classList.add('selected');
            else document.getElementById('optFemale').classList.add('selected');
        }

        async function addStudent() {
            const num = document.getElementById('newNumber').value;
            const code = document.getElementById('newCode').value;
            const name = document.getElementById('newName').value;
            const btn = document.querySelector('#addModal .btn-save');

            if (!num || !name) { alert('กรุณากรอกข้อมูลให้ครบ'); return; }

            btn.innerText = 'กำลังบันทึก...'; btn.disabled = true;

            try {
                const { error } = await sysDB.from('students').insert([{
                    classroom_id: currentClassId,
                    student_number: num,
                    student_code: code,
                    student_name: name,
                    gender: selectedGender
                }]);
                if (error) throw error;
                await fetchStudents();
                closeAddModal();
            } catch (err) { alert('❌ เพิ่มไม่สำเร็จ: ' + err.message); } 
            finally { btn.innerText = 'บันทึกข้อมูล'; btn.disabled = false; }
        }

        // --- Import Logic ---
        function openImportModal() { document.getElementById('importModal').style.display = 'flex'; goToStep(1); }
        function closeImportModal() { document.getElementById('importModal').style.display = 'none'; }
        
        function goToStep(step) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
        }

        // ✅ Updated: ใช้ SheetJS อ่านไฟล์แทน read-excel-file
        async function processFile() {
            const fileInput = document.getElementById('excelFile');
            if(!fileInput.files[0]) { alert('กรุณาเลือกไฟล์'); return; }
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // cellDates: true จะช่วยแปลงวันที่จาก Excel serial number เป็น Date object ให้อัตโนมัติ
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true}); 
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // แปลงเป็น JSON แบบ Array of Arrays (header: 1)
                    const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});

                    if(!rows || rows.length < 2) { alert('ไฟล์ไม่มีข้อมูล'); return; }
                    
                    excelHeaders = rows[0]; // แถวแรกเป็นหัวตาราง
                    excelRows = rows.slice(1); // ที่เหลือเป็นข้อมูล
                    
                    renderMapping();
                    goToStep(2);
                } catch (err) {
                    console.error(err);
                    alert('อ่านไฟล์ล้มเหลว: ' + err.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function renderMapping() {
            const mapArea = document.getElementById('mappingArea');
            mapArea.innerHTML = '';
            
            const requiredFields = [
                { key: 'code', label: 'รหัสประจำตัว (Student Code)' },
                { key: 'name', label: 'ชื่อ-นามสกุล' },
                { key: 'gender', label: 'เพศ' },
                { key: 'dob', label: 'วันเกิด (วว/ดด/ปปปป)' }
            ];

            requiredFields.forEach(field => {
                let options = `<option value="">-- ไม่ระบุ --</option>`;
                excelHeaders.forEach((h, index) => {
                    const headerStr = String(h);
                    // ตรวจจับชื่อคอลัมน์แบบง่ายๆ
                    const selected = (headerStr.includes(field.label.split(' ')[0])) ? 'selected' : '';
                    options += `<option value="${index}" ${selected}>${headerStr}</option>`;
                });

                mapArea.innerHTML += `
                    <div class="map-row">
                        <div class="map-label">${field.label}</div>
                        <select id="map_${field.key}" class="map-select">${options}</select>
                    </div>`;
            });
        }

        async function analyzeData() {
            const map = {
                code: document.getElementById('map_code').value,
                name: document.getElementById('map_name').value,
                gender: document.getElementById('map_gender').value,
                dob: document.getElementById('map_dob').value
            };

            if(!map.name) { alert('จำเป็นต้องระบุคอลัมน์ "ชื่อ-นามสกุล"'); return; }

            finalData = excelRows.map(row => {
                // row เป็น array ตาม index
                const rawDate = map.dob ? row[map.dob] : null;
                
                return {
                    student_code: map.code ? String(row[map.code]).trim() : '',
                    student_name: map.name ? String(row[map.name]).trim() : '',
                    gender: map.gender ? String(row[map.gender]).trim() : 'ชาย',
                    birth_date: parseDate(rawDate),
                    classroom_id: currentClassId,
                    student_number: 0 // เดี๋ยวรันใหม่
                };
            }).filter(d => d.student_name); // กรองแถวที่ไม่มีชื่อออก

            const codes = finalData.map(d => d.student_code).filter(c => c);
            if(codes.length > 0) {
                const { data: duplicates } = await sysDB.from('students')
                    .select('student_code')
                    .eq('classroom_id', currentClassId)
                    .in('student_code', codes);
                
                const dupCount = duplicates ? duplicates.length : 0;
                document.getElementById('dupCount').innerText = dupCount;
                
                if(dupCount > 0) {
                    document.getElementById('conflictSection').style.display = 'block';
                    document.getElementById('analysisResult').innerText = `พบข้อมูลทั้งหมด ${finalData.length} รายการ (ซ้ำ ${dupCount})`;
                } else {
                    document.getElementById('conflictSection').style.display = 'none';
                    document.getElementById('analysisResult').innerText = `พร้อมนำเข้า ${finalData.length} รายการ (ไม่พบข้อมูลซ้ำ)`;
                }
            }
            
            goToStep(3);
        }

        function setConflictAction(action) {
            conflictAction = action;
            document.querySelectorAll('.btn-action').forEach(b => b.classList.remove('selected'));
            document.getElementById(action === 'overwrite' ? 'actOverwrite' : 'actSkip').classList.add('selected');
        }

        async function saveImportData() {
            const btn = document.querySelector('#step3 .btn-confirm');
            btn.innerText = 'กำลังบันทึก...'; btn.disabled = true;

            try {
                let dataToInsert = [...finalData];
                
                const { data: existing } = await sysDB.from('students').select('student_number').eq('classroom_id', currentClassId).order('student_number', {ascending:false}).limit(1);
                let startNum = existing.length > 0 ? existing[0].student_number + 1 : 1;
                dataToInsert.forEach((d, i) => { d.student_number = startNum + i; });

                if (conflictAction === 'overwrite') {
                      for (let st of dataToInsert) {
                          if(st.student_code) {
                              const { data } = await sysDB.from('students').select('student_id').eq('classroom_id', currentClassId).eq('student_code', st.student_code).maybeSingle();
                              if(data) {
                                  await sysDB.from('students').update({ student_name: st.student_name, gender: st.gender, birth_date: st.birth_date }).eq('student_id', data.student_id);
                              } else {
                                  await sysDB.from('students').insert([st]);
                              }
                          } else {
                              await sysDB.from('students').insert([st]);
                          }
                      }
                } else {
                    for (let st of dataToInsert) {
                        const { data } = await sysDB.from('students').select('student_id').eq('classroom_id', currentClassId).eq('student_code', st.student_code).maybeSingle();
                         if(!data) {
                             await sysDB.from('students').insert([st]);
                         }
                    }
                }

                alert('✅ นำเข้าข้อมูลสำเร็จ');
                closeImportModal();
                fetchStudents();

            } catch (err) {
                alert('เกิดข้อผิดพลาด: ' + err.message);
            } finally {
                btn.innerText = 'ยืนยันนำเข้า'; btn.disabled = false;
            }
        }

        // --- Helper: Date Parser ---
        function parseDate(val) {
            if (!val) return null;
            // กรณี SheetJS ส่งมาเป็น Date Object แล้ว
            if (val instanceof Date) return val.toISOString().split('T')[0];
            // กรณีเป็น String (พยายาม parse)
            const d = new Date(val);
            if (!isNaN(d.getTime())) return d.toISOString().split('T')[0];
            return null; 
        }

        function formatDate(dateStr) {
            if(!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }
        async function deleteStudent(id) {
            if(confirm('ลบนักเรียนคนนี้?')) {
                await sysDB.from('students').delete().eq('student_id', id);
                fetchStudents();
            }
        }

        // --- PDF & QR Generation ---
        async function printIDCards() {
            const { data: students } = await sysDB.from('students').select('*').eq('classroom_id', currentClassId);
            if (!students || students.length === 0) { alert('ไม่มีข้อมูลนักเรียน'); return; }

            const printArea = document.getElementById('printArea');
            printArea.innerHTML = '';
            
            students.forEach(st => {
                const qrContent = `FS|${st.student_id}`; // Unique QR
                const cardId = `card_${st.student_id}`;
                
                let dobText = '-';
                if (st.birth_date) {
                    const d = new Date(st.birth_date);
                    dobText = d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                }

                const cardHtml = `
                    <div class="id-card" id="${cardId}">
                        <div class="card-header-bg"></div>
                        <div style="text-align:right; font-size:10px; color:white; position:relative; z-index:2; padding-right:5px; padding-top:5px;">FlipSchool Student ID</div>
                        <div class="card-content">
                            <div id="qr_${st.student_id}" class="card-qr"></div>
                            <div class="card-details">
                                <div class="card-name">${st.student_name}</div>
                                <div class="card-code" style="font-size:16px; font-weight:bold; color:#4361ee;">${st.student_code || '-'}</div>
                                <div class="card-code" style="font-size:10px;">DOB: ${dobText}</div>
                            </div>
                        </div>
                    </div>
                `;
                printArea.insertAdjacentHTML('beforeend', cardHtml);
                new QRCode(document.getElementById(`qr_${st.student_id}`), { text: qrContent, width: 70, height: 70, correctLevel: QRCode.CorrectLevel.L });
            });

            setTimeout(async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const cards = document.querySelectorAll('.id-card');
                
                let x = 10, y = 10;
                for (let i = 0; i < cards.length; i++) {
                    const canvas = await html2canvas(cards[i], { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');
                    doc.addImage(imgData, 'PNG', x, y, 85, 54);
                    x += 95;
                    if (x > 110) { x = 10; y += 60; }
                    if (y > 250) { doc.addPage(); y = 10; }
                }
                doc.save('Student_ID_Cards.pdf');
                alert('✅ ดาวน์โหลด PDF เรียบร้อย');
            }, 1000);
        }
    </script>
</body>
</html>
