<!DOCTYPE html>
<html lang="th">
<head>
    <style>
        /* เพิ่มสไตล์สำหรับส่วนเลือกการเรียงลำดับ */
        .sort-options {
            background: #fff3e0;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #ffe0b2;
        }
        .sort-options label {
            font-size: 14px;
            font-weight: 600;
            color: #e65100;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        .radio-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: #555;
        }
    </style>
</head>
<body>
    <div id="importModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 900px; border-radius: 30px;">
            <div class="modal-title">
                <span><i class="fas fa-file-excel"></i> นำเข้ารายชื่อนักเรียน (Master Data)</span>
                <i class="fas fa-times" onclick="closeImportModal()" style="cursor:pointer;"></i>
            </div>
            
            <div id="step2" class="step-container" style="display:none;">
                <div style="display: flex; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div>
                        <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:4px;">หัวตาราง (แถวที่)</label>
                        <input type="number" id="headerRowIndex" value="1" min="1" onchange="updatePreview()" style="width:70px; padding:8px; border-radius:8px; border:1px solid #ddd;">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:4px;">เริ่มข้อมูล (แถวที่)</label>
                        <input type="number" id="startRowIndex" value="2" min="1" onchange="updatePreview()" style="width:70px; padding:8px; border-radius:8px; border:1px solid #ddd;">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:4px;">สิ้นสุด (แถวที่)</label>
                        <input type="number" id="endRowIndex" value="" placeholder="ทั้งหมด" onchange="updatePreview()" style="width:85px; padding:8px; border-radius:8px; border:1px solid #ddd;">
                    </div>
                </div>

                <div class="sort-options">
                    <label><i class="fas fa-sort-numeric-down"></i> ตั้งค่าการจัดลำดับเลขที่อัตโนมัติ</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="sortType" value="id_only" checked> เรียงตามเลขประจำตัว (ไม่แยกชาย-หญิง)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="sortType" value="gender_id"> แยกชาย-หญิง แล้วเรียงตามเลขประจำตัว
                        </label>
                    </div>
                </div>

                <div class="data-preview-box">
                    <table class="data-preview-table" id="previewTable"></table>
                </div>

                <p style="font-weight:bold; margin-top:15px; font-size:14px; color: var(--primary);"><i class="fas fa-link"></i> จับคู่คอลัมน์กับระบบ:</p>
                <div id="mappingArea" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;"></div>

                <button class="btn-save" style="background:var(--primary); width:100%; margin-top:25px; height: 50px;" onclick="prepareImport()">ตรวจสอบข้อมูลและต่อไป <i class="fas fa-arrow-right"></i></button>
            </div>

            </div>
    </div>

    <script>
        // เพิ่มฟิลด์คำนำหน้าเพื่อใช้แยกเพศ (ถ้าเลือกแบบแยกชายหญิง)
        const MAPPING_CONFIG = [
            { key: 'student_code', label: 'เลขประจำตัว*', required: true, keywords: ['รหัส', 'ID', 'code', 'เลขประจำตัว'] },
            { key: 'student_title', label: 'คำนำหน้า', required: false, keywords: ['คำนำหน้า', 'title', 'prefix'] },
            { key: 'first_name', label: 'ชื่อ*', required: true, keywords: ['ชื่อ', 'first name', 'fname'] },
            { key: 'last_name', label: 'นามสกุล*', required: true, keywords: ['นามสกุล', 'last name', 'lname', 'สกุล'] },
            { key: 'birth_date', label: 'วดปเกิด (YYYY-MM-DD)', required: false, keywords: ['เกิด', 'birth', 'dob'] }
            // student_number จะถูกคำนวณอัตโนมัติตามการเรียงลำดับที่เลือก
        ];

        // ... (ฟังก์ชันอื่นๆ คงเดิม) ...

        async function prepareImport() {
            const dIdx = (parseInt(document.getElementById('startRowIndex').value) || 2) - 1;
            const eIdx = parseInt(document.getElementById('endRowIndex').value) || allSheetRows.length;
            const sortType = document.querySelector('input[name="sortType"]:checked').value;
            const map = {}; MAPPING_CONFIG.forEach(f => map[f.key] = document.getElementById(`map_${f.key}`).value);

            // 1. ดึงข้อมูลดิบจากแถวที่เลือก
            let rawList = allSheetRows.slice(dIdx, eIdx).map((row) => {
                let bdate = row[map.birth_date];
                if (bdate instanceof Date) bdate = bdate.toISOString().split('T')[0];
                
                const title = String(row[map.student_title] || "").trim();
                // ฟังก์ชันช่วยระบุเพศเบื้องต้นจากคำนำหน้า
                let genderScore = 0; // 0=ชาย, 1=หญิง
                if (['ด.ญ.', 'เด็กหญิง', 'นางสาว', 'น.ส.', 'นาง'].some(k => title.includes(k))) genderScore = 1;

                return {
                    student_code: String(row[map.student_code] || "").trim(),
                    student_title: title,
                    first_name: String(row[map.first_name] || "").trim(),
                    last_name: String(row[map.last_name] || "").trim(),
                    student_name: `${String(row[map.first_name] || "").trim()} ${String(row[map.last_name] || "").trim()}`.trim(),
                    birth_date: bdate || null,
                    gender_score: genderScore
                };
            }).filter(r => r.student_code !== "" && r.first_name !== "");

            // 2. ทำการเรียงลำดับตามที่ครูเลือก
            if (sortType === 'gender_id') {
                // แยกเพศ (ชายก่อนหญิง) แล้วตามด้วยเลขประจำตัว
                rawList.sort((a, b) => {
                    if (a.gender_score !== b.gender_score) return a.gender_score - b.gender_score;
                    return a.student_code.localeCompare(b.student_code, undefined, {numeric: true});
                });
            } else {
                // เรียงตามเลขประจำตัวอย่างเดียว
                rawList.sort((a, b) => a.student_code.localeCompare(b.student_code, undefined, {numeric: true}));
            }

            // 3. กำหนดเลขที่ (student_number) หลังจากเรียงแล้ว
            finalImportList = rawList.map((item, idx) => ({
                ...item,
                student_number: idx + 1
            }));

            if (finalImportList.length === 0) return alert("ไม่พบข้อมูลที่สามารถนำเข้าได้ในช่วงแถวที่ระบุ");
            
            const sortText = sortType === 'gender_id' ? "แยกชาย-หญิง และเรียงตามรหัส" : "เรียงตามรหัสประจำตัว";
            document.getElementById('summaryText').innerHTML = `
                <div style="font-size: 16px;">ตรวจพบรายชื่อทั้งหมด <strong>${finalImportList.length}</strong> รายการ</div>
                <div style="font-size: 13px; opacity: 0.8; margin-top: 5px;">รูปแบบการจัดเลขที่: ${sortText}</div>
            `;
            goToStep(3);
        }

        // ... (ฟังก์ชัน executeImport คงเดิม) ...
    </script>
</body>
</html>
