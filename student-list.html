<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>รายชื่อนักเรียน - FlipSchool</title>
    
    <link rel="stylesheet" href="css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* --- General Styles --- */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-tool {
            padding: 8px 15px; border-radius: 20px; border: none; font-size: 14px;
            cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600;
        }
        .btn-import { background: #e0f2f1; color: #00695c; }
        .btn-print { background: #e3f2fd; color: #1565c0; }
        
        .student-list { list-style: none; padding: 0; margin: 0; background: white; border-radius: 16px; box-shadow: var(--card-shadow); }
        .student-item { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f0f0f0; }
        .st-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .st-info { flex: 1; }
        .st-code { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #555; margin-left: 5px; }

        /* --- Import Wizard Styles --- */
        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .map-row { display: grid; grid-template-columns: 35% 40% 25%; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .map-label { font-weight: 600; color: #555; }
        .map-select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 95%; }
        .map-preview { font-size: 12px; color: #007bff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-left: 5px;}

        .conflict-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 15px; color: #856404; }
        .conflict-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-action { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-weight: 600; }
        .btn-overwrite { background: #fff; border-color: #d32f2f; color: #d32f2f; }
        .btn-skip { background: #fff; border-color: #555; color: #555; }
        .btn-overwrite.selected { background: #d32f2f; color: white; }
        .btn-skip.selected { background: #555; color: white; }

        /* --- Print/PDF Hidden Area --- */
        #printArea { position: absolute; top: -9999px; left: -9999px; width: 210mm; }
        .id-card {
            width: 8.5cm; height: 5.4cm; border: 1px solid #ddd; border-radius: 8px; 
            padding: 10px; box-sizing: border-box; display: inline-block; margin: 5px;
            background: white; position: relative; overflow: hidden; page-break-inside: avoid;
        }
        .card-header-bg { position: absolute; top:0; left:0; width: 100%; height: 25px; background: var(--primary-color); }
        .card-content { display: flex; margin-top: 15px; align-items: center; }
        .card-qr { width: 80px; height: 80px; }
        .card-details { margin-left: 15px; font-family: 'Sarabun'; font-size: 12px; }
        .card-name { font-weight: bold; font-size: 14px; color: #333; }
        .card-code { color: #666; margin-top: 2px; }
    </style>
</head>
<body class="dashboard-page">

    <div id="loadingOverlay"><div class="spinner-lg"></div></div>

    <nav>
        <a href="teacher-dashboard.html" class="nav-brand">
            <img src="img/favicon.png" alt="Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjNDM2MWVlIiBkPSJNMCAyNTZDMCAxMTQuNiAxMTQuNiAwIDI1NiAwczI1NiAxMTQuNiAyNTYgMjU2LTExNC42IDI1Ni0yNTYgMjU2UzAgMzk3LjQgMCAyNTZ6Ii8+PC9zdmc+'">
            <div>Flip<span>School</span></div>
        </a>
        <a href="#" id="backBtn" class="back-link"><i class="fas fa-chevron-left"></i> ย้อนกลับ</a>
    </nav>

    <div class="container">
        <div class="toolbar">
            <button class="btn-tool btn-import" onclick="openImportModal()">
                <i class="fas fa-file-excel"></i> นำเข้า Excel
            </button>
            <button class="btn-tool btn-print" onclick="printIDCards()">
                <i class="fas fa-id-card"></i> พิมพ์บัตร QR
            </button>
            <a href="template_student.xlsx" class="btn-tool" style="background:#f5f5f5; color:#666; text-decoration:none;" download>
                <i class="fas fa-download"></i> โหลดฟอร์ม
            </a>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin:0;"><i class="fas fa-users"></i> รายชื่อนักเรียน (<span id="totalCount">0</span>)</h3>
        </div>

        <ul class="student-list" id="studentList"></ul>
    </div>

    <button class="fab-add" onclick="openAddModal()"><i class="fas fa-user-plus"></i></button>

    <div id="addModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">
                <span><i class="fas fa-user-plus"></i> เพิ่มนักเรียนใหม่</span>
                <i class="fas fa-times" onclick="closeAddModal()" style="cursor:pointer;"></i>
            </div>
            <label class="modal-label">เลขที่</label>
            <input type="number" id="newNumber" class="modal-input" placeholder="เช่น 1">
            <label class="modal-label">รหัสนักเรียน (ถ้ามี)</label>
            <input type="text" id="newCode" class="modal-input" placeholder="เช่น 15401">
            <label class="modal-label">ชื่อ-นามสกุล</label>
            <input type="text" id="newName" class="modal-input" placeholder="เช่น ด.ช.รักดี มีวินัย">
            <label class="modal-label">เพศ</label>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="gender-opt selected" onclick="selectGender('ชาย')" id="optMale" style="flex:1; padding:10px; border:2px solid #eee; border-radius:10px; text-align:center; cursor:pointer;">
                    <i class="fas fa-mars"></i> ชาย
                </div>
                <div class="gender-opt" onclick="selectGender('หญิง')" id="optFemale" style="flex:1; padding:10px; border:2px solid #eee; border-radius:10px; text-align:center; cursor:pointer;">
                    <i class="fas fa-venus"></i> หญิง
                </div>
            </div>
            <button class="btn-save" onclick="addStudent()">บันทึกข้อมูล</button>
        </div>
    </div>

    <div id="importModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-title">
                <span><i class="fas fa-robot"></i> ระบบนำเข้าอัจฉริยะ</span>
                <i class="fas fa-times" onclick="closeImportModal()" style="cursor:pointer;"></i>
            </div>

            <div id="step1" class="step-container active">
                <p style="text-align:center; color:#666; margin-bottom:20px;">
                    รองรับไฟล์ .xlsx, .xls (Excel)<br>
                    <small>ระบบจะพยายามจับคู่หัวตารางให้อัตโนมัติ</small>
                </p>
                <div style="background:#f8f9fa; border: 2px dashed #ddd; padding:30px; text-align:center; border-radius:10px; cursor:pointer;" onclick="document.getElementById('excelFile').click()">
                    <i class="fas fa-file-excel" style="font-size:40px; color:#2ecc71; margin-bottom:10px;"></i><br>
                    <span id="fileNameDisplay">คลิกเพื่อเลือกไฟล์</span>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none" onchange="processFile()">
                </div>
            </div>

            <div id="step2" class="step-container">
                <p>ตรวจสอบการจับคู่คอลัมน์</p>
                <div style="display:grid; grid-template-columns: 35% 40% 25%; font-weight:bold; margin-bottom:10px; font-size:12px; color:#888;">
                    <div>ฟิลด์ระบบ</div>
                    <div>หัวตารางจากไฟล์</div>
                    <div>ตัวอย่างข้อมูล</div>
                </div>
                <div id="mappingArea" style="max-height: 300px; overflow-y:auto; margin-bottom:15px;"></div>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn-cancel" onclick="goToStep(1)">เลือกไฟล์ใหม่</button>
                    <button class="btn-confirm" onclick="analyzeData()">วิเคราะห์ข้อมูล <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div id="step3" class="step-container">
                <p>สรุปรายการนำเข้า</p>
                <div id="analysisResult" style="margin-bottom:15px; font-size:14px; font-weight:bold;"></div>
                
                <div id="conflictSection" class="conflict-box" style="display:none;">
                    <strong><i class="fas fa-exclamation-triangle"></i> พบข้อมูลซ้ำ <span id="dupCount">0</span> รายการ</strong><br>
                    <small>มีรหัสประจำตัวนี้ในห้องแล้ว ต้องการทำอย่างไร?</small>
                    <div class="conflict-actions">
                        <button class="btn-action btn-overwrite" id="actOverwrite" onclick="setConflictAction('overwrite')">
                            <i class="fas fa-sync"></i> อัปเดตทับข้อมูลเดิม
                        </button>
                        <button class="btn-action btn-skip selected" id="actSkip" onclick="setConflictAction('skip')">
                            <i class="fas fa-forward"></i> ข้ามรายการที่ซ้ำ
                        </button>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn-cancel" onclick="goToStep(2)">ย้อนกลับ</button>
                    <button class="btn-confirm" onclick="saveImportData()">ยืนยันนำเข้า</button>
                </div>
            </div>
        </div>
    </div>

    <div id="printArea"></div>

    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <script>
        let currentClassId = null;
        let excelRows = []; 
        let excelHeaders = []; 
        let finalData = [];
        let conflictAction = 'skip';
        let selectedGender = 'ชาย';

        // --- Fields Definition for Mapping ---
        const MAPPING_CONFIG = [
            { 
                key: 'student_code', 
                label: 'รหัสประจำตัว', 
                required: false,
                keywords: ['รหัส', 'id', 'code', 'student_id', 'no'], // คำที่น่าจะเจอใน Header
                checkContent: (val) => /^\d+$/.test(val) && val.length >= 4 // เช็คว่าเป็นตัวเลขและยาวพอสมควร
            },
            { 
                key: 'student_name', 
                label: 'ชื่อ-นามสกุล', 
                required: true,
                keywords: ['ชื่อ', 'name', 'first', 'full', 'สกุล', 'last'],
                checkContent: (val) => isNaN(val) && val.length > 5 // ไม่ใช่ตัวเลข และยาวเกิน 5 ตัว
            },
            { 
                key: 'gender', 
                label: 'เพศ', 
                required: false,
                keywords: ['เพศ', 'gender', 'sex'],
                checkContent: (val) => ['ชาย','หญิง','male','female','m','f'].includes(val.toLowerCase())
            },
            { 
                key: 'birth_date', 
                label: 'วันเกิด', 
                required: false,
                keywords: ['เกิด', 'birth', 'dob', 'date'],
                checkContent: (val) => !isNaN(Date.parse(val)) || val instanceof Date // เป็นรูปแบบวันที่
            }
        ];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!sysDB) return;
            const params = new URLSearchParams(window.location.search);
            currentClassId = params.get('cid');
            
            if (!currentClassId) { alert('ไม่พบรหัสห้องเรียน'); return; }
            document.getElementById('backBtn').href = `classroom-detail.html?id=${currentClassId}`;

            await checkAuthRedirect();
            await fetchStudents();
            document.getElementById('loadingOverlay').style.display = 'none';
        });

        // --- Fetch & Display ---
        async function fetchStudents() {
            const list = document.getElementById('studentList');
            const { data, error } = await sysDB.from('students').select('*').eq('classroom_id', currentClassId).order('student_number', { ascending: true });
            if (error) { console.error(error); return; }
            
            document.getElementById('totalCount').innerText = data.length;
            list.innerHTML = '';
            
            if (data.length === 0) { list.innerHTML = `<div class="empty-state">ยังไม่มีนักเรียน</div>`; return; }

            data.forEach(st => {
                const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${st.student_name}&gender=${st.gender==='หญิง'?'female':'male'}`;
                list.innerHTML += `
                    <li class="student-item">
                        <div style="text-align:center; margin-right:15px; width:30px; font-weight:bold; color:#888;">${st.student_number}</div>
                        <img src="${avatarUrl}" class="st-avatar">
                        <div class="st-info">
                            <h4 style="margin:0;">${st.student_name} <span class="st-code">${st.student_code || '-'}</span></h4>
                            <span style="font-size:12px; color:#888;">${st.gender} | ${st.birth_date ? formatDate(st.birth_date) : '-'}</span>
                        </div>
                        <i class="fas fa-trash-alt" style="color:#ddd; cursor:pointer;" onclick="deleteStudent('${st.student_id}')"></i>
                    </li>`;
            });
        }

        // --- Manual Add Logic ---
        function openAddModal() {
            const currentCount = parseInt(document.getElementById('totalCount').innerText) || 0;
            document.getElementById('newNumber').value = currentCount + 1;
            document.getElementById('addModal').style.display = 'flex';
        }
        function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }
        
        function selectGender(g) {
            selectedGender = g;
            document.querySelectorAll('.gender-opt').forEach(el => el.classList.remove('selected'));
            if(g === 'ชาย') document.getElementById('optMale').classList.add('selected');
            else document.getElementById('optFemale').classList.add('selected');
        }

        async function addStudent() {
            // (คงโค้ดเดิมส่วน addStudent ไว้)
            const num = document.getElementById('newNumber').value;
            const code = document.getElementById('newCode').value;
            const name = document.getElementById('newName').value;
            if (!num || !name) { alert('กรุณากรอกข้อมูลให้ครบ'); return; }
            
            try {
                await sysDB.from('students').insert([{
                    classroom_id: currentClassId, student_number: num, student_code: code, student_name: name, gender: selectedGender
                }]);
                closeAddModal(); fetchStudents();
            } catch (err) { alert('Error: ' + err.message); }
        }
        
        async function deleteStudent(id) {
            if(confirm('ยืนยันการลบ?')) {
                await sysDB.from('students').delete().eq('student_id', id);
                fetchStudents();
            }
        }

        // ==========================================
        //  SMART IMPORT LOGIC
        // ==========================================
        
        function openImportModal() { 
            document.getElementById('importModal').style.display = 'flex'; 
            document.getElementById('excelFile').value = ''; // Reset file input
            document.getElementById('fileNameDisplay').innerText = 'คลิกเพื่อเลือกไฟล์';
            goToStep(1); 
        }
        function closeImportModal() { document.getElementById('importModal').style.display = 'none'; }
        
        function goToStep(step) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
        }

        async function processFile() {
            const fileInput = document.getElementById('excelFile');
            if(!fileInput.files[0]) return;
            
            document.getElementById('fileNameDisplay').innerText = fileInput.files[0].name;

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // cellDates: true ช่วยแปลงวันที่ให้อัตโนมัติ
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true}); 
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // แปลงเป็น Array (header: 1 ทำให้ได้ Array of Arrays)
                    const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});

                    if(!rows || rows.length < 2) { alert('ไฟล์ไม่มีข้อมูล'); return; }
                    
                    excelHeaders = rows[0]; // แถวแรกเป็น Header
                    excelRows = rows.slice(1); // แถว 2 เป็นต้นไปเป็น Data
                    
                    autoMapColumns(); // *** เรียกใช้ AI Mapping ***
                    goToStep(2);
                } catch (err) {
                    console.error(err);
                    alert('อ่านไฟล์ไม่สำเร็จ: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // *** ฟังก์ชันหัวใจสำคัญ: คำนวณความน่าจะเป็นของคอลัมน์ ***
        function calculateColumnScore(headerName, sampleValue, config) {
            let score = 0;
            const h = String(headerName).toLowerCase();
            const val = String(sampleValue);

            // 1. Header Matching (คะแนน: 10)
            config.keywords.forEach(kw => {
                if (h.includes(kw)) score += 10;
                if (h === kw) score += 5; // ตรงเป๊ะบวกเพิ่ม
            });

            // 2. Content Analysis (คะแนน: 15)
            // ถ้า sampleValue ไม่ว่าง และตรงตามเงื่อนไขของ field นั้นๆ
            if (sampleValue && config.checkContent(sampleValue)) {
                score += 15;
            }

            return score;
        }

        function autoMapColumns() {
            const mapArea = document.getElementById('mappingArea');
            mapArea.innerHTML = '';

            // ดึงข้อมูลตัวอย่างแถวแรก (ถ้ามี)
            const sampleRow = excelRows.length > 0 ? excelRows[0] : [];

            MAPPING_CONFIG.forEach(field => {
                let bestMatchIndex = -1;
                let maxScore = 0;

                // วนลูปทุกคอลัมน์ใน Excel เพื่อหาคู่ที่ดีที่สุด
                excelHeaders.forEach((header, colIndex) => {
                    const val = sampleRow[colIndex];
                    const score = calculateColumnScore(header, val, field);

                    if (score > maxScore && score > 0) {
                        maxScore = score;
                        bestMatchIndex = colIndex;
                    }
                });

                // สร้าง Dropdown
                let options = `<option value="-1">-- ไม่ระบุ --</option>`;
                excelHeaders.forEach((h, index) => {
                    const selected = (index === bestMatchIndex) ? 'selected' : '';
                    options += `<option value="${index}" ${selected}>${h}</option>`;
                });

                // สร้าง UI แสดงผล
                const div = document.createElement('div');
                div.className = 'map-row';
                div.innerHTML = `
                    <div class="map-label">${field.label} ${field.required ? '<span style="color:red">*</span>' : ''}</div>
                    <select id="map_${field.key}" class="map-select" onchange="updatePreview(this, '${field.key}')">${options}</select>
                    <div id="preview_${field.key}" class="map-preview">
                        ${bestMatchIndex !== -1 ? formatPreview(sampleRow[bestMatchIndex]) : '-'}
                    </div>
                `;
                mapArea.appendChild(div);
            });
        }

        function updatePreview(select, key) {
            const idx = select.value;
            const previewEl = document.getElementById(`preview_${key}`);
            if (idx == -1 || excelRows.length === 0) {
                previewEl.innerText = '-';
            } else {
                previewEl.innerText = formatPreview(excelRows[0][idx]);
            }
        }

        function formatPreview(val) {
            if (val instanceof Date) return val.toLocaleDateString('th-TH');
            return String(val).substring(0, 20);
        }

        async function analyzeData() {
            // ดึงค่า Mapping จาก Dropdown
            const mapping = {};
            let hasName = false;

            MAPPING_CONFIG.forEach(field => {
                const val = document.getElementById(`map_${field.key}`).value;
                mapping[field.key] = parseInt(val);
                if (field.key === 'student_name' && val != -1) hasName = true;
            });

            if (!hasName) { alert('กรุณาเลือกคอลัมน์ "ชื่อ-นามสกุล"'); return; }

            // แปลงข้อมูลตาม Mapping
            finalData = excelRows.map(row => {
                const rawName = mapping.student_name !== -1 ? row[mapping.student_name] : '';
                if (!rawName) return null; // ข้ามแถวที่ไม่มีชื่อ

                return {
                    student_code: mapping.student_code !== -1 ? String(row[mapping.student_code]).trim() : '',
                    student_name: String(rawName).trim(),
                    gender: mapping.gender !== -1 ? normalizeGender(row[mapping.gender]) : 'ชาย',
                    birth_date: mapping.birth_date !== -1 ? parseDate(row[mapping.birth_date]) : null,
                    classroom_id: currentClassId
                };
            }).filter(d => d !== null);

            // เช็คข้อมูลซ้ำ (Check Duplicates)
            const codes = finalData.map(d => d.student_code).filter(c => c);
            let dupCount = 0;

            if (codes.length > 0) {
                const { data: duplicates } = await sysDB.from('students')
                    .select('student_code')
                    .eq('classroom_id', currentClassId)
                    .in('student_code', codes);
                
                dupCount = duplicates ? duplicates.length : 0;
            }

            document.getElementById('dupCount').innerText = dupCount;
            document.getElementById('conflictSection').style.display = dupCount > 0 ? 'block' : 'none';
            document.getElementById('analysisResult').innerText = `พร้อมนำเข้า ${finalData.length} รายการ`;

            goToStep(3);
        }

        // Helper: แปลงเพศให้เป็นมาตรฐาน
        function normalizeGender(val) {
            if (!val) return 'ชาย';
            const s = String(val).toLowerCase();
            if (s.includes('หญิง') || s === 'female' || s === 'f') return 'หญิง';
            return 'ชาย';
        }

        // Helper: แปลงวันที่
        function parseDate(val) {
            if (!val) return null;
            if (val instanceof Date) return val.toISOString().split('T')[0];
            // พยายามแปลง String เป็น Date
            const d = new Date(val);
            if (!isNaN(d.getTime())) return d.toISOString().split('T')[0];
            return null;
        }
        
        // Helper: Formatting
        function formatDate(dateStr) {
            if(!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }

        function setConflictAction(action) {
            conflictAction = action;
            document.querySelectorAll('.btn-action').forEach(b => b.classList.remove('selected'));
            document.getElementById(action === 'overwrite' ? 'actOverwrite' : 'actSkip').classList.add('selected');
        }

        async function saveImportData() {
            const btn = document.querySelector('#step3 .btn-confirm');
            btn.innerText = 'กำลังบันทึก...'; btn.disabled = true;

            try {
                // หาเลขที่ล่าสุด
                const { data: existing } = await sysDB.from('students').select('student_number').eq('classroom_id', currentClassId).order('student_number', {ascending:false}).limit(1);
                let startNum = existing.length > 0 ? existing[0].student_number + 1 : 1;
                
                let dataToInsert = [...finalData];
                // รันเลขที่ให้นักเรียนใหม่
                dataToInsert.forEach((d, i) => { d.student_number = startNum + i; });

                if (conflictAction === 'overwrite') {
                    // แบบยาก: ต้องวนลูปเช็คทีละคนเพื่อ Update หรือ Insert
                    for (let st of dataToInsert) {
                        if(st.student_code) {
                            const { data } = await sysDB.from('students').select('student_id').eq('classroom_id', currentClassId).eq('student_code', st.student_code).maybeSingle();
                            if(data) {
                                // Update
                                await sysDB.from('students').update({ 
                                    student_name: st.student_name, gender: st.gender, birth_date: st.birth_date 
                                }).eq('student_id', data.student_id);
                            } else {
                                await sysDB.from('students').insert([st]); // Insert
                            }
                        } else {
                            await sysDB.from('students').insert([st]); // ไม่มีรหัส ใส่เลย
                        }
                    }
                } else {
                    // แบบง่าย: Insert เฉพาะคนที่ไม่ซ้ำ (หรือ Insert ทั้งหมดแล้วให้ DB error ถ้าตั้ง Unique ไว้ แต่นี่เราเช็คก่อน)
                    for (let st of dataToInsert) {
                         const { data } = await sysDB.from('students').select('student_id').eq('classroom_id', currentClassId).eq('student_code', st.student_code).maybeSingle();
                         if(!data) {
                             await sysDB.from('students').insert([st]);
                         }
                    }
                }

                alert('✅ นำเข้าข้อมูลสำเร็จ');
                closeImportModal();
                fetchStudents();

            } catch (err) {
                alert('เกิดข้อผิดพลาด: ' + err.message);
            } finally {
                btn.innerText = 'ยืนยันนำเข้า'; btn.disabled = false;
            }
        }

        // --- Print PDF Logic (เหมือนเดิม) ---
        async function printIDCards() {
            const { data: students } = await sysDB.from('students').select('*').eq('classroom_id', currentClassId);
            if (!students || students.length === 0) { alert('ไม่มีข้อมูลนักเรียน'); return; }

            const printArea = document.getElementById('printArea');
            printArea.innerHTML = '';
            
            students.forEach(st => {
                const qrContent = `FS|${st.student_id}`; 
                let dobText = st.birth_date ? formatDate(st.birth_date) : '-';
                
                const cardHtml = `
                    <div class="id-card" id="card_${st.student_id}">
                        <div class="card-header-bg"></div>
                        <div style="text-align:right; font-size:10px; color:white; position:relative; z-index:2; padding-right:5px; padding-top:5px;">FlipSchool ID</div>
                        <div class="card-content">
                            <div id="qr_${st.student_id}" class="card-qr"></div>
                            <div class="card-details">
                                <div class="card-name">${st.student_name}</div>
                                <div class="card-code" style="font-size:16px; font-weight:bold; color:#4361ee;">${st.student_code || '-'}</div>
                                <div class="card-code" style="font-size:10px;">DOB: ${dobText}</div>
                            </div>
                        </div>
                    </div>`;
                printArea.insertAdjacentHTML('beforeend', cardHtml);
                new QRCode(document.getElementById(`qr_${st.student_id}`), { text: qrContent, width: 70, height: 70, correctLevel: QRCode.CorrectLevel.L });
            });

            setTimeout(async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const cards = document.querySelectorAll('.id-card');
                let x = 10, y = 10;
                
                for (let i = 0; i < cards.length; i++) {
                    const canvas = await html2canvas(cards[i], { scale: 2 });
                    doc.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, 85, 54);
                    x += 95;
                    if (x > 110) { x = 10; y += 60; }
                    if (y > 250) { doc.addPage(); y = 10; }
                }
                doc.save('Student_ID_Cards.pdf');
            }, 1000);
        }
    </script>
</body>
</html>
