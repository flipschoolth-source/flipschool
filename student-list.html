<!DOCTYPE html>
<html lang="th">
<head>
    <style>
        /* เพิ่มสไตล์สำหรับตารางพรีวิวและส่วนการจับคู่ให้ชัดเจน */
        .data-preview-box { overflow-x: auto; margin: 15px 0; border: 1px solid #ddd; border-radius: 12px; }
        .data-preview-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .data-preview-table th, .data-preview-table td { padding: 8px 12px; border: 1px solid #eee; text-align: left; }
        .is-header { background: #e3f2fd; font-weight: bold; border-bottom: 2px solid #2196f3; }
        .map-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 10px; }
        .modal-input { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <div id="importModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 850px; border-radius: 30px;">
            <div class="modal-title">
                <span><i class="fas fa-file-excel"></i> นำเข้ารายชื่อนักเรียน (Master Data)</span>
                <i class="fas fa-times" onclick="closeImportModal()" style="cursor:pointer;"></i>
            </div>

            <div id="step1" class="step-container active">
                <div style="padding:60px 20px; border:2px dashed #ccc; border-radius:20px; text-align:center; cursor:pointer;" onclick="document.getElementById('excelFile').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size:50px; color:var(--primary); margin-bottom:15px;"></i>
                    <p style="font-family:'Kanit';">คลิกเพื่อเลือกไฟล์ Excel หรือ CSV</p>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="display:none" onchange="processFile()">
                </div>
            </div>

            <div id="step2" class="step-container">
                <p style="font-weight:600; font-size:14px;"><i class="fas fa-search"></i> ตรวจสอบข้อมูลและจับคู่หัวตาราง:</p>
                <div class="data-preview-box"><table class="data-preview-table" id="previewTable"></table></div>
                <div id="mappingArea" style="margin-top:20px;"></div>
                <button class="btn-save" style="background:var(--primary); margin-top:20px; width:100%;" onclick="prepareImport()">ขั้นตอนถัดไป <i class="fas fa-arrow-right"></i></button>
            </div>

            <div id="step3" class="step-container">
                <div id="summaryText" style="font-weight:bold; margin-bottom:15px; color:var(--primary);"></div>
                <div id="progressSection" style="display:none; background:#f0f4ff; padding:20px; border-radius:15px; margin-top:15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span id="progressText" style="font-size:14px; font-weight:600;">กำลังบันทึกข้อมูล...</span>
                        <span id="progressPercent" style="font-weight:700; color:var(--primary);">0%</span>
                    </div>
                    <div style="background:#ddd; height:12px; border-radius:10px; overflow:hidden;">
                        <div id="progressBar" style="background:var(--primary); width:0%; height:100%; transition:0.3s;"></div>
                    </div>
                </div>
                <div id="confirmBtnContainer">
                    <button class="btn-save" id="confirmBtn" style="background:var(--primary); width:100%;" onclick="executeImport()">ยืนยันการนำเข้าข้อมูล</button>
                    <button class="btn-cancel" style="width:100%; margin-top:10px; border:none; background:none; color:#666;" onclick="goToStep(1)">เลือกไฟล์ใหม่</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ... (ส่วนตั้งค่าตัวแปรและ Fetch ข้อมูลเดิม) ...

        // ฟังก์ชันแก้ไขให้ทำงานได้จริง
        function openImportModal() { 
            const drawer = document.getElementById('sideDrawer');
            const overlay = document.getElementById('drawerOverlay');
            if(drawer) drawer.classList.remove('active');
            if(overlay) overlay.classList.remove('active');
            
            document.getElementById('importModal').style.display = 'flex'; 
            goToStep(1); 
        }

        function closeImportModal() { document.getElementById('importModal').style.display = 'none'; }
        
        function goToStep(s) { 
            document.querySelectorAll('.step-container').forEach((el, i) => {
                el.classList.toggle('active', i + 1 === s);
            }); 
        }

        // อ่านไฟล์ Excel
        function processFile() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                allSheetRows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
                
                if (allSheetRows.length > 0) {
                    headers = allSheetRows[0];
                    renderPreview();
                    renderMapping();
                    goToStep(2);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderPreview() {
            const table = document.getElementById('previewTable');
            table.innerHTML = '';
            // โชว์ 5 แถวแรก
            allSheetRows.slice(0, 5).forEach((row, i) => {
                const tr = document.createElement('tr');
                if (i === 0) tr.className = 'is-header';
                row.forEach(cell => {
                    const td = document.createElement(i === 0 ? 'th' : 'td');
                    td.innerText = cell;
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
        }

        function renderMapping() {
            const area = document.getElementById('mappingArea');
            area.innerHTML = '';
            MAPPING_CONFIG.forEach(field => {
                let options = headers.map((h, i) => `<option value="${i}">${h || `Column ${i+1}`}</option>`).join('');
                area.innerHTML += `
                    <div class="map-row">
                        <label style="font-size:13px; font-weight:600;">${field.label}</label>
                        <select id="map_${field.key}" class="modal-input">${options}</select>
                    </div>`;
            });
        }

        function prepareImport() {
            const map = {};
            MAPPING_CONFIG.forEach(f => map[f.key] = document.getElementById(`map_${f.key}`).value);
            
            // เตรียม List ข้อมูล
            finalImportList = allSheetRows.slice(1).map((row, idx) => ({
                student_code: String(row[map.student_code]).trim(),
                student_name: String(row[map.student_name]).trim(),
                student_number: row[map.student_number] || (idx + 1)
            })).filter(r => r.student_code !== "" && r.student_name !== "");

            document.getElementById('summaryText').innerText = `ตรวจพบรายชื่อทั้งหมด ${finalImportList.length} รายการ พร้อมนำเข้าห้องเรียนนี้`;
            goToStep(3);
        }

        // นำเข้าข้อมูลจริงลง Supabase
        async function executeImport() {
            if (!currentSchoolId) return alert("ไม่พบข้อมูลโรงเรียน กรุณาลองใหม่");
            
            const confirmBtn = document.getElementById('confirmBtn');
            const progressSection = document.getElementById('progressSection');
            confirmBtn.disabled = true;
            progressSection.style.display = 'block';

            for (let i = 0; i < finalImportList.length; i++) {
                const item = finalImportList[i];
                
                // 1. บันทึกลงตารางกลางโรงเรียน (school_students)
                const { data: std, error: err1 } = await sysDB.from('school_students')
                    .upsert({ 
                        school_id: currentSchoolId, 
                        student_code: item.student_code, 
                        student_name: item.student_name 
                    }, { onConflict: 'school_id, student_code' })
                    .select().single();

                if (std) {
                    // 2. บันทึกการเข้าห้องเรียน (classroom_students)
                    await sysDB.from('classroom_students').upsert({ 
                        classroom_id: currentClassId, 
                        student_id: std.student_id, 
                        student_number: item.student_number 
                    }, { onConflict: 'classroom_id, student_id' });
                }

                // อัปเดต Progress Bar
                const percent = Math.round(((i + 1) / finalImportList.length) * 100);
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressPercent').innerText = percent + '%';
            }

            alert('นำเข้าข้อมูลนักเรียนเรียบร้อยแล้ว');
            location.reload();
        }
    </script>
</body>
</html>
