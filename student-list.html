<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>รายชื่อนักเรียน - FlipSchool</title>
    
    <link rel="stylesheet" href="css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* --- General Styles --- */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-tool {
            padding: 8px 15px; border-radius: 20px; border: none; font-size: 14px;
            cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600;
        }
        .btn-import { background: #e0f2f1; color: #00695c; }
        .btn-print { background: #e3f2fd; color: #1565c0; }
        
        .student-list { list-style: none; padding: 0; margin: 0; background: white; border-radius: 16px; box-shadow: var(--card-shadow); }
        .student-item { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f0f0f0; }
        .st-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .st-info { flex: 1; }
        .st-code { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #555; margin-left: 5px; }

        /* --- Import Wizard Styles --- */
        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .map-row { display: grid; grid-template-columns: 35% 40% 25%; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .map-label { font-weight: 600; color: #555; }
        .map-select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 95%; }
        .map-preview { font-size: 12px; color: #007bff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-left: 5px;}

        /* Data Preview Table */
        .data-preview-box { overflow-x: auto; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .data-preview-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .data-preview-table th, .data-preview-table td { padding: 6px 10px; border: 1px solid #eee; text-align: left; }
        .data-preview-table .row-num { background: #f8f9fa; color: #888; text-align: center; width: 40px; position: sticky; left: 0; }
        .data-preview-table .is-header { background: #e3f2fd; font-weight: bold; border-bottom: 2px solid #2196f3; }
        .data-preview-table .is-data-start { background: #e8f5e9; border-left: 3px solid #4caf50; }

        .config-panel {
            background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e9ecef;
            display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;
        }
        .config-item label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        .config-item input { padding: 8px; border: 1px solid #ccc; border-radius: 6px; width: 80px; text-align: center; }

        .conflict-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 15px; color: #856404; }
        .conflict-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-action { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-weight: 600; }
        .btn-overwrite { background: #fff; border-color: #d32f2f; color: #d32f2f; }
        .btn-skip { background: #fff; border-color: #555; color: #555; }
        .btn-overwrite.selected { background: #d32f2f; color: white; }
        .btn-skip.selected { background: #555; color: white; }

        /* --- Print/PDF Hidden Area --- */
        #printArea { position: absolute; top: -9999px; left: -9999px; width: 210mm; }
        .id-card {
            width: 8.5cm; height: 5.4cm; border: 1px solid #ddd; border-radius: 8px; 
            padding: 10px; box-sizing: border-box; display: inline-block; margin: 5px;
            background: white; position: relative; overflow: hidden; page-break-inside: avoid;
        }
        .card-header-bg { position: absolute; top:0; left:0; width: 100%; height: 25px; background: var(--primary-color); }
        .card-content { display: flex; margin-top: 15px; align-items: center; }
        .card-qr { width: 80px; height: 80px; }
        .card-details { margin-left: 15px; font-family: 'Sarabun'; font-size: 12px; }
        .card-name { font-weight: bold; font-size: 14px; color: #333; }
        .card-code { color: #666; margin-top: 2px; }
    </style>
</head>
<body class="dashboard-page">

    <div id="loadingOverlay"><div class="spinner-lg"></div></div>

    <nav>
        <a href="teacher-dashboard.html" class="nav-brand">
            <img src="img/favicon.png" alt="Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjNDM2MWVlIiBkPSJNMCAyNTZDMCAxMTQuNiAxMTQuNiAwIDI1NiAwczI1NiAxMTQuNiAyNTYgMjU2LTExNC42IDI1Ni0yNTYgMjU2UzAgMzk3LjQgMCAyNTZ6Ii8+PC9zdmc+'">
            <div>Flip<span>School</span></div>
        </a>
        <a href="#" id="backBtn" class="back-link"><i class="fas fa-chevron-left"></i> ย้อนกลับ</a>
    </nav>

    <div class="container">
        <div class="toolbar">
            <button class="btn-tool btn-import" onclick="openImportModal()">
                <i class="fas fa-file-excel"></i> นำเข้า Excel
            </button>
            <button class="btn-tool btn-print" onclick="printIDCards()">
                <i class="fas fa-id-card"></i> พิมพ์บัตร QR
            </button>
            <a href="template_student.xlsx" class="btn-tool" style="background:#f5f5f5; color:#666; text-decoration:none;" download>
                <i class="fas fa-download"></i> โหลดฟอร์ม
            </a>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin:0;"><i class="fas fa-users"></i> รายชื่อนักเรียน (<span id="totalCount">0</span>)</h3>
        </div>

        <ul class="student-list" id="studentList"></ul>
    </div>

    <button class="fab-add" onclick="openAddModal()"><i class="fas fa-user-plus"></i></button>

    <div id="addModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">
                <span><i class="fas fa-user-plus"></i> เพิ่มนักเรียนใหม่</span>
                <i class="fas fa-times" onclick="closeAddModal()" style="cursor:pointer;"></i>
            </div>
            <label class="modal-label">เลขที่</label>
            <input type="number" id="newNumber" class="modal-input" placeholder="เช่น 1">
            <label class="modal-label">รหัสนักเรียน</label>
            <input type="text" id="newCode" class="modal-input" placeholder="เช่น 15401">
            <label class="modal-label">ชื่อ-นามสกุล</label>
            <input type="text" id="newName" class="modal-input" placeholder="เช่น ด.ช.รักดี มีวินัย">
            <label class="modal-label">เพศ</label>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="gender-opt selected" onclick="selectGender('ชาย')" id="optMale" style="flex:1; padding:10px; border:2px solid #eee; border-radius:10px; text-align:center; cursor:pointer;">
                    <i class="fas fa-mars"></i> ชาย
                </div>
                <div class="gender-opt" onclick="selectGender('หญิง')" id="optFemale" style="flex:1; padding:10px; border:2px solid #eee; border-radius:10px; text-align:center; cursor:pointer;">
                    <i class="fas fa-venus"></i> หญิง
                </div>
            </div>
            <button class="btn-save" onclick="addStudent()">บันทึกข้อมูล</button>
        </div>
    </div>

    <div id="importModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 800px;"> <div class="modal-title">
                <span><i class="fas fa-robot"></i> ระบบนำเข้าอัจฉริยะ</span>
                <i class="fas fa-times" onclick="closeImportModal()" style="cursor:pointer;"></i>
            </div>

            <div id="step1" class="step-container active">
                <p style="text-align:center; color:#666; margin-bottom:20px;">
                    รองรับไฟล์ .xlsx, .xls, .csv <br>
                    <small>ระบบจะช่วยวิเคราะห์และจับคู่หัวตารางให้</small>
                </p>
                <div style="background:#f8f9fa; border: 2px dashed #ddd; padding:30px; text-align:center; border-radius:10px; cursor:pointer;" onclick="document.getElementById('excelFile').click()">
                    <i class="fas fa-file-excel" style="font-size:40px; color:#2ecc71; margin-bottom:10px;"></i><br>
                    <span id="fileNameDisplay">คลิกเพื่อเลือกไฟล์</span>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="display:none" onchange="processFile()">
                </div>
            </div>

            <div id="step2" class="step-container">
                
                <div class="config-panel">
                    <div class="config-item">
                        <label><i class="fas fa-heading"></i> แถวหัวตาราง (Header)</label>
                        <input type="number" id="headerRowIndex" value="1" min="0" onchange="updateTableConfig()">
                    </div>
                    <div class="config-item">
                        <label><i class="fas fa-database"></i> เริ่มข้อมูลแถวที่ (Data)</label>
                        <input type="number" id="startRowIndex" value="2" min="1" onchange="updateTableConfig()">
                    </div>
                    <div style="flex:1; text-align:right; font-size:12px; color:#666;">
                        *ใส่ 0 หากไม่มีหัวตาราง (ระบบจะตั้งเป็น Column A, B...)
                    </div>
                </div>

                <p style="font-weight:bold; margin-bottom:5px;">ตัวอย่างข้อมูลจากไฟล์:</p>
                <div class="data-preview-box">
                    <table class="data-preview-table" id="previewTable"></table>
                </div>

                <p style="font-weight:bold; margin-bottom:5px;">จับคู่คอลัมน์:</p>
                <div style="display:grid; grid-template-columns: 35% 40% 25%; font-weight:bold; margin-bottom:10px; font-size:12px; color:#888;">
                    <div>ฟิลด์ระบบ</div>
                    <div>คอลัมน์จากไฟล์</div>
                    <div>ข้อมูลตัวอย่าง</div>
                </div>
                <div id="mappingArea" style="max-height: 250px; overflow-y:auto; margin-bottom:15px; border-top:1px solid #eee;"></div>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn-cancel" onclick="goToStep(1)">เลือกไฟล์ใหม่</button>
                    <button class="btn-confirm" onclick="analyzeData()">ตรวจสอบข้อมูล <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div id="step3" class="step-container">
                <p>สรุปรายการนำเข้า</p>
                <div id="analysisResult" style="margin-bottom:15px; font-size:14px; font-weight:bold;"></div>
                
                <div id="conflictSection" class="conflict-box" style="display:none;">
                    <strong><i class="fas fa-exclamation-triangle"></i> พบข้อมูลซ้ำ <span id="dupCount">0</span> รายการ</strong><br>
                    <small>มีรหัสประจำตัวนี้ในห้องแล้ว ต้องการทำอย่างไร?</small>
                    <div class="conflict-actions">
                        <button class="btn-action btn-overwrite" id="actOverwrite" onclick="setConflictAction('overwrite')">
                            <i class="fas fa-sync"></i> อัปเดตทับข้อมูลเดิม
                        </button>
                        <button class="btn-action btn-skip selected" id="actSkip" onclick="setConflictAction('skip')">
                            <i class="fas fa-forward"></i> ข้ามรายการที่ซ้ำ
                        </button>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn-cancel" onclick="goToStep(2)">ย้อนกลับ</button>
                    <button class="btn-confirm" onclick="saveImportData()">ยืนยันนำเข้า</button>
                </div>
            </div>
        </div>
    </div>

    <div id="printArea"></div>

    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <script>
        let currentClassId = null;
        let allSheetRows = []; // เก็บข้อมูลดิบทั้งหมดจากไฟล์
        let dataRows = [];     // ข้อมูลที่จะนำเข้า (ตัดหัวแล้ว)
        let headers = [];      // รายชื่อหัวตาราง
        let finalData = [];
        let conflictAction = 'skip';
        let selectedGender = 'ชาย';

        // --- Configuration for Auto Mapping ---
        const MAPPING_CONFIG = [
            { 
                key: 'student_code', 
                label: 'รหัสประจำตัว', 
                required: false,
                keywords: ['รหัส', 'id', 'code', 'student_id', 'no', 'ประจำตัว'], 
                checkContent: (val) => /^\d+$/.test(val) && val.length >= 4 
            },
            { 
                key: 'firstname', 
                label: 'ชื่อ (First Name)', 
                required: true,
                keywords: ['ชื่อ', 'name', 'first', 'full'],
                checkContent: (val) => isNaN(val) && val.length > 2
            },
            { 
                key: 'lastname', 
                label: 'นามสกุล (Optional)', 
                required: false,
                keywords: ['สกุล', 'last', 'sur', 'sname'],
                checkContent: (val) => isNaN(val) && val.length > 2
            },
            { 
                key: 'gender', 
                label: 'เพศ', 
                required: false,
                keywords: ['เพศ', 'gender', 'sex'],
                checkContent: (val) => ['ชาย','หญิง','male','female','m','f','ด.ช.','ด.ญ.'].some(k => String(val).includes(k))
            },
            { 
                key: 'birth_date', 
                label: 'วันเกิด', 
                required: false,
                keywords: ['เกิด', 'birth', 'dob', 'date'],
                checkContent: (val) => !isNaN(Date.parse(val)) || val instanceof Date || String(val).match(/\d{1,2}[\/-]\d{1,2}[\/-]\d{4}/)
            }
        ];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!sysDB) return;
            const params = new URLSearchParams(window.location.search);
            currentClassId = params.get('cid');
            
            if (!currentClassId) { alert('ไม่พบรหัสห้องเรียน'); return; }
            document.getElementById('backBtn').href = `classroom-detail.html?id=${currentClassId}`;

            await checkAuthRedirect();
            await fetchStudents();
            document.getElementById('loadingOverlay').style.display = 'none';
        });

        // --- Fetch & Basic Functions ---
        async function fetchStudents() {
            const list = document.getElementById('studentList');
            const { data, error } = await sysDB.from('students').select('*').eq('classroom_id', currentClassId).order('student_number', { ascending: true });
            if (error) { console.error(error); return; }
            
            document.getElementById('totalCount').innerText = data.length;
            list.innerHTML = '';
            
            if (data.length === 0) { list.innerHTML = `<div class="empty-state">ยังไม่มีนักเรียน</div>`; return; }

            data.forEach(st => {
                const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${st.student_name}&gender=${st.gender==='หญิง'?'female':'male'}`;
                list.innerHTML += `
                    <li class="student-item">
                        <div style="text-align:center; margin-right:15px; width:30px; font-weight:bold; color:#888;">${st.student_number}</div>
                        <img src="${avatarUrl}" class="st-avatar">
                        <div class="st-info">
                            <h4 style="margin:0;">${st.student_name} <span class="st-code">${st.student_code || '-'}</span></h4>
                            <span style="font-size:12px; color:#888;">${st.gender} | ${st.birth_date ? formatDate(st.birth_date) : '-'}</span>
                        </div>
                        <i class="fas fa-trash-alt" style="color:#ddd; cursor:pointer;" onclick="deleteStudent('${st.student_id}')"></i>
                    </li>`;
            });
        }

        function openAddModal() {
            const currentCount = parseInt(document.getElementById('totalCount').innerText) || 0;
            document.getElementById('newNumber').value = currentCount + 1;
            document.getElementById('addModal').style.display = 'flex';
        }
        function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }
        
        function selectGender(g) {
            selectedGender = g;
            document.querySelectorAll('.gender-opt').forEach(el => el.classList.remove('selected'));
            if(g === 'ชาย') document.getElementById('optMale').classList.add('selected');
            else document.getElementById('optFemale').classList.add('selected');
        }

        async function addStudent() {
            const num = document.getElementById('newNumber').value;
            const code = document.getElementById('newCode').value;
            const name = document.getElementById('newName').value;
            if (!num || !name) { alert('กรุณากรอกข้อมูลให้ครบ'); return; }
            
            try {
                await sysDB.from('students').insert([{
                    classroom_id: currentClassId, student_number: num, student_code: code, student_name: name, gender: selectedGender
                }]);
                closeAddModal(); fetchStudents();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function deleteStudent(id) {
            if(confirm('ยืนยันการลบ?')) {
                await sysDB.from('students').delete().eq('student_id', id);
                fetchStudents();
            }
        }

        // ==========================================
        //  ADVANCED IMPORT LOGIC
        // ==========================================
        
        function openImportModal() { 
            document.getElementById('importModal').style.display = 'flex'; 
            document.getElementById('excelFile').value = ''; 
            document.getElementById('fileNameDisplay').innerText = 'คลิกเพื่อเลือกไฟล์';
            goToStep(1); 
        }
        function closeImportModal() { document.getElementById('importModal').style.display = 'none'; }
        
        function goToStep(step) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
        }

        async function processFile() {
            const fileInput = document.getElementById('excelFile');
            if(!fileInput.files[0]) return;
            document.getElementById('fileNameDisplay').innerText = fileInput.files[0].name;

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true}); 
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // อ่านข้อมูลดิบทั้งหมด (Array of Arrays)
                    allSheetRows = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});

                    if(!allSheetRows || allSheetRows.length === 0) { alert('ไฟล์ไม่มีข้อมูล'); return; }
                    
                    // ตั้งค่า Default: Header บรรทัด 1, Data บรรทัด 2
                    document.getElementById('headerRowIndex').value = 1;
                    document.getElementById('startRowIndex').value = 2;

                    updateTableConfig();
                    goToStep(2);
                } catch (err) {
                    console.error(err);
                    alert('อ่านไฟล์ไม่สำเร็จ: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ฟังก์ชันอัปเดตการตั้งค่าเมื่อเปลี่ยนเลขแถว
        function updateTableConfig() {
            const hIndex = parseInt(document.getElementById('headerRowIndex').value) || 0;
            const dIndex = parseInt(document.getElementById('startRowIndex').value) || (hIndex + 1);

            // 1. จัดการ Header
            if (hIndex <= 0) {
                // กรณีไม่มี Header (Column A, B, C...)
                const maxCols = allSheetRows[0] ? allSheetRows[0].length : 0;
                headers = [];
                for(let i=0; i<maxCols; i++) headers.push(`Column ${XLSX.utils.encode_col(i)}`);
            } else {
                // ดึง Text จากแถวที่เลือก
                const row = allSheetRows[hIndex - 1] || [];
                headers = row.map(cell => String(cell).trim() || "(ว่าง)");
            }

            // 2. จัดการ Data Rows
            const start = Math.max(0, dIndex - 1);
            dataRows = allSheetRows.slice(start);

            // 3. Render Table & Run AI
            renderPreviewTable(hIndex - 1, start);
            autoMapColumns();
        }

        function renderPreviewTable(headerIdx, dataStartIdx) {
            const table = document.getElementById('previewTable');
            table.innerHTML = '';
            
            // แสดงแค่ 5 แถวแรกของไฟล์ + แถวที่เลือกเป็น Header/Data (ถ้าอยู่ไกล)
            const maxShow = 6;
            let rowsToShow = [];
            
            // เพิ่มแถวช่วงต้น
            for(let i=0; i<Math.min(allSheetRows.length, maxShow); i++) rowsToShow.push(i);
            
            // เพิ่มแถว Header ถ้ายังไม่มี
            if(headerIdx >= 0 && !rowsToShow.includes(headerIdx) && headerIdx < allSheetRows.length) rowsToShow.push(headerIdx);
            
            // เพิ่มแถว Data Start ถ้ายังไม่มี
            if(dataStartIdx >= 0 && !rowsToShow.includes(dataStartIdx) && dataStartIdx < allSheetRows.length) rowsToShow.push(dataStartIdx);

            rowsToShow.sort((a,b) => a-b);

            rowsToShow.forEach(idx => {
                const tr = document.createElement('tr');
                const rowData = allSheetRows[idx];

                // Check Classes
                if (idx === headerIdx) tr.classList.add('is-header');
                if (idx === dataStartIdx) tr.classList.add('is-data-start');

                // Row Number Column
                const tdNum = document.createElement('td');
                tdNum.className = 'row-num';
                tdNum.innerText = idx + 1;
                tr.appendChild(tdNum);

                // Data Columns
                rowData.forEach(cell => {
                    const td = document.createElement('td');
                    let val = cell;
                    if(val instanceof Date) val = val.toLocaleDateString('th-TH');
                    td.innerText = val ? String(val).substring(0, 30) : '';
                    tr.appendChild(td);
                });
                
                table.appendChild(tr);
            });
        }

        // --- AI Auto Mapping ---
        function calculateColumnScore(headerName, sampleData, config) {
            let score = 0;
            const h = String(headerName).toLowerCase();
            
            // 1. Header Match
            config.keywords.forEach(kw => {
                if (h.includes(kw)) score += 10;
                if (h === kw) score += 5;
            });

            // 2. Content Match (ตรวจสอบจากข้อมูลจริง 3 แถวแรก)
            let validCount = 0;
            const checkLimit = Math.min(dataRows.length, 3);
            for(let i=0; i<checkLimit; i++) {
                const val = sampleData[i];
                if(val && config.checkContent(val)) validCount++;
            }
            if (validCount > 0) score += (validCount * 5);

            return score;
        }

        function autoMapColumns() {
            const mapArea = document.getElementById('mappingArea');
            mapArea.innerHTML = '';

            // เตรียมข้อมูลแต่ละคอลัมน์เพื่อส่งไปวิเคราะห์
            const columnData = [];
            const numCols = headers.length;
            for(let c=0; c<numCols; c++) {
                columnData[c] = dataRows.map(r => r[c]); // ดึงข้อมูลทั้งคอลัมน์มา
            }

            MAPPING_CONFIG.forEach(field => {
                let bestMatchIndex = -1;
                let maxScore = 0;

                headers.forEach((h, colIdx) => {
                    const score = calculateColumnScore(h, columnData[colIdx], field);
                    if (score > maxScore && score > 0) {
                        maxScore = score;
                        bestMatchIndex = colIdx;
                    }
                });

                // สร้าง Dropdown Option
                let options = `<option value="-1">-- ไม่ระบุ --</option>`;
                headers.forEach((h, index) => {
                    const selected = (index === bestMatchIndex) ? 'selected' : '';
                    const colLetter = XLSX.utils.encode_col(index);
                    options += `<option value="${index}" ${selected}>[${colLetter}] ${h}</option>`;
                });

                const div = document.createElement('div');
                div.className = 'map-row';
                div.innerHTML = `
                    <div class="map-label">${field.label} ${field.required ? '<span style="color:red">*</span>' : ''}</div>
                    <select id="map_${field.key}" class="map-select" onchange="updatePreview(this, '${field.key}')">${options}</select>
                    <div id="preview_${field.key}" class="map-preview">
                        ${bestMatchIndex !== -1 ? formatPreview(columnData[bestMatchIndex][0]) : '-'}
                    </div>
                `;
                mapArea.appendChild(div);
            });
        }

        function updatePreview(select, key) {
            const idx = select.value;
            const el = document.getElementById(`preview_${key}`);
            if (idx == -1 || dataRows.length === 0) el.innerText = '-';
            else el.innerText = formatPreview(dataRows[0][idx]);
        }

        function formatPreview(val) {
            if (!val) return '-';
            if (val instanceof Date) return val.toLocaleDateString('th-TH');
            return String(val).substring(0, 20);
        }

        // --- Processing & Saving ---
        async function analyzeData() {
            const mapping = {};
            let hasName = false;

            MAPPING_CONFIG.forEach(field => {
                mapping[field.key] = parseInt(document.getElementById(`map_${field.key}`).value);
            });

            // ตรวจสอบขั้นต่ำ
            if (mapping.firstname === -1) { alert('กรุณาเลือกคอลัมน์ "ชื่อ"'); return; }

            finalData = dataRows.map(row => {
                const fname = mapping.firstname !== -1 ? row[mapping.firstname] : '';
                const lname = mapping.lastname !== -1 ? row[mapping.lastname] : '';
                
                if (!fname) return null; // ไม่มีชื่อ ข้าม

                // รวมชื่อ-นามสกุล
                let fullName = String(fname).trim();
                if(lname) fullName += ' ' + String(lname).trim();

                return {
                    student_code: mapping.student_code !== -1 ? String(row[mapping.student_code]).trim() : '',
                    student_name: fullName,
                    gender: mapping.gender !== -1 ? normalizeGender(row[mapping.gender]) : 'ชาย',
                    birth_date: mapping.birth_date !== -1 ? parseDate(row[mapping.birth_date]) : null,
                    classroom_id: currentClassId
                };
            }).filter(d => d !== null);

            // Check Duplicates
            const codes = finalData.map(d => d.student_code).filter(c => c);
            let dupCount = 0;
            if (codes.length > 0) {
                const { data } = await sysDB.from('students').select('student_code').eq('classroom_id', currentClassId).in('student_code', codes);
                dupCount = data ? data.length : 0;
            }

            document.getElementById('dupCount').innerText = dupCount;
            document.getElementById('conflictSection').style.display = dupCount > 0 ? 'block' : 'none';
            document.getElementById('analysisResult').innerText = `พร้อมนำเข้า ${finalData.length} รายการ`;

            goToStep(3);
        }

        function normalizeGender(val) {
            if (!val) return 'ชาย';
            const s = String(val).toLowerCase();
            if (s.includes('หญิง') || s.includes('female') || s.includes('f') || s.includes('ด.ญ.')) return 'หญิง';
            return 'ชาย';
        }

        function parseDate(val) {
            if (!val) return null;
            if (val instanceof Date) return val.toISOString().split('T')[0];
            
            // รองรับรูปแบบไทย เช่น 15/08/2556
            if (String(val).match(/\d{1,2}\/\d{1,2}\/\d{4}/)) {
                const parts = val.split('/');
                let year = parseInt(parts[2]);
                if(year > 2400) year -= 543; // แปลง พ.ศ. -> ค.ศ.
                return `${year}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
            }

            const d = new Date(val);
            if (!isNaN(d.getTime())) return d.toISOString().split('T')[0];
            return null;
        }

        function setConflictAction(action) {
            conflictAction = action;
            document.querySelectorAll('.btn-action').forEach(b => b.classList.remove('selected'));
            document.getElementById(action === 'overwrite' ? 'actOverwrite' : 'actSkip').classList.add('selected');
        }

        async function saveImportData() {
            const btn = document.querySelector('#step3 .btn-confirm');
            btn.innerText = 'กำลังบันทึก...'; btn.disabled = true;

            try {
                const { data: existing } = await sysDB.from('students').select('student_number').eq('classroom_id', currentClassId).order('student_number', {ascending:false}).limit(1);
                let startNum = existing.length > 0 ? existing[0].student_number + 1 : 1;
                
                let dataToInsert = [...finalData];
                dataToInsert.forEach((d, i) => { d.student_number = startNum + i; });

                if (conflictAction === 'overwrite') {
                    for (let st of dataToInsert) {
                        if(st.student_code) {
                            const { data } = await sysDB.from('students').select('student_id').eq('classroom_id', currentClassId).eq('student_code', st.student_code).maybeSingle();
                            if(data) {
                                await sysDB.from('students').update({ student_name: st.student_name, gender: st.gender, birth_date: st.birth_date }).eq('student_id', data.student_id);
                            } else {
                                await sysDB.from('students').insert([st]);
                            }
                        } else {
                            await sysDB.from('students').insert([st]);
                        }
                    }
                } else {
                    for (let st of dataToInsert) {
                         const { data } = await sysDB.from('students').select('student_id').eq('classroom_id', currentClassId).eq('student_code', st.student_code).maybeSingle();
                         if(!data) await sysDB.from('students').insert([st]);
                    }
                }

                alert('✅ นำเข้าข้อมูลสำเร็จ');
                closeImportModal();
                fetchStudents();

            } catch (err) {
                alert('เกิดข้อผิดพลาด: ' + err.message);
            } finally {
                btn.innerText = 'ยืนยันนำเข้า'; btn.disabled = false;
            }
        }
        
        // (Function printIDCards และ Helper format เหมือนเดิม)
        function formatDate(dateStr) {
            if(!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }
        
        async function printIDCards() {
            const { data: students } = await sysDB.from('students').select('*').eq('classroom_id', currentClassId);
            if (!students || students.length === 0) { alert('ไม่มีข้อมูลนักเรียน'); return; }

            const printArea = document.getElementById('printArea');
            printArea.innerHTML = '';
            
            students.forEach(st => {
                const qrContent = `FS|${st.student_id}`; 
                let dobText = st.birth_date ? formatDate(st.birth_date) : '-';
                
                const cardHtml = `
                    <div class="id-card" id="card_${st.student_id}">
                        <div class="card-header-bg"></div>
                        <div style="text-align:right; font-size:10px; color:white; position:relative; z-index:2; padding-right:5px; padding-top:5px;">FlipSchool ID</div>
                        <div class="card-content">
                            <div id="qr_${st.student_id}" class="card-qr"></div>
                            <div class="card-details">
                                <div class="card-name">${st.student_name}</div>
                                <div class="card-code" style="font-size:16px; font-weight:bold; color:#4361ee;">${st.student_code || '-'}</div>
                                <div class="card-code" style="font-size:10px;">DOB: ${dobText}</div>
                            </div>
                        </div>
                    </div>`;
                printArea.insertAdjacentHTML('beforeend', cardHtml);
                new QRCode(document.getElementById(`qr_${st.student_id}`), { text: qrContent, width: 70, height: 70, correctLevel: QRCode.CorrectLevel.L });
            });

            setTimeout(async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const cards = document.querySelectorAll('.id-card');
                let x = 10, y = 10;
                
                for (let i = 0; i < cards.length; i++) {
                    const canvas = await html2canvas(cards[i], { scale: 2 });
                    doc.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, 85, 54);
                    x += 95;
                    if (x > 110) { x = 10; y += 60; }
                    if (y > 250) { doc.addPage(); y = 10; }
                }
                doc.save('Student_ID_Cards.pdf');
            }, 1000);
        }
    </script>
</body>
</html>
