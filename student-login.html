<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - FlipSchool</title>
    <link rel="icon" href="img/favicon.png">
    
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body.auth-page { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .student-login-card {
            background: rgba(255, 255, 255, 0.95); border-radius: 24px; padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;
        }
        .school-badge {
            background: #eef2ff; color: #4361ee; padding: 8px 15px; border-radius: 12px;
            font-size: 14px; font-weight: 600; margin-bottom: 20px; display: inline-flex; align-items: center; gap: 8px;
            border: 1px solid #c7d2fe; cursor: pointer;
        }
        .school-badge:hover { background: #e0e7ff; }
        
        /* Search Box Styles (‡∏¢‡πà‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Register) */
        #searchSection { position: relative; margin-bottom: 20px; text-align: left; }
        #resultsBox { position: absolute; top: 105%; left: 0; right: 0; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; z-index: 100; display: none; border: 1px solid #eee; }
        .result-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 14px; text-align: left; }
        .result-item:hover { background-color: #f0f7ff; }
    </style>
</head>
<body class="auth-page">

    <div class="student-login-card">
        <img src="img/favicon.png" style="width:50px; margin-bottom:5px;">
        <h2 style="margin:0 0 15px 0; color:#333; font-family:'Kanit';">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>

        <div id="selectedSchoolDisplay" style="display:none;">
            <div class="school-badge" onclick="resetSchool()">
                <i class="fas fa-school"></i> <span id="schoolNameText">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</span> <i class="fas fa-times" style="color:#ff4757; margin-left:5px;"></i>
            </div>
        </div>

        <div id="searchSection">
            <label style="font-size:14px; font-weight:600; color:#555; display:block; margin-bottom:5px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö</label>
            <div class="input-wrapper">
                <input type="text" id="schoolInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." autocomplete="off">
                <i class="fas fa-search icon"></i>
            </div>
            <div id="resultsBox"></div>
        </div>

        <form onsubmit="handleStudentLogin(event)" id="loginForm" style="display:none; animation: fadeIn 0.5s;">
            <div class="input-group">
                <label style="text-align:left;">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <div class="input-wrapper">
                    <input type="tel" id="stCode" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß" required autocomplete="off">
                    <i class="fas fa-id-card icon"></i>
                </div>
            </div>

            <div class="input-group">
                <label style="text-align:left;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î)</label>
                <div class="input-wrapper">
                    <input type="tel" id="stDob" placeholder="05012012 (‡∏Ñ.‡∏®.)" required maxlength="8" autocomplete="off">
                    <i class="fas fa-birthday-cake icon"></i>
                    <i class="fas fa-eye toggle-password" onclick="togglePass()"></i>
                </div>
            </div>

            <button type="submit" class="btn-submit" id="btnLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
    </div>

    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>
    
    <script>
        let selectedSchoolId = null;

        document.addEventListener('DOMContentLoaded', () => {
            // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ‡πÑ‡∏´‡∏°? (‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
            const savedSchool = localStorage.getItem('flip_school_data');
            if (savedSchool) {
                const school = JSON.parse(savedSchool);
                selectSchool(school, false); // false = ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥
            }
        });

        // --- School Search Logic ---
        const searchInput = document.getElementById('schoolInput');
        const resultsBox = document.getElementById('resultsBox');
        let debounceTimer;

        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const q = this.value.trim();
            if (q.length < 2) { resultsBox.style.display = 'none'; return; }
            debounceTimer = setTimeout(() => searchSchool(q), 500);
        });

        async function searchSchool(k) {
            if (!sysDB) return;
            const { data } = await sysDB.from('schools').select('*').ilike('school_name', `%${k}%`).limit(5);
            resultsBox.innerHTML = '';
            if (data && data.length > 0) {
                data.forEach(s => {
                    const d = document.createElement('div');
                    d.className = 'result-item';
                    d.innerHTML = `<strong>${s.school_name}</strong><br><small style="color:#888;">${s.province}</small>`;
                    d.onclick = () => selectSchool(s, true);
                    resultsBox.appendChild(d);
                });
                resultsBox.style.display = 'block';
            }
        }

        function selectSchool(s, saveToLocal) {
            selectedSchoolId = s.school_id;
            
            // ‡πÅ‡∏™‡∏î‡∏á UI ‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('selectedSchoolDisplay').style.display = 'block';
            document.getElementById('schoolNameText').innerText = s.school_name;
            document.getElementById('loginForm').style.display = 'block';

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà)
            if (saveToLocal) {
                localStorage.setItem('flip_school_data', JSON.stringify(s));
            }
        }

        function resetSchool() {
            selectedSchoolId = null;
            localStorage.removeItem('flip_school_data'); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
            
            document.getElementById('searchSection').style.display = 'block';
            document.getElementById('selectedSchoolDisplay').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
            searchInput.value = '';
            resultsBox.style.display = 'none';
        }

        // --- Login Logic ---
        function togglePass() {
            const input = document.getElementById('stDob');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        async function handleStudentLogin(e) {
            e.preventDefault();
            const code = document.getElementById('stCode').value.trim();
            let dobInput = document.getElementById('stDob').value.trim();
            const btn = document.getElementById('btnLogin');

            if (dobInput.length !== 8) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î 8 ‡∏´‡∏•‡∏±‡∏Å'); return; }

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (DDMMYYYY -> YYYY-MM-DD)
            const day = dobInput.substring(0, 2);
            const month = dobInput.substring(2, 4);
            const year = dobInput.substring(4, 8);
            const dbDate = `${year}-${month}-${day}`;

            btn.disabled = true; btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

            try {
                // ‚úÖ Query ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á Student Code ‡πÅ‡∏•‡∏∞ School ID
                // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á students ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö classrooms ‡πÅ‡∏•‡∏∞ classrooms ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö schools
                // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ Supabase Join Table (Query ‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
                
                const { data, error } = await sysDB
                    .from('students')
                    .select('*, classrooms!inner(school_id, schools(school_name))') 
                    .eq('student_code', code)
                    .eq('birth_date', dbDate)
                    .eq('classrooms.school_id', selectedSchoolId) // üî• ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    .maybeSingle();

                if (error || !data) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ú‡∏¥‡∏î‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');

                // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                alert(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${data.student_name} üéâ`);
                // window.location.href = 'student-dashboard.html';

            } catch (err) {
                alert('‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
                btn.disabled = false; btn.innerText = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            }
        }
    </script>
</body>
</html>
