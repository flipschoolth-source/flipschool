<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */
        .search-box { position: relative; width: 100%; }
        input[type="text"] { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        input[type="text"]:focus { border-color: #007bff; outline: none; }

        /* ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå Dropdown */
        #results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px;
            max-height: 200px; overflow-y: auto; z-index: 100;
            display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .item:hover { background: #f0f7ff; color: #007bff; }
        .item strong { display: block; font-size: 15px; }
        .item small { color: #666; font-size: 13px; }

        /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Debug */
        #status { margin-top: 10px; font-size: 14px; color: #666; }
        .spinner { display: none; color: #007bff; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h3>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</h3>
    
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô... (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà)" autocomplete="off">
        <i class="fas fa-spinner fa-spin spinner" id="spinner"></i>
        <div id="results"></div>
    </div>

    <div id="selection" style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; display: none;">
        <h4 style="margin:0; color: #2e7d32;" id="selName"></h4>
        <p style="margin:5px 0 0; font-size: 14px;" id="selDetail"></p>
        <p style="margin:5px 0 0; font-size: 12px; color: #555;">ID: <span id="selID"></span></p>
    </div>

    <div id="status">üî¥ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
</div>

<script>
    // --- 1. ‡πÉ‡∏™‡πà KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
    const SUPABASE_URL = 'https://hznmvaxjlgjnrvtjosdt.supabase.co'; // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bm12YXhqbGdqbnJ2dGpvc2R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NjQwMzMsImV4cCI6MjA4MjU0MDAzM30.o5W0oP8mnMOs9DWcvGgZ9F7E1EdysBuUu807UKdbqnE'; // ‡πÉ‡∏™‡πà Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Client
    let supabase;
    const statusDiv = document.getElementById('status');
    
    try {
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
            statusDiv.innerHTML = "‚ö†Ô∏è <b>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</b> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ KEY ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö";
        } else {
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            statusDiv.innerHTML = "üü¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
        }
    } catch (e) {
        statusDiv.innerHTML = "‚ùå Error: " + e.message;
    }

    // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ---
    const input = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('results');
    const spinner = document.getElementById('spinner');
    let timeout = null;

    input.addEventListener('input', function() {
        clearTimeout(timeout);
        const query = this.value.trim();
        
        if(query.length === 0) {
            resultsDiv.style.display = 'none';
            return;
        }

        spinner.style.display = 'inline-block';
        statusDiv.innerHTML = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: " + query;

        // ‡∏£‡∏≠ 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á Database
        timeout = setTimeout(() => performSearch(query), 500);
    });

    async function performSearch(keyword) {
        if (!supabase) {
            alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase Key ‡∏Ñ‡∏£‡∏±‡∏ö");
            spinner.style.display = 'none';
            return;
        }

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á schools ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå school_name
        const { data, error } = await supabase
            .from('schools') // ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô SQL
            .select('*')
            .ilike('school_name', `%${keyword}%`) // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥
            .limit(10);

        spinner.style.display = 'none';

        if (error) {
            console.error(error);
            statusDiv.innerHTML = "‚ùå ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + error.message;
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞ RLS ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (error.code === '42501') { 
                statusDiv.innerHTML += "<br>(‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î Policy ‡πÉ‡∏ô SQL)";
            }
            return;
        }

        displayResults(data);
    }

    function displayResults(schools) {
        resultsDiv.innerHTML = '';
        
        if (schools.length === 0) {
            statusDiv.innerHTML = "‚ö†Ô∏è ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            resultsDiv.style.display = 'none';
            return;
        }

        statusDiv.innerHTML = `‚úÖ ‡πÄ‡∏à‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${schools.length} ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô`;

        schools.forEach(school => {
            const div = document.createElement('div');
            div.className = 'item';
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å SQL: school_name, district, province
            div.innerHTML = `
                <strong>${school.school_name}</strong>
                <small>‡∏≠.${school.district || '-'} ‡∏à.${school.province || '-'}</small>
            `;
            
            div.onclick = () => {
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                input.value = school.school_name;
                resultsDiv.style.display = 'none';
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                document.getElementById('selection').style.display = 'block';
                document.getElementById('selName').innerText = school.school_name;
                document.getElementById('selDetail').innerText = `‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ‡∏≠.${school.district} ‡∏à.${school.province}`;
                document.getElementById('selID').innerText = school.school_id;
            };
            
            resultsDiv.appendChild(div);
        });

        resultsDiv.style.display = 'block';
    }

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
    document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });
</script>

</body>
</html>
