<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>***‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏£‡∏π - FlipSchool</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS ‡πÄ‡∏î‡∏¥‡∏° + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° --- */
        :root { --primary: #007bff; --accent: #ffc107; }
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .app-container { max-width: 500px; margin: 0 auto; }
        .card-glass { background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        
        .register-header { text-align: center; margin-bottom: 25px; }
        .register-header h2 { color: var(--primary); margin: 10px 0 5px; }
        .register-header p { color: #666; font-size: 14px; margin: 0; }

        .form-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; font-family: 'Sarabun', sans-serif; }
        .form-input:focus { border-color: var(--primary); outline: none; }
        
        .btn-main { width: 100%; padding: 14px; border: none; border-radius: 10px; background: var(--primary); color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main:hover { background: #0056b3; }

        /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà) --- */
        .school-search-wrapper { position: relative; }
        
        #schoolResults {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 12px 12px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .school-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; text-align: left; transition: background 0.2s; }
        .school-item:hover { background-color: #f0f7ff; color: var(--primary); }
        .school-item strong { display: block; font-size: 15px; }
        .school-item small { color: #888; font-size: 13px; }

        .selected-school-card {
            display: none;
            background: #E8F5E9;
            border: 1px solid #C8E6C9;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 20px;
            text-align: left;
            position: relative;
        }
        .remove-school { position: absolute; right: 10px; top: 10px; color: #d32f2f; cursor: pointer; font-size: 18px; }

        /* Loading Spinner */
        .spinner { display: none; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-left: 8px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <a href="#" onclick="history.back()" style="position:absolute; top:20px; left:20px; font-size:24px; color:var(--primary);"><i class="fas fa-arrow-left"></i></a>

    <div class="app-container">
        <div class="card-glass" style="padding: 30px 20px;">
            <div class="register-header">
                <i class="fas fa-user-plus" style="font-size: 40px; color: var(--accent); margin-bottom: 15px;"></i>
                <h2>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏£‡∏π</h2>
                <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
            </div>

            <form id="registerForm" onsubmit="handleRegister(event)">
                
                <div style="margin-bottom: 15px; text-align: left;">
                    <label style="font-weight: 600; margin-bottom: 5px; display: block;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="fullname" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏£‡∏π‡πÉ‡∏à‡∏î‡∏µ ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" required>
                </div>

                <div style="margin-bottom: 15px; text-align: left;">
                    <label style="font-weight: 600; margin-bottom: 5px; display: block;">
                        ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î <span class="spinner" id="searchSpinner"></span>
                    </label>
                    
                    <div class="school-search-wrapper" id="searchWrapper">
                        <input type="text" id="schoolSearch" class="form-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." autocomplete="off">
                        <div id="schoolResults"></div>
                    </div>

                    <div id="selectedSchoolDisplay" class="selected-school-card">
                        <h4 id="selSchoolName" style="margin:0; color:#2E7D32;"></h4>
                        <p id="selSchoolLoc" style="margin:2px 0 0; font-size:13px; color:#555;"></p>
                        <i class="fas fa-times-circle remove-school" onclick="clearSchoolSelection()"></i>
                    </div>

                    <input type="hidden" id="schoolId" required>
                </div>

                <div style="margin-bottom: 15px; text-align: left;">
                    <label style="font-weight: 600; margin-bottom: 5px; display: block;">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="email" class="form-input" placeholder="teacher@email.com" required>
                </div>

                <div style="margin-bottom: 25px; text-align: left;">
                    <label style="font-weight: 600; margin-bottom: 5px; display: block;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="password" class="form-input" placeholder="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ" minlength="6" required>
                </div>

                <button type="submit" class="btn-main">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô <i class="fas fa-check-circle"></i></button>

            </form>
        </div>
    </div>

    <script>
        // --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ---
        const SUPABASE_URL = 'https://hznmvaxjlgjnrvtjosdt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bm12YXhqbGdqbnJ2dGpvc2R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NjQwMzMsImV4cCI6MjA4MjU0MDAzM30.o5W0oP8mnMOs9DWcvGgZ9F7E1EdysBuUu807UKdbqnE';
        
        let supabase = null;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        document.addEventListener('DOMContentLoaded', () => {
            console.log("System Loaded: Ready");

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏™‡πà Key ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á? ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            if (SUPABASE_URL.includes('‡πÉ‡∏™‡πà_') || !window.supabase) {
                console.warn('‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà Supabase Key -> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Mock Data (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)');
                supabase = null; 
            } else {
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log("‚úÖ Supabase Connected");
                } catch (e) {
                    console.error("Supabase Error:", e);
                    supabase = null; // ‡∏ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Mock
                }
            }
        });

        // --- 2. Logic ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ---
        const searchInput = document.getElementById('schoolSearch');
        const resultsBox = document.getElementById('schoolResults');
        const spinner = document.getElementById('searchSpinner');
        let debounceTimer;

        // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const query = this.value.trim();

            console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå: " + query); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ event ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏´‡∏°

            if (query.length < 2) {
                resultsBox.style.display = 'none';
                return;
            }

            spinner.style.display = 'inline-block';
            
            // ‡∏£‡∏≠ 0.5 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            debounceTimer = setTimeout(() => {
                if (supabase) {
                    searchSupabase(query);
                } else {
                    searchMockData(query);
                }
            }, 500);
        });

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡πà‡∏≤‡∏ô Database ‡∏à‡∏£‡∏¥‡∏á
        async function searchSupabase(keyword) {
            console.log("üîç Searching Supabase: " + keyword);
            const { data, error } = await supabase
                .from('schools')
                .select('*')
                .ilike('school_name', `%${keyword}%`)
                .limit(10);

            spinner.style.display = 'none';

            if (error) {
                console.error("DB Error:", error);
                resultsBox.innerHTML = '<div style="padding:10px; color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>';
                resultsBox.style.display = 'block';
            } else {
                displayResults(data);
            }
        }

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠ DB)
        function searchMockData(keyword) {
            console.log("üîç Searching Mock Data: " + keyword);
            spinner.style.display = 'none';

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            const mockData = [
                { school_id: '001', school_name: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡∏™‡∏¥‡∏á‡∏´‡πå', district: '‡∏ß‡∏±‡∏î‡∏™‡∏¥‡∏á‡∏´‡πå', province: '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó' },
                { school_id: '002', school_name: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', district: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á', province: '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ' },
                { school_id: '003', school_name: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢', district: '‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà', province: '‡∏™‡∏á‡∏Ç‡∏•‡∏≤' },
                { school_id: '004', school_name: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', district: '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', province: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø' },
                { school_id: '005', school_name: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏Æ‡∏µ', district: '‡∏´‡∏ô‡∏≠‡∏á‡∏Æ‡∏µ', province: '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô' }
            ];

            const filtered = mockData.filter(s => s.school_name.includes(keyword));
            displayResults(filtered);
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function displayResults(schools) {
            resultsBox.innerHTML = '';
            
            if (!schools || schools.length === 0) {
                resultsBox.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                resultsBox.style.display = 'block';
                return;
            }

            schools.forEach(school => {
                const div = document.createElement('div');
                div.className = 'school-item';
                div.innerHTML = `
                    <strong>${school.school_name}</strong>
                    <small>‡∏≠.${school.district || '-'} ‡∏à.${school.province || '-'}</small>
                `;
                // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢
                div.onclick = () => selectSchool(school);
                resultsBox.appendChild(div);
            });

            resultsBox.style.display = 'block';
        }

        // --- 3. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ---
        function selectSchool(school) {
            console.log("Selected:", school);
            document.getElementById('schoolId').value = school.school_id;
            
            document.getElementById('selSchoolName').innerText = school.school_name;
            document.getElementById('selSchoolLoc').innerText = `‡∏≠.${school.district || '-'} ‡∏à.${school.province || '-'}`;
            
            document.getElementById('searchWrapper').style.display = 'none';
            document.getElementById('selectedSchoolDisplay').style.display = 'block';
            resultsBox.style.display = 'none';
        }

        // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        function clearSchoolSelection() {
            document.getElementById('schoolId').value = '';
            document.getElementById('searchWrapper').style.display = 'block';
            document.getElementById('selectedSchoolDisplay').style.display = 'none';
            searchInput.value = '';
            searchInput.focus();
        }

        // --- 4. Submit Form ---
        function handleRegister(e) {
            e.preventDefault();
            const sid = document.getElementById('schoolId').value;
            
            if(!sid) {
                alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            alert("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å! (School ID: " + sid + ")");
            // ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supabase ‡∏ï‡πà‡∏≠‡πÑ‡∏õ...
        }

        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
                resultsBox.style.display = 'none';
            }
        });
    </script>

</body>
</html>
