<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - FlipSchool</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h3 { color: #333; margin-top: 0; }
        
        /* ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */
        .search-wrapper { position: relative; margin-top: 15px; }
        input[type="text"] { width: 100%; padding: 12px 12px 12px 40px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: 0.3s; }
        input[type="text"]:focus { border-color: #007bff; outline: none; }
        .search-icon { position: absolute; left: 12px; top: 15px; color: #999; }

        /* ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Dropdown) */
        #resultsBox {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px;
            max-height: 250px; overflow-y: auto; z-index: 1000;
            display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .result-item { padding: 12px; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
        .result-item:hover { background-color: #f0f7ff; color: #007bff; }
        .result-item strong { display: block; font-size: 15px; }
        .result-item small { color: #666; font-size: 13px; }

        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß */
        .selected-card {
            display: none; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px;
            padding: 15px; margin-top: 15px; position: relative;
        }
        .close-btn { position: absolute; top: 10px; right: 10px; color: #d32f2f; cursor: pointer; }

        /* Status Bar */
        #statusMsg { margin-top: 15px; font-size: 13px; color: #666; padding: 10px; background: #f8f9fa; border-radius: 6px; }
    </style>
</head>
<body>

<div class="container">
    <h3><i class="fas fa-school"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</h3>
    
    <div class="search-wrapper" id="searchSection">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="schoolInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô... (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà)" autocomplete="off">
        <div id="resultsBox"></div>
    </div>

    <div id="selectedCard" class="selected-card">
        <i class="fas fa-times close-btn" onclick="resetSelection()"></i>
        <h4 style="margin:0; color: #2e7d32;" id="showName"></h4>
        <p style="margin:5px 0 0; color: #555;" id="showLoc"></p>
        <small style="color: #999;">School ID: <span id="showId"></span></small>
    </div>

    <div id="statusMsg">üî¥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</div>
</div>

<script>
    // ----------------------------------------------------
    // 1. ‡πÉ‡∏™‡πà KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö ' ' ‡∏≠‡∏≠‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö)
    // ----------------------------------------------------
    const SUPABASE_URL = 'https://hznmvaxjlgjnrvtjosdt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bm12YXhqbGdqbnJ2dGpvc2R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NjQwMzMsImV4cCI6MjA4MjU0MDAzM30.o5W0oP8mnMOs9DWcvGgZ9F7E1EdysBuUu807UKdbqnE';
    // ----------------------------------------------------

    let dbClient = null; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏õ‡πá‡∏ô dbClient ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥
    const statusDiv = document.getElementById('statusMsg');
    const input = document.getElementById('schoolInput');
    const resultsBox = document.getElementById('resultsBox');
    let timer = null;

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
    document.addEventListener('DOMContentLoaded', () => {
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ User ‡πÉ‡∏™‡πà Key ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        if (SUPABASE_URL.includes('‡πÉ‡∏™‡πà_') || SUPABASE_URL.length < 10) {
            statusDiv.innerHTML = "‚ö†Ô∏è <b>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</b> ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà Supabase Key ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏£‡∏±‡∏ö";
            statusDiv.style.color = 'red';
            return;
        }

        try {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            statusDiv.innerHTML = "üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
            statusDiv.style.color = 'green';
        } catch (err) {
            statusDiv.innerHTML = "‚ùå Error: " + err.message;
        }
    });

    // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
    input.addEventListener('input', function() {
        clearTimeout(timer);
        const text = this.value.trim();

        if (text.length === 0) {
            resultsBox.style.display = 'none';
            return;
        }

        statusDiv.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå...";
        
        // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Debounce)
        timer = setTimeout(() => searchSchool(text), 500);
    });

    async function searchSchool(keyword) {
        if (!dbClient) return;

        statusDiv.innerHTML = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: " + keyword;

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á schools
        const { data, error } = await dbClient
            .from('schools')
            .select('*')
            .ilike('school_name', `%${keyword}%`) // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥
            .limit(10);

        if (error) {
            console.error(error);
            statusDiv.innerHTML = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
            if(error.code === '42501') statusDiv.innerHTML += " (‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå RLS ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô SQL ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ)";
            return;
        }

        renderResults(data);
    }

    function renderResults(schools) {
        resultsBox.innerHTML = '';

        if (!schools || schools.length === 0) {
            statusDiv.innerHTML = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
            resultsBox.style.display = 'none';
            return;
        }

        statusDiv.innerHTML = `‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${schools.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        
        schools.forEach(school => {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.innerHTML = `
                <strong>${school.school_name}</strong>
                <small>‡∏à.${school.province} (‡∏≠.${school.district})</small>
            `;
            
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            div.onclick = () => {
                document.getElementById('searchSection').style.display = 'none';
                document.getElementById('selectedCard').style.display = 'block';
                
                document.getElementById('showName').innerText = school.school_name;
                document.getElementById('showLoc').innerText = `‡∏≠.${school.district} ‡∏à.${school.province}`;
                document.getElementById('showId').innerText = school.school_id;
                
                statusDiv.innerHTML = "üÜó ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)";
                resultsBox.style.display = 'none';
            };

            resultsBox.appendChild(div);
        });

        resultsBox.style.display = 'block';
    }

    function resetSelection() {
        document.getElementById('searchSection').style.display = 'block';
        document.getElementById('selectedCard').style.display = 'none';
        input.value = '';
        input.focus();
        statusDiv.innerHTML = "üü¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà";
    }

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Popup
    document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !resultsBox.contains(e.target)) {
            resultsBox.style.display = 'none';
        }
    });
</script>

</body>
</html>
