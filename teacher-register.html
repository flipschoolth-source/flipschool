<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>สมัครสมาชิกครู - FlipSchool</title>
    
    <link rel="icon" href="data:,">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&family=Sarabun:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CSS จัดหน้าตา --- */
        :root { --primary: #007bff; --bg: #f4f7f6; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        
        .container { width: 100%; max-width: 500px; margin-top: 20px; }
        .card { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }

        h2 { text-align: center; color: var(--primary); font-family: 'Kanit', sans-serif; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #666; font-size: 14px; margin-bottom: 30px; }

        /* Form Elements */
        label { font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block; color: #333; }
        .input-group { margin-bottom: 20px; }
        
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%; padding: 12px 15px; 
            border: 2px solid #e1e1e1; border-radius: 10px; 
            font-size: 16px; font-family: 'Sarabun', sans-serif;
            box-sizing: border-box; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); outline: none; }

        /* Search Dropdown */
        .search-wrapper { position: relative; }
        #resultsBox {
            position: absolute; top: 105%; left: 0; right: 0;
            background: white; border: 1px solid #eee; border-radius: 10px;
            max-height: 220px; overflow-y: auto; z-index: 1000;
            display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .result-item { padding: 12px; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
        .result-item:hover { background-color: #f0f7ff; color: var(--primary); }
        .result-item strong { display: block; font-size: 15px; }
        .result-item small { color: #888; font-size: 13px; }

        /* Selected School Card */
        .selected-card {
            display: none; background: #e8f5e9; border: 1px solid #c8e6c9;
            border-radius: 10px; padding: 15px; margin-top: 10px; position: relative;
        }
        .remove-school { position: absolute; right: 12px; top: 12px; color: #d32f2f; cursor: pointer; }

        /* Button */
        .btn-submit { 
            width: 100%; padding: 14px; border: none; border-radius: 10px; 
            background: var(--primary); color: white; font-size: 16px; font-weight: bold; 
            cursor: pointer; transition: 0.2s; margin-top: 10px;
        }
        .btn-submit:hover { background: #0056b3; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

        /* Spinner */
        .spinner { display: none; width: 18px; height: 18px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; vertical-align: middle; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>สมัครสมาชิกครู</h2>
        <p class="subtitle">สร้างบัญชีเพื่อเริ่มจัดการห้องเรียน</p>

        <form id="registerForm" onsubmit="handleRegister(event)">
            
            <div class="input-group">
                <label>ชื่อ-นามสกุลจริง</label>
                <input type="text" id="fullname" placeholder="เช่น สมชาย ใจดี" required>
            </div>

            <div class="input-group">
                <label>โรงเรียนสังกัด <div class="spinner" id="searchSpinner"></div></label>
                
                <div class="search-wrapper" id="searchSection">
                    <input type="text" id="schoolInput" placeholder="พิมพ์ชื่อโรงเรียน... (เช่น หาดใหญ่)" autocomplete="off">
                    <div id="resultsBox"></div>
                </div>

                <div id="selectedCard" class="selected-card">
                    <h4 id="showName" style="margin:0; color:#2E7D32;"></h4>
                    <p id="showLoc" style="margin:2px 0 0; font-size:13px; color:#555;"></p>
                    <i class="fas fa-times-circle remove-school" onclick="resetSchool()"></i>
                </div>
                
                <input type="hidden" id="schoolId" required>
            </div>

            <div class="input-group">
                <label>อีเมล</label>
                <input type="email" id="email" placeholder="name@email.com" required>
            </div>

            <div class="input-group">
                <label>รหัสผ่าน</label>
                <input type="password" id="password" placeholder="อย่างน้อย 6 ตัวอักษร" minlength="6" required>
            </div>

            <button type="submit" class="btn-submit" id="btnSubmit">
                ลงทะเบียน <i class="fas fa-arrow-right"></i>
            </button>
        </form>
    </div>
</div>

<script>
    // ===========================================================
    // ⚠️ ล้างไฟล์เก่าให้หมดก่อนวางนะครับ ไม่งั้นจะ Error ซ้ำ
    // ===========================================================
    
    // 1. ใส่ KEY ของคุณที่นี่ (ห้ามลบเครื่องหมาย ' ' )
    const SUPABASE_URL = 'https://hznmvaxjlgjnrvtjosdt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bm12YXhqbGdqbnJ2dGpvc2R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NjQwMzMsImV4cCI6MjA4MjU0MDAzM30.o5W0oP8mnMOs9DWcvGgZ9F7E1EdysBuUu807UKdbqnE';

    let supabase = null;
    
    // เริ่มต้นระบบ
    document.addEventListener('DOMContentLoaded', () => {
        if (SUPABASE_URL.includes('ใส่_')) {
            alert("⚠️ แจ้งเตือน: กรุณาใส่ Supabase URL และ Key ในโค้ดก่อนใช้งาน");
        } else {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
    });

    // --- ส่วนที่ 1: ระบบค้นหาโรงเรียน ---
    const searchInput = document.getElementById('schoolInput');
    const resultsBox = document.getElementById('resultsBox');
    const searchSpinner = document.getElementById('searchSpinner');
    let debounceTimer;

    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        
        if (query.length < 2) { 
            resultsBox.style.display = 'none'; 
            return; 
        }
        
        searchSpinner.style.display = 'inline-block';
        debounceTimer = setTimeout(() => searchSchool(query), 500);
    });

    async function searchSchool(keyword) {
        if (!supabase) return;

        const { data, error } = await supabase
            .from('schools')
            .select('*')
            .ilike('school_name', `%${keyword}%`)
            .limit(10);

        searchSpinner.style.display = 'none';
        
        if (error) {
            console.error("Search Error:", error);
            return;
        }
        renderResults(data);
    }

    function renderResults(schools) {
        resultsBox.innerHTML = '';
        if (!schools || schools.length === 0) {
            resultsBox.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">ไม่พบข้อมูล</div>';
        } else {
            schools.forEach(school => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `<strong>${school.school_name}</strong><small>จ.${school.province}</small>`;
                div.onclick = () => selectSchool(school);
                resultsBox.appendChild(div);
            });
        }
        resultsBox.style.display = 'block';
    }

    function selectSchool(school) {
        document.getElementById('schoolId').value = school.school_id;
        document.getElementById('showName').innerText = school.school_name;
        document.getElementById('showLoc').innerText = `อ.${school.district} จ.${school.province}`;
        
        document.getElementById('searchSection').style.display = 'none';
        document.getElementById('selectedCard').style.display = 'block';
        resultsBox.style.display = 'none';
    }

    function resetSchool() {
        document.getElementById('schoolId').value = '';
        document.getElementById('searchSection').style.display = 'block';
        document.getElementById('selectedCard').style.display = 'none';
        searchInput.value = '';
        searchInput.focus();
    }

    // คลิกข้างนอกเพื่อปิด Dropdown
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
            resultsBox.style.display = 'none';
        }
    });

    // --- ส่วนที่ 2: ระบบสมัครสมาชิก ---
    async function handleRegister(e) {
        e.preventDefault();
        
        if (!supabase) { alert("ยังไม่ได้เชื่อมต่อระบบฐานข้อมูล"); return; }

        const btn = document.getElementById('btnSubmit');
        const schoolId = document.getElementById('schoolId').value;
        const fullname = document.getElementById('fullname').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!schoolId) { 
            alert('❌ กรุณาเลือกโรงเรียนก่อนครับ'); 
            return; 
        }

        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="display:inline-block; border-color:white; border-top-color:transparent;"></div> กำลังบันทึก...';

        try {
            // 1. สร้าง User Auth
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email: email,
                password: password
            });

            if (authError) throw authError;

            // 2. แยกชื่อ-นามสกุล
            const names = fullname.trim().split(' ');
            const firstName = names[0];
            const lastName = names.slice(1).join(' ') || '-';

            // 3. บันทึกข้อมูลครู
            const { error: dbError } = await supabase.from('teachers').insert([{
                teacher_id: authData.user.id,
                school_id: schoolId,
                first_name: firstName,
                last_name: lastName,
                email: email,
                status: 'ปกติ'
            }]);

            if (dbError) throw dbError;

            alert('✅ สมัครสมาชิกสำเร็จ! ยินดีต้อนรับครับ');
            window.location.href = 'teacher-login.html'; 

        } catch (err) {
            console.error(err);
            alert('❌ เกิดข้อผิดพลาด: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = 'ลงทะเบียน <i class="fas fa-arrow-right"></i>';
        }
    }
</script>

</body>
</html>
