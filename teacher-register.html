<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สมัครสมาชิกครู</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        input { width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        button:hover { background: #0056b3; }
        
        /* Dropdown ค้นหา */
        .search-wrap { position: relative; }
        #results { 
            position: absolute; top: 100%; left: 0; right: 0; 
            background: white; border: 1px solid #ddd; border-radius: 8px; 
            max-height: 200px; overflow-y: auto; z-index: 999; display: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .item:hover { background: #f0f7ff; color: #007bff; }
        
        .selected-box { background: #e8f5e9; padding: 10px; border-radius: 8px; display: none; margin-bottom: 15px; border: 1px solid #c8e6c9; }
        .spinner { display: none; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#007bff;">สมัครสมาชิกครู</h2>

    <form onsubmit="register(event)">
        <label>ชื่อ-นามสกุล</label>
        <input type="text" id="fullname" placeholder="เช่น สมชาย ใจดี" required>

        <label>โรงเรียน <i class="fas fa-spinner fa-spin spinner" id="spin"></i></label>
        <div class="search-wrap" id="searchBox">
            <input type="text" id="schoolInput" placeholder="พิมพ์ชื่อโรงเรียน..." autocomplete="off">
            <div id="results"></div>
        </div>

        <div id="selectedBox" class="selected-box">
            <strong id="showName" style="color:#2e7d32;"></strong>
            <div id="showLoc" style="font-size:13px; color:#555;"></div>
            <div style="text-align:right; color:red; cursor:pointer; font-size:12px;" onclick="resetSchool()">[เปลี่ยน]</div>
        </div>
        <input type="hidden" id="schoolId" required>

        <label>อีเมล</label>
        <input type="email" id="email" required>

        <label>รหัสผ่าน</label>
        <input type="password" id="password" minlength="6" required>

        <button type="submit" id="btnReg">ลงทะเบียน</button>
    </form>
</div>

<script>
    // --- 1. ใส่ KEY ของคุณที่นี่ (ห้ามลบ ' ' ) ---
    const URL = 'ใส่_URL_ของคุณ';
    const KEY = 'ใส่_KEY_ของคุณ';
    // ------------------------------------------

    // ป้องกัน Error ประกาศตัวแปรซ้ำ
    let supabase = null;
    if (window.supabase) {
        supabase = window.supabase.createClient(URL, KEY);
    } else {
        alert("โหลด Supabase ไม่สำเร็จ กรุณาเช็คอินเทอร์เน็ต");
    }

    // ตัวแปรค้นหา
    const input = document.getElementById('schoolInput');
    const results = document.getElementById('results');
    const spin = document.getElementById('spin');
    let timer;

    // ระบบค้นหา (พิมพ์แล้วรอ 0.5 วิ)
    input.addEventListener('input', (e) => {
        clearTimeout(timer);
        const val = e.target.value.trim();
        if(val.length < 2) { results.style.display='none'; return; }
        
        spin.style.display = 'inline-block';
        timer = setTimeout(() => search(val), 500);
    });

    async function search(txt) {
        if(!supabase) return;
        const { data, error } = await supabase.from('schools')
            .select('*').ilike('school_name', `%${txt}%`).limit(10);
        
        spin.style.display = 'none';
        results.innerHTML = '';
        
        if(error || !data.length) {
            results.innerHTML = '<div style="padding:10px; color:#999;">ไม่พบข้อมูล</div>';
        } else {
            data.forEach(s => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<b>${s.school_name}</b><br><small>จ.${s.province}</small>`;
                div.onclick = () => select(s);
                results.appendChild(div);
            });
        }
        results.style.display = 'block';
    }

    function select(s) {
        document.getElementById('schoolId').value = s.school_id;
        document.getElementById('showName').innerText = s.school_name;
        document.getElementById('showLoc').innerText = `อ.${s.district} จ.${s.province}`;
        
        document.getElementById('searchBox').style.display = 'none';
        document.getElementById('selectedBox').style.display = 'block';
        results.style.display = 'none';
    }

    function resetSchool() {
        document.getElementById('schoolId').value = '';
        document.getElementById('searchBox').style.display = 'block';
        document.getElementById('selectedBox').style.display = 'none';
        input.value = '';
    }

    // ระบบสมัครสมาชิก
    async function register(e) {
        e.preventDefault();
        if(!supabase) return;

        const btn = document.getElementById('btnReg');
        const sid = document.getElementById('schoolId').value;
        const name = document.getElementById('fullname').value;
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;

        if(!sid) { alert("กรุณาเลือกโรงเรียนก่อนครับ"); return; }

        btn.innerText = "กำลังบันทึก...";
        btn.disabled = true;

        try {
            // 1. สมัคร Auth
            const { data, error } = await supabase.auth.signUp({ email: email, password: pass });
            if(error) throw error;

            // 2. แยกชื่อนามสกุล
            const names = name.split(' ');
            const fname = names[0];
            const lname = names.slice(1).join(' ') || '-';

            // 3. บันทึก Teacher
            const { error: dbError } = await supabase.from('teachers').insert([{
                teacher_id: data.user.id,
                school_id: sid,
                first_name: fname,
                last_name: lname,
                email: email
            }]);
            
            if(dbError) throw dbError;

            alert("✅ สมัครสำเร็จ!");
            window.location.href = 'teacher-login.html'; // ส่งไปหน้า Login

        } catch (err) {
            alert("เกิดข้อผิดพลาด: " + err.message);
            btn.innerText = "ลงทะเบียน";
            btn.disabled = false;
        }
    }

    // ปิด popup เมื่อคลิกข้างนอก
    document.addEventListener('click', (e) => {
        if(!input.contains(e.target)) results.style.display = 'none';
    });
</script>

</body>
</html>
