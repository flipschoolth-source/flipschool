<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ üöÄ - FlipSchool</title>
    
    <link rel="icon" type="image/png" href="img/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <style>
        :root { 
            --primary-dark: #000046; --primary: #00008B; --primary-light: #0052D4;
            --accent: #FF8C00; --bg-body: #f4f7fe; --white: #ffffff;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-body); margin: 0; padding-bottom: 50px; }

        .page-header { 
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); 
            padding: 50px 20px; color: white; border-radius: 0 0 50px 50px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,70,0.15);
        }

        .container { max-width: 1000px; margin: -40px auto 0; padding: 0 20px; }

        .card { 
            background: white; border-radius: 35px; padding: 35px; 
            box-shadow: 0 15px 45px rgba(0,0,0,0.06); margin-bottom: 25px;
            border: 1px solid rgba(0,0,0,0.02);
        }

        .template-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 25px; 
        }

        .template-item {
            border: 2px solid #f0f4ff; border-radius: 25px; padding: 20px; text-align: center;
            cursor: pointer; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: white;
        }

        .template-item:hover { transform: translateY(-10px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: var(--primary-light); }
        .template-item.active { border-color: var(--primary); background: var(--primary); color: white; }
        .template-item span { font-size: 40px; display: block; margin-bottom: 10px; }
        .template-item strong { font-family: 'Kanit'; font-size: 15px; display: block; line-height: 1.2; }

        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; font-family: 'Kanit'; font-weight: 500; margin-bottom: 10px; color: #2d3436; font-size: 17px; }
        .form-control { 
            width: 100%; padding: 15px 20px; border-radius: 15px; border: 1px solid #e0e6ed; 
            font-family: 'Sarabun'; box-sizing: border-box; font-size: 16px; transition: 0.3s;
        }
        .form-control:focus { border-color: var(--primary-light); outline: none; box-shadow: 0 0 0 4px rgba(0,82,212,0.1); }

        /* Dynamic Editor */
        #contentEditor { margin-top: 30px; padding-top: 30px; border-top: 2px dashed #eee; }
        .dynamic-item { 
            background: #f8fbff; padding: 20px; border-radius: 20px; margin-bottom: 15px; 
            position: relative; border: 1px solid #edf2f7;
        }
        .btn-remove { position: absolute; top: 15px; right: 15px; color: #ff4757; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .btn-remove:hover { transform: scale(1.2); }

        .btn-add-item { 
            background: #fff; color: var(--primary); border: 2px dashed var(--primary);
            width: 100%; padding: 15px; border-radius: 18px; cursor: pointer; font-family: 'Kanit';
            font-weight: 600; font-size: 16px; transition: 0.3s;
        }
        .btn-add-item:hover { background: var(--primary); color: white; }

        .footer-actions { display: flex; gap: 20px; margin-top: 40px; margin-bottom: 50px; }
        .btn-main { flex: 1; padding: 20px; border-radius: 20px; border: none; font-family: 'Kanit'; font-size: 20px; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-save { background: linear-gradient(45deg, var(--primary-dark), var(--primary-light)); color: white; box-shadow: 0 10px 20px rgba(0,0,70,0.2); }
        .btn-save:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,70,0.3); }
        .btn-cancel { background: white; color: #636e72; border: 1px solid #e0e6ed; }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="spinner-lg"></div></div>

    <header class="page-header">
        <h1 style="font-family:'Kanit'; margin:0; font-size: 36px;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà üöÄ</h1>
        <p id="classNameDisplay" style="opacity:0.9; margin-top:10px; font-size: 18px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</p>
    </header>

    <main class="container">
        <div class="card">
            <div class="form-group">
                <label>üè∑Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label>
                <input type="text" id="missionTitle" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏∞‡∏•‡∏∏‡∏¢‡πÇ‡∏•‡∏Å‡∏™‡∏£‡∏∞‡πÑ‡∏≠">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>üíé ‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
                    <input type="number" id="rewardPoints" class="form-control" value="50">
                </div>
                <div class="form-group">
                    <label>‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                    <input type="number" id="missionTime" class="form-control" value="60">
                </div>
            </div>
        </div>

        <div class="card">
            <label style="font-family:'Kanit'; font-weight:600; font-size: 18px;">üéØ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢</label>
            <div class="template-grid">
                <div class="template-item" onclick="selectTemplate('lesson')" id="tpl_lesson">
                    <span>üìñ</span><strong>‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</strong>
                </div>
                <div class="template-item" onclick="selectTemplate('quiz')" id="tpl_quiz">
                    <span>‚ùì</span><strong>‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</strong>
                </div>
                <div class="template-item" onclick="selectTemplate('speech')" id="tpl_speech">
                    <span>üé§</span><strong>‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</strong>
                </div>
                <div class="template-item" onclick="selectTemplate('match')" id="tpl_match">
                    <span>üß©</span><strong>‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</strong>
                </div>
                <div class="template-item" onclick="selectTemplate('sort')" id="tpl_sort">
                    <span>üì¶</span><strong>‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</strong>
                </div>
                <div class="template-item" onclick="selectTemplate('fill')" id="tpl_fill">
                    <span>‚úèÔ∏è</span><strong>‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥</strong>
                </div>
            </div>

            <div id="contentEditor">
                <div style="text-align:center; padding: 40px 0;">
                    <i class="fas fa-magic" style="font-size: 40px; color: #eee; margin-bottom: 15px;"></i>
                    <p style="color:#999;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö</p>
                </div>
            </div>
        </div>

        <div class="footer-actions">
            <button class="btn-main btn-cancel" onclick="history.back()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn-main btn-save" onclick="saveMission()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚ú®</button>
        </div>
    </main>

    <script>
        const currentClassId = new URLSearchParams(window.location.search).get('cid') || new URLSearchParams(window.location.search).get('id');
        let selectedType = '';

        document.addEventListener('DOMContentLoaded', async () => {
            if(!currentClassId) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'); location.href='teacher-dashboard.html'; return; }
            
            const { data: cls } = await sysDB.from('classrooms').select('*').eq('classroom_id', currentClassId).single();
            if(cls) document.getElementById('classNameDisplay').innerText = `‡∏ß‡∏¥‡∏ä‡∏≤ ${cls.subject_name} (${cls.room_name})`;
            
            document.getElementById('loadingOverlay').style.display = 'none';
        });

        function selectTemplate(type) {
            selectedType = type;
            document.querySelectorAll('.template-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tpl_' + type).classList.add('active');
            renderEditor();
        }

        function renderEditor() {
            const editor = document.getElementById('contentEditor');
            let html = '';

            switch(selectedType) {
                case 'lesson':
                    html = `<label>üé¨ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ù‡∏±‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)</label><textarea id="l_body" class="form-control" rows="6" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>`;
                    break;
                case 'quiz':
                    html = `<div id="quiz_area"></div><button class="btn-add-item" onclick="addItem('quiz')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</button>`;
                    break;
                case 'speech':
                    html = `<div id="speech_area"></div><button class="btn-add-item" onclick="addItem('speech')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô</button>`;
                    break;
                case 'match':
                    html = `<div id="match_area"></div><button class="btn-add-item" onclick="addItem('match')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á</button>`;
                    break;
                case 'sort':
                    html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                                <input type="text" id="cat1" class="form-control" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà 1 (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≥‡∏ô‡∏≤‡∏°)">
                                <input type="text" id="cat2" class="form-control" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà 2 (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≥‡∏Å‡∏£‡∏¥‡∏¢‡∏≤)">
                            </div><div id="sort_area"></div><button class="btn-add-item" onclick="addItem('sort')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å</button>`;
                    break;
                case 'fill':
                    html = `<label>üìù ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡πâ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (‡πÉ‡∏ä‡πâ __ ‡πÅ‡∏ó‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)</label><textarea id="f_text" class="form-control" rows="3" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏â‡∏±‡∏ô‡πÑ‡∏õ__‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢__"></textarea>
                            <label style="margin-top:15px;">‚úÖ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤)</label><input type="text" id="f_ans" class="form-control" placeholder="‡∏ó‡∏µ‡πà, ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå">`;
                    break;
            }
            editor.innerHTML = html;
            if(['quiz','speech','match','sort'].includes(selectedType)) addItem(selectedType);
        }

        function addItem(type) {
            const container = document.getElementById(type + '_area');
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `<i class="fas fa-times-circle btn-remove" onclick="this.parentElement.remove()"></i>`;
            
            if(type === 'quiz') {
                div.innerHTML += `<input type="text" class="form-control q-title" placeholder="‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°" style="margin-bottom:10px;">
                                  <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                    <input type="text" class="form-control q-ok" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å ‚úÖ">
                                    <input type="text" class="form-control q-no" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î ‚ùå">
                                  </div>`;
            } else if(type === 'speech') {
                div.innerHTML += `<input type="text" class="form-control s-text" placeholder="‡∏Ñ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πá‡∏Å‡∏û‡∏π‡∏î">`;
            } else if(type === 'match') {
                div.innerHTML += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                    <input type="text" class="form-control m-key" placeholder="‡∏ã‡πâ‡∏≤‡∏¢">
                                    <input type="text" class="form-control m-val" placeholder="‡∏Ç‡∏ß‡∏≤">
                                  </div>`;
            } else if(type === 'sort') {
                div.innerHTML += `<div style="display:grid; grid-template-columns:1.5fr 1fr; gap:10px;">
                                    <input type="text" class="form-control r-text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á/‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå">
                                    <select class="form-control r-cat"><option value="1">‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà 1</option><option value="2">‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà 2</option></select>
                                  </div>`;
            }
            container.appendChild(div);
        }

        async function saveMission() {
            const title = document.getElementById('missionTitle').value;
            const points = parseInt(document.getElementById('rewardPoints').value);
            if(!title || !selectedType) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö üòä');

            let contentData = {};
            if(selectedType === 'lesson') {
                contentData = { text: document.getElementById('l_body').value };
            } else if(selectedType === 'quiz') {
                contentData = Array.from(document.querySelectorAll('.dynamic-item')).map(item => ({
                    q: item.querySelector('.q-title').value,
                    ok: item.querySelector('.q-ok').value,
                    no: item.querySelector('.q-no').value
                }));
            } else if(selectedType === 'speech') {
                contentData = Array.from(document.querySelectorAll('.s-text')).map(el => el.value);
            } else if(selectedType === 'match') {
                contentData = Array.from(document.querySelectorAll('.dynamic-item')).map(item => ({
                    k: item.querySelector('.m-key').value, v: item.querySelector('.m-val').value
                }));
            } else if(selectedType === 'sort') {
                contentData = {
                    cats: [document.getElementById('cat1').value, document.getElementById('cat2').value],
                    items: Array.from(document.querySelectorAll('.dynamic-item')).map(item => ({
                        t: item.querySelector('.r-text').value, c: item.querySelector('.r-cat').value
                    }))
                };
            } else if(selectedType === 'fill') {
                contentData = { text: document.getElementById('f_text').value, ans: document.getElementById('f_ans').value.split(',').map(s => s.trim()) };
            }

            document.getElementById('loadingOverlay').style.display = 'flex';
            const { error } = await sysDB.from('missions').insert({
                classroom_id: currentClassId,
                title: title,
                mission_type: selectedType,
                content_data: contentData,
                reward_points: points,
                order_index: Date.now() // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á
            });

            if(!error) {
                alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡πÑ‡∏õ‡∏•‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢ üéâ');
                location.href = `classroom-detail.html?id=${currentClassId}`;
            } else {
                alert('‡∏≠‡∏∏‡πä‡∏õ‡∏™‡πå! ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
    </script>
</body>
</html>
