<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mission Creator - FlipSchool</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body{margin:0;font-family:Sarabun, sans-serif;background:#f2f4f7;color:#333;}
        header{background:linear-gradient(135deg,#141e30,#243b55);color:#fff;text-align:center;padding:40px 20px;border-radius:0 0 40px 40px;}
        main{max-width:1200px;margin:-30px auto 40px;padding:0 20px;display:grid;grid-template-columns:1fr 420px;gap:25px}
        @media(max-width:1024px){main{grid-template-columns:1fr}}
        .card{background:#fff;border-radius:25px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,.06);margin-bottom:20px}
        label{font-family:Kanit;font-size:14px;font-weight:500;}
        input,textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;box-sizing:border-box;margin-top:6px;font-family:inherit;}
        button{border:none;border-radius:12px;padding:12px;background:#8e44ad;color:#fff;font-family:Kanit;cursor:pointer;margin-top:10px;width:100%;transition: 0.3s;}
        button.secondary{background:#34495e}
        .status{display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:10px}
        .dot{width:10px;height:10px;border-radius:50%;background:#bbb}
        .dot.on{background:#2ecc71;box-shadow:0 0 6px #2ecc71}
        .phone{background:#111;border-radius:45px;padding:12px;height:620px;position:sticky;top:20px;border: 4px solid #333;}
        .screen{background:#fff;border-radius:35px;height:100%;display:flex;flex-direction:column;padding:20px;overflow: hidden;}
        .quiz-q{font-family:Kanit;font-size:18px;margin-bottom:20px;}
        .choice{padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:10px;cursor:pointer;font-weight: 500;}
        .footer{margin-top:auto;font-size:13px;color:#888;text-align:center;}
        pre{background:#fafafa;padding:15px;border-radius:12px;font-size:12px;max-height:260px;overflow:auto;border: 1px solid #eee;}
        #loadingOverlay{position: fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:none;align-items:center;justify-content:center;z-index:9999;}
        .spinner {width: 40px;height: 40px;border: 4px solid #f3f3f3;border-top: 4px solid #8e44ad;border-radius: 50%;animation: spin 1s linear infinite;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>
<div id="loadingOverlay"><div class="spinner"></div></div>

<header>
    <h1 style="font-family:Kanit;margin:0">AI Mission Creator üöÄ</h1>
    <p>FlipSchool Smart Designer (Stable Version)</p>
</header>

<main>
    <section>
        <div class="card">
            <div class="status">
                <div id="dot" class="dot"></div>
                <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
            </div>
            <label>üîë Gemini API Key</label>
            <input type="password" id="geminiKey" placeholder="AIzaSy...">
            <button onclick="testAndSaveKey()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
        </div>

        <div class="card">
            <label>ü§ñ ‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö v1beta)</label>
            <select id="modelSelect">
                <option value="gemini-1.5-flash">gemini-1.5-flash (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ - ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)</option>
                <option value="gemini-1.5-pro">gemini-1.5-pro (‡∏â‡∏•‡∏≤‡∏î‡∏°‡∏≤‡∏Å)</option>
                <option value="gemini-2.0-flash-exp">gemini-2.0-flash (‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</option>
            </select>
        </div>

        <div class="card">
            <label>üí° ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label>
            <textarea id="aiPrompt" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ß‡∏±‡∏è‡∏à‡∏±‡∏Å‡∏£‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥ ‡∏õ.4"></textarea>
            <button onclick="generateByAI()" style="background: #243b55;">‚ú® ‡∏™‡∏±‡πà‡∏á AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
        </div>

        <div class="card">
            <label>üì¶ JSON Data</label>
            <div id="dataEditor"></div>
        </div>
    </section>

    <aside>
        <div class="phone">
            <div class="screen" id="preview">
                <div class="footer">‡∏£‡∏≠‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...</div>
            </div>
        </div>
        <button id="saveBtn" onclick="saveMissionToDB()" style="margin-top:20px; background:#2ecc71; display:none;">
            <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </button>
    </aside>
</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
let teacherProfile = null;
let generatedData = null;

// ================= 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏≤‡∏Å DB =================
document.addEventListener("DOMContentLoaded", async () => {
    const { data: { user } } = await sysDB.auth.getUser();
    if (!user) return window.location.href = 'teacher-login.html';

    const { data: profile } = await sysDB.from('teachers').select('*').eq('teacher_id', user.id).single();
    teacherProfile = profile;

    if (profile && profile.gemini_key) {
        document.getElementById('geminiKey').value = profile.gemini_key;
        updateStatusUI(true, "‡πÉ‡∏ä‡πâ API Key ‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
    } else {
        updateStatusUI(false, "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    }
    document.getElementById('loadingOverlay').style.display = 'none';
});

function updateStatusUI(on, text) {
    document.getElementById('dot').className = on ? 'dot on' : 'dot';
    document.getElementById('statusText').textContent = text;
}

// ================= 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ñ‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏á DB =================
async function testAndSaveKey() {
    const key = document.getElementById('geminiKey').value.trim();
    if (!key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å API Key");

    document.getElementById('loadingOverlay').style.display = 'flex';
    try {
        const res = await fetch(`${API_BASE}/models/gemini-1.5-flash?key=${key}`);
        const json = await res.json();
        if (json.error) throw new Error(json.error.message);

        updateStatusUI(true, "API Key ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úî");

        // ‡∏ñ‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏≤‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
        if (!teacherProfile || teacherProfile.gemini_key !== key) {
            if (confirm("‚úÖ ‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ! ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå FlipSchool ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                await sysDB.from('teachers').update({ gemini_key: key }).eq('teacher_id', teacherProfile.teacher_id);
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            }
        }
    } catch (e) {
        updateStatusUI(false, "‡∏Ñ‡∏µ‡∏¢‡πå‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‚ùå");
        alert("‚ùå Error: " + e.message);
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

// ================= 3. ‡∏™‡∏±‡πà‡∏á AI ‡πÄ‡∏à‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡πÅ‡∏•‡∏∞ Prompt) =================
async function generateByAI() {
    const key = document.getElementById('geminiKey').value.trim();
    const model = document.getElementById('modelSelect').value;
    const prompt = document.getElementById('aiPrompt').value.trim();

    if (!key || !prompt) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");
    document.getElementById('loadingOverlay').style.display = 'flex';

    // ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô v1beta
    const url = `${API_BASE}/models/${model}:generateContent?key=${key}`;
    const instruction = `‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô: [{"q":"‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°","ok":"‡∏Ç‡πâ‡∏≠‡∏ñ‡∏π‡∏Å","no":"‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î"}] ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${prompt}`;

    try {
        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: instruction }] }] })
        });

        const json = await res.json();
        if (json.error) throw new Error(json.error.message);

        let text = json.candidates[0].content.parts[0].text;
        generatedData = JSON.parse(text.replace(/```json|```/g, "").trim());

        document.getElementById('dataEditor').innerHTML = `<pre>${JSON.stringify(generatedData, null, 2)}</pre>`;
        document.getElementById('saveBtn').style.display = 'block';
        renderPreview();
    } catch (e) {
        alert("‚ùå AI ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: " + e.message);
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function renderPreview() {
    const q = generatedData[0];
    document.getElementById('preview').innerHTML = `
        <div class="quiz-q">1. ${q.q}</div>
        <div class="choice">${q.ok}</div>
        <div class="choice">${q.no}</div>
        <div class="footer">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1</div>
    `;
}

async function saveMissionToDB() {
    const cid = new URLSearchParams(window.location.search).get('cid');
    if(!cid) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
    
    const { error } = await sysDB.from('missions').insert([{
        classroom_id: cid,
        mission_data: generatedData,
        title: document.getElementById('aiPrompt').value
    }]);

    if (!error) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üéâ");
        window.location.href = `classroom-detail.html?id=${cid}`;
    }
}
</script>
</body>
</html>
