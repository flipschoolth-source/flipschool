<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlipSchool AI - Stable Designer</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script src="js/supabase-db.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root { --primary: #141e30; --accent: #8e44ad; --bg: #f8f9fb; }
    body { margin:0; font-family:Sarabun; background:var(--bg); color:#333; }
    header { background:linear-gradient(135deg,#141e30,#243b55); color:#fff; text-align:center; padding:30px 20px 60px; border-radius:0 0 50px 50px; }
    main { max-width:1200px; margin:-40px auto 40px; padding:0 20px; display:grid; grid-template-columns: 1fr 400px; gap:25px; }
    @media(max-width:1024px){ main{ grid-template-columns:1fr; } }
    
    .card { background:#fff; border-radius:30px; padding:25px; box-shadow:0 15px 35px rgba(0,0,0,.08); margin-bottom:20px; }
    label { font-family:Kanit; font-weight:500; margin-bottom:10px; display:block; }
    input, textarea { width:100%; padding:15px; border-radius:15px; border:1px solid #ddd; box-sizing:border-box; font-family:inherit; }
    
    button { border:none; border-radius:15px; padding:15px; background:var(--accent); color:#fff; font-family:Kanit; cursor:pointer; font-size:16px; width:100%; transition:0.3s; display:flex; align-items:center; justify-content:center; gap:10px; }
    button:hover { transform:translateY(-2px); filter:brightness(1.1); }
    
    /* API Status Area */
    .status-container { display:flex; align-items:center; justify-content:space-between; margin-bottom:15px; background:#f0f2f5; padding:10px 15px; border-radius:12px; }
    .dot { width:10px; height:10px; border-radius:50%; background:#bbb; transition:0.3s; }
    .dot.on { background:#2ecc71; box-shadow:0 0 10px #2ecc71; }

    /* Canvas (Phone Mockup) */
    .phone { background:#111; border-radius:50px; padding:12px; height:680px; position:sticky; top:20px; border: 4px solid #333; }
    .screen { background:#fff; border-radius:40px; height:100%; overflow:hidden; position:relative; }
    iframe { width: 100%; height: 100%; border:none; background:#fff; }

    #loadingOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; align-items:center; justify-content:center; z-index:9999; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div></div>

<header>
    <h1 style="font-family:Kanit;margin:0">AI Magic Designer ‚ú®</h1>
    <p>Stable Edition (v1beta Optimized)</p>
</header>

<main>
    <section>
        <div class="card">
            <div class="status-container">
                <div><span id="dot" class="dot"></span> <small id="statusText">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API...</small></div>
                <button onclick="checkKeyAndSave()" style="width:auto; padding:5px 15px; font-size:12px; margin:0; background:#34495e;">‡πÄ‡∏ä‡πá‡∏Ñ & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå</button>
            </div>
            <label>üîë Gemini API Key</label>
            <input type="password" id="geminiKey" placeholder="‡∏ß‡∏≤‡∏á API Key (AIzaSy...)">
        </div>

        <div class="card">
            <label>üé® ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
            <textarea id="aiPrompt" rows="5" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏ß‡∏±‡∏è‡∏à‡∏±‡∏Å‡∏£‡∏ô‡πâ‡∏≥ ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏™‡∏ß‡∏¢‡πÜ ‡∏î‡πâ‡∏ß‡∏¢ Tailwind CSS"></textarea>
            <button onclick="createMagicContent()" style="margin-top:20px;">
                <i class="fas fa-wand-magic-sparkles"></i> ‡∏£‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏™‡∏∑‡πà‡∏≠ Interactive
            </button>
        </div>
    </section>

    <aside>
        <div class="phone">
            <div class="screen">
                <iframe id="previewFrame" srcdoc="<body style='display:flex;justify-content:center;align-items:center;height:90vh;font-family:sans-serif;color:#ccc;text-align:center;'><div>‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div></body>"></iframe>
            </div>
        </div>
    </aside>
</main>

<script>
// --- CONFIG & CONSTANTS ---
const API_URL = "https://generativelanguage.googleapis.com/v1beta";
const TARGET_MODEL = "gemini-1.5-flash-latest"; // ‡∏•‡πá‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
let teacherProfile = null;

// --- INITIALIZE ---
document.addEventListener("DOMContentLoaded", async () => {
    const { data: { user } } = await sysDB.auth.getUser();
    if (!user) return window.location.href = 'teacher-login.html';

    const { data: profile } = await sysDB.from('teachers').select('*').eq('teacher_id', user.id).single();
    teacherProfile = profile;

    if (profile?.gemini_key) {
        document.getElementById('geminiKey').value = profile.gemini_key;
        updateStatus(true, "API Key ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
    }
});

function updateStatus(ok, text) {
    document.getElementById('dot').className = ok ? 'dot on' : 'dot';
    document.getElementById('statusText').textContent = text;
}

// --- üõ† CHECK KEY BY GENERATE (Best Practice) ---
async function checkKeyAndSave() {
    const key = document.getElementById('geminiKey').value.trim();
    if(!key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å API Key");

    document.getElementById('loadingOverlay').style.display = 'flex';
    try {
        // ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á Ping ‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Key ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏° (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ models.list)
        const response = await fetch(`${API_URL}/models/${TARGET_MODEL}:generateContent?key=${key}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: "hi" }] }] })
        });
        
        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        updateStatus(true, "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        
        // ‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        if (confirm("‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô! ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå FlipSchool ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏ß‡∏£‡πÑ‡∏´‡∏°?")) {
            await sysDB.from('teachers').update({ gemini_key: key }).eq('teacher_id', teacherProfile.teacher_id);
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        }
    } catch (e) {
        alert("‚ùå Error: " + e.message);
        updateStatus(false, "‡∏Ñ‡∏µ‡∏¢‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÄ‡∏ï‡πá‡∏°");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

// --- üöÄ MAGIC GENERATE (Canvas Mode) ---
async function createMagicContent() {
    const key = document.getElementById('geminiKey').value.trim();
    const prompt = document.getElementById('aiPrompt').value.trim();
    const iframe = document.getElementById('previewFrame');

    if (!prompt || !key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö");

    document.getElementById('loadingOverlay').style.display = 'flex';
    iframe.srcdoc = "<body style='display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô...</h3></body>";

    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö URL ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô models/ ‡∏ã‡πâ‡∏≠‡∏ô
    const endpoint = `${API_URL}/models/${TARGET_MODEL}:generateContent?key=${key}`;

    const instruction = `
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Web Designer ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ HTML ‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô 1 ‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: "${prompt}"
    ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç:
    1. ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ CODE HTML ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Single File) ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ Markdown backticks
    2. ‡πÉ‡∏ä‡πâ Tailwind CSS CDN ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    3. ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô Interactive (‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î, ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô JS)
    4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Thai language support)
    `;

    try {
        const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: instruction }] }] })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);

        let code = data.candidates[0].content.parts[0].text;
        // ‡∏•‡πâ‡∏≤‡∏á Markdown ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        code = code.replace(/```html|```/g, "").trim();
        
        // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡∏á Iframe (Canvas)
        iframe.srcdoc = code;

    } catch (e) {
        alert("‚ùå AI ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: " + e.message);
        iframe.srcdoc = "<body>Error: " + e.message + "</body>";
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}
</script>
</body>
</html>
