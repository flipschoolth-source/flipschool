<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AI Mission Designer - FlipSchool</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root { 
    --primary: #00008B; --primary-light: #0052D4; --ai-glow: #8e44ad;
    --bg: #f0f2f5; --white: #ffffff;
}
body { margin:0; font-family: 'Sarabun', sans-serif; background: var(--bg); }
header {
    background: linear-gradient(135deg, #000046, var(--primary-light));
    color: #fff; text-align: center; padding: 40px 20px;
    border-radius: 0 0 40px 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
main {
    max-width: 1200px; margin: -30px auto 40px; padding: 0 20px;
    display: grid; grid-template-columns: 1fr 420px; gap: 25px;
}
@media(max-width:1024px){ main { grid-template-columns: 1fr; } }

.card {
    background: #fff; border-radius: 25px; padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,.05); margin-bottom: 20px;
    border: 1px solid rgba(0,0,0,0.03);
}
label { font-family: 'Kanit'; font-weight: 500; display: block; margin-bottom: 8px; color: #444; }
input, textarea, select {
    width: 100%; padding: 12px; border-radius: 12px;
    border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; transition: 0.3s;
}
input:focus, textarea:focus { border-color: var(--ai-glow); outline: none; }

button {
    border: none; border-radius: 12px; padding: 14px;
    background: var(--ai-glow); color: #fff;
    font-family: Kanit; cursor: pointer; margin-top: 10px; width: 100%;
    font-size: 16px; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
}
button:hover { opacity: 0.9; transform: translateY(-2px); }
button.secondary { background: #34495e; }

.status { display: flex; align-items: center; gap: 8px; font-size: 13px; margin-bottom: 15px; }
.dot { width: 12px; height: 12px; border-radius: 50%; background: #bbb; transition: 0.3s; }
.dot.on { background: #2ecc71; box-shadow: 0 0 10px #2ecc71; }

.phone {
    background: #111; border-radius: 45px; padding: 15px;
    height: 650px; position: sticky; top: 20px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
}
.screen {
    background: #fff; border-radius: 35px; height: 100%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; padding: 25px; box-sizing: border-box; overflow: hidden;
}
pre {
    background: #2d3436; color: #fab1a0; padding: 15px; border-radius: 12px;
    font-size: 12px; max-height: 250px; overflow: auto; text-align: left;
}
#loadingOverlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(255,255,255,0.8); display:none;
    align-items:center; justify-content:center; z-index:9999;
}
.spinner {
    width: 50px; height: 50px; border: 5px solid #eee;
    border-top-color: var(--ai-glow); border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div></div>

<header>
<h1 style="font-family:Kanit; margin:0">AI Mission Designer üöÄ</h1>
<p>FlipSchool x Google Gemini Pro & Flash</p>
</header>

<main>
    <section>
        <div class="card">
            <div class="status">
                <div id="dot" class="dot"></div>
                <span id="statusText" style="font-weight: 600; color: #666;">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API...</span>
            </div>

            <label><i class="fa-solid fa-key"></i> Gemini API Key</label>
            <div style="display: flex; gap: 8px;">
                <input type="password" id="geminiKey" placeholder="AIzaSy...">
                <button onclick="testApiKey()" style="margin:0; width: auto; padding: 10px 20px;">‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
            </div>
            <button class="secondary" onclick="listModels()"><i class="fa-solid fa-list"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•</button>
        </div>

        <div class="card">
            <label><i class="fa-solid fa-robot"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</label>
            <select id="modelSelect">
                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö API Key ‡∏Å‡πà‡∏≠‡∏ô --</option>
            </select>
            <small style="display:block; margin-top:5px; color:#999;">* ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: gemini-1.5-flash ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß ‡∏´‡∏£‡∏∑‡∏≠ 1.5-pro ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏â‡∏•‡∏≤‡∏î</small>
        </div>

        <div class="card">
            <label><i class="fa-solid fa-lightbulb"></i> ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
            <textarea id="aiPrompt" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏∞‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏• ‡∏õ.4 ‡∏û‡∏£‡πâ‡∏≠‡∏° Quiz 3 ‡∏Ç‡πâ‡∏≠"></textarea>
            <button onclick="generateByAI()"><i class="fa-solid fa-wand-magic-sparkles"></i> ‡∏™‡∏±‡πà‡∏á AI ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
        </div>

        <div class="card">
            <label><i class="fa-solid fa-code"></i> JSON Output (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö)</label>
            <div id="dataEditor"><p style="color:#aaa; text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>
        </div>
    </section>

    <aside>
        <div class="phone">
            <div class="screen" id="preview">
                <i class="fa-solid fa-mobile-screen-button" style="font-size: 50px; color: #eee; margin-bottom: 15px;"></i>
                <p style="color:#aaa">Live Preview <br>‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
            </div>
        </div>
        <button style="background: var(--primary); margin-top: 15px;" onclick="saveToSupabase()">
            <i class="fa-solid fa-cloud-arrow-up"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
    </aside>
</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";

document.addEventListener("DOMContentLoaded", () => {
    const savedKey = localStorage.getItem("gemini_api_key");
    if(savedKey) {
        document.getElementById('geminiKey').value = savedKey;
        // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏µ‡∏¢‡πå
        listModels();
    }
});

/* ---------------- API KEY TEST & MODELS LIST ---------------- */
async function testApiKey() {
    const key = document.getElementById('geminiKey').value;
    if(!key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key");

    document.getElementById('loadingOverlay').style.display = 'flex';
    try {
        const res = await fetch(`${API_BASE}/models?key=${key}`);
        const json = await res.json();
        
        if(json.error) throw new Error(json.error.message);

        document.getElementById('dot').classList.add("on");
        document.getElementById('statusText').textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        document.getElementById('statusText').style.color = "#2ecc71";
        
        localStorage.setItem("gemini_api_key", key);
        alert("‚úÖ API Key ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
        listModels(); // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢

    } catch(e) {
        document.getElementById('dot').classList.remove("on");
        document.getElementById('statusText').textContent = "Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
        document.getElementById('statusText').style.color = "#e74c3c";
        alert("‚ùå Error: " + e.message);
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

async function listModels() {
    const key = document.getElementById('geminiKey').value;
    if(!key) return;

    try {
        const res = await fetch(`${API_BASE}/models?key=${key}`);
        const json = await res.json();
        
        const select = document.getElementById("modelSelect");
        select.innerHTML = "";

        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
        const usable = json.models.filter(m => 
            m.supportedGenerationMethods.includes("generateContent")
        );

        usable.forEach(m => {
            const opt = document.createElement("option");
            const mName = m.name.replace("models/", "");
            opt.value = mName;
            opt.textContent = mName;
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Default ‡πÄ‡∏õ‡πá‡∏ô gemini-1.5-flash
            if(mName === 'gemini-1.5-flash') opt.selected = true;
            select.appendChild(opt);
        });

        if(usable.length > 0) {
            document.getElementById('dot').classList.add("on");
            document.getElementById('statusText').textContent = "API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (" + usable.length + " ‡πÇ‡∏°‡πÄ‡∏î‡∏•)";
        }
    } catch(e) {
        console.error("Models List Error:", e);
    }
}

/* ---------------- GENERATE CONTENT ---------------- */
async function generateByAI() {
    const key = document.getElementById('geminiKey').value;
    const prompt = document.getElementById('aiPrompt').value;
    const model = document.getElementById('modelSelect').value;

    if(!prompt) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à");
    if(!model) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö API Key ‡∏Å‡πà‡∏≠‡∏ô)");

    document.getElementById('loadingOverlay').style.display = 'flex';

    const instruction = `‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô)
‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Quiz 3 ‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: "${prompt}"
‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON:
[
  {"q":"‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°","ok":"‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å","no":"‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î"}
]`;

    try {
        const res = await fetch(
            `${API_BASE}/models/${model}:generateContent?key=${key}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: instruction }] }]
                })
            }
        );

        const json = await res.json();
        if(json.error) throw new Error(json.error.message);

        let text = json.candidates[0].content.parts[0].text;
        // ‡∏•‡πâ‡∏≤‡∏á Markdown Code Block
        text = text.replace(/```json|```/g, "").trim();
        
        const data = JSON.parse(text);

        document.getElementById('dataEditor').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Preview ‡∏Ç‡πâ‡∏≠‡πÅ‡∏£‡∏Å
        document.getElementById('preview').innerHTML = `
            <div style="width:100%">
                <div style="background:var(--primary); color:#white; padding:15px; border-radius:15px; margin-bottom:15px;">
                    <h3 style="margin:0; color:white;">${data[0].q}</h3>
                </div>
                <button style="background:#fff; color:#333; border:2px solid #eee;">${data[0].ok}</button>
                <button style="background:#fff; color:#333; border:2px solid #eee; margin-top:8px;">${data[0].no}</button>
                <p style="margin-top:20px; font-size:12px; color:#666;">(‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1 ‡∏à‡∏≤‡∏Å 3)</p>
            </div>
        `;

    } catch(e) {
        alert("‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + e.message);
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function saveToSupabase() {
    alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Supabase... (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ supabase ‡∏à‡∏≤‡∏Å supabase-db.js)");
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á:
    // await supabase.from('missions').insert([{ content: generatedData }]);
}
</script>

</body>
</html>
