<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Mission Designer - FlipSchool</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Sarabun;background:#f0f2f5}
header{
  background:linear-gradient(135deg,#000046,#0052D4);
  color:#fff;text-align:center;padding:40px 20px;
  border-radius:0 0 40px 40px
}
main{
  max-width:1200px;margin:-30px auto 40px;padding:0 20px;
  display:grid;grid-template-columns:1fr 420px;gap:25px
}
@media(max-width:1024px){main{grid-template-columns:1fr}}
.card{
  background:#fff;border-radius:25px;padding:25px;
  box-shadow:0 10px 30px rgba(0,0,0,.05);margin-bottom:20px
}
input,textarea,select{
  width:100%;padding:12px;border-radius:12px;
  border:1px solid #ddd;box-sizing:border-box
}
button{
  border:none;border-radius:12px;padding:12px;
  background:#8e44ad;color:#fff;
  font-family:Kanit;cursor:pointer;margin-top:10px;width:100%
}
button.secondary{background:#34495e}
.status{display:flex;align-items:center;gap:8px;font-size:13px}
.dot{width:10px;height:10px;border-radius:50%;background:#bbb}
.dot.on{background:#2ecc71;box-shadow:0 0 6px #2ecc71}
.phone{
  background:#111;border-radius:40px;padding:12px;
  height:600px;position:sticky;top:20px
}
.screen{
  background:#fff;border-radius:30px;height:100%;
  display:flex;align-items:center;justify-content:center;
  text-align:center;padding:20px
}
pre{
  background:#fafafa;padding:15px;border-radius:12px;
  font-size:12px;max-height:300px;overflow:auto
}
small{color:#888}
</style>
</head>

<body>

<header>
<h1 style="font-family:Kanit;margin:0">AI Mission Designer üöÄ</h1>
<p>Gemini API (‡∏û‡∏£‡πâ‡∏≠‡∏° models.list)</p>
</header>

<main>

<section>

<div class="card">
  <div class="status">
    <div id="dot" class="dot"></div>
    <span id="statusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API</span>
  </div>

  <label>üîë Gemini API Key</label>
  <input type="password" id="geminiKey" placeholder="‡∏ß‡∏≤‡∏á API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">

  <button onclick="testApiKey()">Test API Key</button>
  <button class="secondary" onclick="listModels()">üìã List Models</button>

  <small>
    * ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
  </small>
</div>

<div class="card">
  <label>ü§ñ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•</label>
  <select id="modelSelect"></select>
</div>

<div class="card">
  <label>üí° ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label>
  <textarea id="aiPrompt" rows="3"
    placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å 5 ‡∏ä‡∏ô‡∏¥‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"></textarea>
  <button onclick="generateByAI()">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏î‡πâ‡∏ß‡∏¢ AI</button>
</div>

<div class="card">
  <label>üì¶ JSON Output</label>
  <div id="dataEditor"><p style="color:#aaa">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>
</div>

</section>

<aside>
<div class="phone">
<div class="screen" id="preview">
<p style="color:#aaa">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‚Ä¶</p>
</div>
</div>
</aside>

</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";

document.addEventListener("DOMContentLoaded",()=>{
  const savedKey = localStorage.getItem("gemini_api_key");
  if(savedKey) geminiKey.value = savedKey;
});

/* ---------------- API KEY TEST ---------------- */
async function testApiKey(){
  const key = geminiKey.value;
  if(!key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key");

  try{
    const res = await fetch(`${API_BASE}/models?key=${key}`);
    const json = await res.json();
    if(json.error) throw new Error(json.error.message);

    dot.classList.add("on");
    statusText.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    localStorage.setItem("gemini_api_key",key);
    alert("‚úÖ API Key ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ");

  }catch(e){
    dot.classList.remove("on");
    statusText.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    alert("‚ùå " + e.message);
  }
}

/* ---------------- MODELS.LIST ---------------- */
async function listModels(){
  const key = geminiKey.value;
  if(!key) return alert("‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô");

  try{
    const res = await fetch(`${API_BASE}/models?key=${key}`);
    const json = await res.json();
    if(json.error) throw new Error(json.error.message);

    const select = document.getElementById("modelSelect");
    select.innerHTML = "";

    const usable = json.models.filter(m =>
      m.supportedGenerationMethods &&
      m.supportedGenerationMethods.includes("generateContent")
    );

    usable.forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m.name.replace("models/","");
      opt.textContent = m.name.replace("models/","");
      select.appendChild(opt);
    });

    if(usable.length){
      alert(`‚úÖ ‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ${usable.length} ‡∏£‡∏∏‡πà‡∏ô`);
    }else{
      alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö generateContent");
    }

  }catch(e){
    alert("‚ùå " + e.message);
  }
}

/* ---------------- GENERATE CONTENT ---------------- */
async function generateByAI(){
  const key = geminiKey.value;
  const prompt = aiPrompt.value;
  const model = modelSelect.value;

  if(!key || !prompt || !model)
    return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");

  const instruction = `
‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
‡∏™‡∏£‡πâ‡∏≤‡∏á Quiz 3 ‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "${prompt}"
‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
[
 {"q":"‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°","ok":"‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å","no":"‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î"}
]
`;

  try{
    const res = await fetch(
      `${API_BASE}/models/${model}:generateContent?key=${key}`,
      {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          contents:[{parts:[{text:instruction}]}]
        })
      }
    );

    const json = await res.json();
    if(json.error) throw new Error(json.error.message);

    let text = json.candidates[0].content.parts[0].text;
    text = text.replace(/```json|```/g,"").trim();
    const data = JSON.parse(text);

    dataEditor.innerHTML =
      `<pre>${JSON.stringify(data,null,2)}</pre>`;

    preview.innerHTML = `
      <div>
        <h3>${data[0].q}</h3>
        <button>${data[0].ok}</button>
      </div>
    `;

  }catch(e){
    alert("‚ùå " + e.message);
  }
}
</script>

</body>
</html>
