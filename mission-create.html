<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Magic Canvas Creator - FlipSchool</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #141e30; --accent: #8e44ad; --bg: #f8f9fb; }
        body { margin:0; font-family:Sarabun; background:var(--bg); color:#333; }
        header { background:linear-gradient(135deg,#141e30,#243b55); color:#fff; text-align:center; padding:30px 20px 60px; border-radius:0 0 50px 50px; }
        main { max-width:1300px; margin:-40px auto 40px; padding:0 20px; display:grid; grid-template-columns: 1fr 450px; gap:25px; }
        @media(max-width:1024px){ main{ grid-template-columns:1fr; } }

        .card { background:#fff; border-radius:30px; padding:25px; box-shadow:0 15px 35px rgba(0,0,0,.08); margin-bottom:20px; }
        label { font-family:Kanit; font-weight:500; margin-bottom:10px; display:block; }
        input, textarea, select { width:100%; padding:15px; border-radius:15px; border:1px solid #ddd; box-sizing:border-box; font-family:inherit; margin-bottom:10px; }
        
        button { border:none; border-radius:15px; padding:15px; background:var(--accent); color:#fff; font-family:Kanit; cursor:pointer; font-size:16px; width:100%; transition:0.3s; display:flex; align-items:center; justify-content:center; gap:10px; }
        button:hover { transform:translateY(-2px); filter:brightness(1.1); }
        
        /* Canvas Preview (Phone Mockup) */
        .phone { background:#111; border-radius:55px; padding:15px; height:750px; position:sticky; top:20px; border: 5px solid #333; box-shadow: 0 30px 60px rgba(0,0,0,0.2); }
        .screen { background:#fff; border-radius:40px; height:100%; overflow:hidden; position:relative; }
        iframe { width: 100%; height: 100%; border:none; }

        .api-status { display:flex; align-items:center; gap:8px; font-size:12px; margin-bottom:15px; font-weight:600; }
        .dot { width:10px; height:10px; border-radius:50%; background:#bbb; }
        .dot.on { background:#2ecc71; box-shadow:0 0 10px #2ecc71; }

        #loadingOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; align-items:center; justify-content:center; z-index:9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div></div>

<header>
    <h1 style="font-family:Kanit;margin:0">AI Magic Canvas üöÄ</h1>
    <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô Interactive ‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</p>
</header>

<main>
    <section>
        <div class="card">
            <div class="api-status">
                <div id="dot" class="dot"></div>
                <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...</span>
            </div>
            <label>üîë Gemini API Key</label>
            <div style="display:flex; gap:10px;">
                <input type="password" id="geminiKey" placeholder="‡∏ß‡∏≤‡∏á API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
                <button onclick="testAndSaveKey()" style="width:auto; padding:0 20px; background:#34495e;">‡∏ó‡∏î‡∏™‡∏≠‡∏ö & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>

        <div class="card">
            <label>ü§ñ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•</label>
            <select id="modelSelect">
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (‡πÄ‡∏£‡πá‡∏ß/‡∏ü‡∏£‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞)</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro (‡∏â‡∏•‡∏≤‡∏î/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏á)</option>
                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</option>
            </select>
        </div>

        <div class="card">
            <label>üé® ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ AI ‡πÄ‡∏ô‡∏£‡∏°‡∏¥‡∏ï‡∏™‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£? (‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Gemini Pro)</label>
            <textarea id="aiPrompt" rows="5" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏∞ ‡∏°‡∏µ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏°‡∏∏‡∏ô‡∏£‡∏≠‡∏ö‡∏î‡∏ß‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡πÉ‡∏ä‡πâ Tailwind CSS ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"></textarea>
            <button onclick="magicGenerate()">
                <i class="fas fa-wand-magic-sparkles"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠ Interactive
            </button>
        </div>
    </section>

    <aside>
        <div class="phone">
            <div class="screen">
                <iframe id="previewFrame" srcdoc="<body style='display:flex;justify-content:center;align-items:center;height:90vh;font-family:sans-serif;color:#ccc;text-align:center;'><div>‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</div></body>"></iframe>
            </div>
        </div>
    </aside>
</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
let teacherProfile = null;

document.addEventListener("DOMContentLoaded", async () => {
    const { data: { user } } = await sysDB.auth.getUser();
    if (!user) return window.location.href = 'teacher-login.html';

    const { data: profile } = await sysDB.from('teachers').select('*').eq('teacher_id', user.id).single();
    teacherProfile = profile;

    if (profile?.gemini_key) {
        document.getElementById('geminiKey').value = profile.gemini_key;
        updateStatusUI(true, "API Key ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å DB)");
    } else {
        updateStatusUI(false, "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å API Key");
    }
});

function updateStatusUI(on, text) {
    document.getElementById('dot').className = on ? 'dot on' : 'dot';
    document.getElementById('statusText').textContent = text;
}

// ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Model Not Found ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
async function testAndSaveKey() {
    const key = document.getElementById('geminiKey').value.trim();
    if(!key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå");
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    try {
        const res = await fetch(`${API_BASE}/models?key=${key}`);
        const json = await res.json();
        if (json.error) throw new Error(json.error.message);

        updateStatusUI(true, "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        if (confirm("‚úÖ ‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå FlipSchool ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏ß‡∏£‡πÑ‡∏´‡∏°?")) {
            await sysDB.from('teachers').update({ gemini_key: key }).eq('teacher_id', teacherProfile.teacher_id);
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        }
    } catch (e) {
        alert("‚ùå Error: " + e.message);
        updateStatusUI(false, "‡∏Ñ‡∏µ‡∏¢‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    } finally { document.getElementById('loadingOverlay').style.display = 'none'; }
}

async function magicGenerate() {
    const key = document.getElementById('geminiKey').value.trim();
    const model = document.getElementById('modelSelect').value;
    const prompt = document.getElementById('aiPrompt').value.trim();

    if (!prompt || !key) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");

    document.getElementById('loadingOverlay').style.display = 'flex';
    const iframe = document.getElementById('previewFrame');
    iframe.srcdoc = "<body style='display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h3>‚ö° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡πà‡∏≤‡∏¢‡∏°‡∏ô‡∏ï‡∏£‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠...</h3></body>";

    // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á 'models/' ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô URL ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    const cleanModel = model.replace('models/', '');
    const endpoint = `${API_BASE}/models/${cleanModel}:generateContent?key=${key}`;

    const instruction = `‡∏™‡∏£‡πâ‡∏≤‡∏á Interactive Educational Page (Single HTML file) ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: "${prompt}" 
    - ‡πÉ‡∏ä‡πâ Tailwind CSS ‡πÑ‡∏î‡πâ 
    - ‡∏°‡∏µ‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö (JS) 
    - ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ CODE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ Markdown backticks`;

    try {
        const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: instruction }] }] })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error.message);

        let code = data.candidates[0].content.parts[0].text;
        iframe.srcdoc = code.replace(/```html|```/g, "").trim();
    } catch (e) {
        alert("‚ùå AI ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: " + e.message);
    } finally { document.getElementById('loadingOverlay').style.display = 'none'; }
}
</script>
</body>
</html>
