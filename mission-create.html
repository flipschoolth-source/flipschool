<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission Creator ‚Äì Stable Preview</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Sarabun;background:#f2f4f7}
header{
  background:linear-gradient(135deg,#141e30,#243b55);
  color:#fff;text-align:center;padding:40px 20px;
  border-radius:0 0 40px 40px
}
main{
  max-width:1200px;margin:-30px auto 40px;padding:0 20px;
  display:grid;grid-template-columns:1fr 420px;gap:25px
}
@media(max-width:1024px){main{grid-template-columns:1fr}}
.card{
  background:#fff;border-radius:25px;padding:25px;
  box-shadow:0 10px 30px rgba(0,0,0,.06);margin-bottom:20px
}
label{font-family:Kanit;font-size:14px}
input,textarea,select{
  width:100%;padding:12px;border-radius:12px;
  border:1px solid #ddd;box-sizing:border-box;margin-top:6px
}
button{
  border:none;border-radius:12px;padding:12px;
  background:#8e44ad;color:#fff;
  font-family:Kanit;cursor:pointer;margin-top:10px;width:100%
}
button.secondary{background:#34495e}
.status{display:flex;align-items:center;gap:8px;font-size:13px}
.dot{width:10px;height:10px;border-radius:50%;background:#bbb}
.dot.on{background:#2ecc71;box-shadow:0 0 6px #2ecc71}

.phone{
  background:#111;border-radius:40px;padding:12px;
  height:620px;position:sticky;top:20px
}
.screen{
  background:#fff;border-radius:30px;height:100%;
  display:flex;flex-direction:column;
  padding:20px
}
.quiz-q{font-family:Kanit;font-size:18px;margin-bottom:20px}
.choice{
  padding:12px;border-radius:12px;
  border:1px solid #ddd;margin-bottom:10px;
  cursor:pointer
}
.choice.correct{background:#eafaf1;border-color:#2ecc71}
.choice.wrong{background:#fdecea;border-color:#e74c3c}
.choice.disabled{pointer-events:none;opacity:.7}
.footer{
  margin-top:auto;font-size:13px;color:#888;text-align:center
}
pre{
  background:#fafafa;padding:15px;border-radius:12px;
  font-size:12px;max-height:260px;overflow:auto
}
</style>
</head>

<body>

<header>
<h1 style="font-family:Kanit;margin:0">AI Mission Creator üöÄ</h1>
<p>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£</p>
</header>

<main>

<section>

<div class="card">
  <div class="status">
    <div id="dot" class="dot"></div>
    <span id="statusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API Key</span>
  </div>

  <label>üîë Gemini API Key</label>
  <input type="password" id="geminiKey" placeholder="AIzaSy...">
  <button onclick="testApiKey()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö API Key</button>
  <button class="secondary" onclick="listModels()">üìã List Models</button>
</div>

<div class="card">
  <label>ü§ñ ‡πÇ‡∏°‡πÄ‡∏î‡∏•</label>
  <select id="modelSelect">
    <option value="gemini-1.5-flash-latest">gemini-1.5-flash-latest (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
  </select>
</div>

<div class="card">
  <label>üí° ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label>
  <textarea id="aiPrompt" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô Past Simple Tense"></textarea>
  <button onclick="generateByAI()">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏î‡πâ‡∏ß‡∏¢ AI</button>
</div>

<div class="card">
  <label>üì¶ JSON (‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)</label>
  <div id="dataEditor"></div>
</div>

</section>

<aside>
<div class="phone">
<div class="screen" id="preview">
  <div class="footer">‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‚Ä¶</div>
</div>
</div>
</aside>

</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
let quizData = [];
let index = 0;
let score = 0;

/* ================= API KEY TEST ================= */
async function testApiKey(){
  const key = geminiKey.value.trim();
  if(!key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key");

  try{
    const res = await fetch(
      `${API_BASE}/models/gemini-1.5-flash-latest:generateContent?key=${key}`,
      {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          contents:[{parts:[{text:"ping"}]}]
        })
      }
    );

    const json = await res.json();
    if(json.error) throw new Error(json.error.message);

    dot.classList.add("on");
    statusText.textContent = "API Key ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‚úî";
    localStorage.setItem("gemini_api_key",key);

  }catch(e){
    dot.classList.remove("on");
    statusText.textContent = "API Key ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚ùå";
    alert("‚ùå "+e.message);
  }
}

/* ================= LIST MODELS ================= */
async function listModels(){
  const key = geminiKey.value.trim();
  if(!key) return alert("‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô");

  const res = await fetch(`${API_BASE}/models?key=${key}`);
  const json = await res.json();
  if(json.error) return alert(json.error.message);

  modelSelect.innerHTML = "";
  json.models
    .filter(m=>m.supportedGenerationMethods?.includes("generateContent"))
    .forEach(m=>{
      const opt=document.createElement("option");
      opt.value=m.name.replace("models/","");
      opt.textContent=opt.value;
      modelSelect.appendChild(opt);
    });
}

/* ================= GENERATE BY AI ================= */
async function generateByAI(){
  const key = geminiKey.value.trim();
  const model = modelSelect.value;
  const prompt = aiPrompt.value.trim();
  if(!prompt) return alert("‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à");

  const instruction = `
‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
‡∏™‡∏£‡πâ‡∏≤‡∏á Quiz 3 ‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "${prompt}"
[
 {"q":"‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°","ok":"‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å","no":"‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î"}
]`;

  const res = await fetch(
    `${API_BASE}/models/${model}:generateContent?key=${key}`,
    {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        contents:[{parts:[{text:instruction}]}]
      })
    }
  );

  const json = await res.json();
  if(json.error) return alert(json.error.message);

  let text = json.candidates[0].content.parts[0].text;
  quizData = JSON.parse(text.replace(/```json|```/g,""));

  dataEditor.innerHTML = `<pre>${JSON.stringify(quizData,null,2)}</pre>`;
  startPreview();
}

/* ================= PREVIEW ENGINE ================= */
function startPreview(){
  index = 0;
  score = 0;
  renderQuestion();
}

function renderQuestion(){
  const q = quizData[index];
  preview.innerHTML = `
    <div class="quiz-q">${index+1}. ${q.q}</div>
    <div class="choice" onclick="answer(true)">${q.ok}</div>
    <div class="choice" onclick="answer(false)">${q.no}</div>
    <div class="footer">‡∏Ç‡πâ‡∏≠ ${index+1}/${quizData.length}</div>
  `;
}

function answer(correct){
  const choices = document.querySelectorAll(".choice");
  choices.forEach(c=>c.classList.add("disabled"));

  if(correct){
    score++;
    choices[0].classList.add("correct");
  }else{
    choices[1].classList.add("wrong");
    choices[0].classList.add("correct");
  }

  setTimeout(()=>{
    index++;
    index < quizData.length ? renderQuestion() : finish();
  },900);
}

function finish(){
  preview.innerHTML = `
    <h2>üéâ ‡∏à‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h2>
    <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${score} / ${quizData.length}</p>
    <button onclick="startPreview()">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
  `;
}

/* ================= LOAD SAVED KEY ================= */
geminiKey.value = localStorage.getItem("gemini_api_key") || "";
</script>

</body>
</html>
