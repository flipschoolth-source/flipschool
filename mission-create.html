<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏î‡πâ‡∏ß‡∏¢ AI ü§ñ - FlipSchool</title>
    
    <link rel="icon" type="image/png" href="img/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <style>
        :root { 
            --primary-dark: #000046; --primary: #00008B; --primary-light: #0052D4;
            --accent: #FF8C00; --bg-body: #f4f7fe; --white: #ffffff;
            --ai-color: #8e44ad;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-body); margin: 0; padding-bottom: 50px; }

        .page-header { 
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); 
            padding: 50px 20px; color: white; border-radius: 0 0 50px 50px; text-align: center;
        }

        .container { max-width: 1000px; margin: -40px auto 0; padding: 0 20px; }

        .card { 
            background: white; border-radius: 35px; padding: 35px; 
            box-shadow: 0 15px 45px rgba(0,0,0,0.06); margin-bottom: 25px;
        }

        /* --- AI Menu --- */
        .ai-tool-box {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border: 2px solid var(--ai-color); border-radius: 25px; padding: 25px;
            margin-bottom: 25px; display: none; /* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡πâ‡∏ß */
        }
        .ai-title { color: var(--ai-color); font-family: 'Kanit'; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        
        .btn-ai-gen {
            background: var(--ai-color); color: white; border: none; padding: 12px 25px;
            border-radius: 15px; cursor: pointer; font-family: 'Kanit'; font-weight: 600;
            transition: 0.3s; display: flex; align-items: center; gap: 8px;
        }
        .btn-ai-gen:hover { transform: scale(1.05); background: #7d3c98; }

        /* Template Grid & Other Styles (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô) */
        .template-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-top: 20px; }
        .template-item { border: 2px solid #f0f4ff; border-radius: 25px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; background: white; }
        .template-item.active { border-color: var(--primary); background: var(--primary); color: white; }
        .template-item span { font-size: 35px; display: block; margin-bottom: 8px; }
        .dynamic-item { background: #f8fbff; padding: 20px; border-radius: 20px; margin-bottom: 15px; position: relative; border: 1px solid #edf2f7; }
        .form-control { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="spinner-lg"></div></div>

    <header class="page-header">
        <h1 style="font-family:'Kanit'; margin:0;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà ‚ú®</h1>
        <p id="classNameDisplay" style="opacity:0.9;">‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </header>

    <main class="container">
        <div class="card">
            <div class="form-group">
                <label style="font-family:Kanit;">üè∑Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label>
                <input type="text" id="missionTitle" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <input type="number" id="rewardPoints" class="form-control" value="50" placeholder="‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•">
                <input type="number" id="missionTime" class="form-control" value="60" placeholder="‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)">
            </div>
        </div>

        <div class="card">
            <label style="font-family:Kanit; font-weight:600;">üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢</label>
            <div class="template-grid">
                <div class="template-item" onclick="selectTemplate('quiz')" id="tpl_quiz"><span>‚ùì</span><strong>‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</strong></div>
                <div class="template-item" onclick="selectTemplate('speech')" id="tpl_speech"><span>üé§</span><strong>‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</strong></div>
                <div class="template-item" onclick="selectTemplate('sort')" id="tpl_sort"><span>üì¶</span><strong>‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</strong></div>
                <div class="template-item" onclick="selectTemplate('lesson')" id="tpl_lesson"><span>üìñ</span><strong>‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</strong></div>
            </div>

            <div id="aiBox" class="ai-tool-box">
                <div class="ai-title">‚ú® Generative AI Assistant</div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="aiPrompt" class="form-control" style="margin:0;" placeholder="‡πÄ‡∏ä‡πà‡∏ô '‡∏Ç‡∏≠‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ö‡∏ß‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 5 ‡∏Ç‡πâ‡∏≠'">
                    <button class="btn-ai-gen" onclick="generateContent()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ AI</button>
                </div>
                <small style="color: #8e44ad; display: block; margin-top: 8px;">* AI ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</small>
            </div>

            <div id="contentEditor">
                </div>
        </div>

        <div class="footer-actions">
            <button class="btn-main btn-cancel" onclick="history.back()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <button class="btn-main btn-save" onclick="saveMission()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ‚ú®</button>
        </div>
    </main>

    <script>
        const currentClassId = new URLSearchParams(window.location.search).get('cid') || new URLSearchParams(window.location.search).get('id');
        let selectedType = '';

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: cls } = await sysDB.from('classrooms').select('*').eq('classroom_id', currentClassId).single();
            if(cls) document.getElementById('classNameDisplay').innerText = `‡∏ß‡∏¥‡∏ä‡∏≤ ${cls.subject_name} (${cls.room_name})`;
            document.getElementById('loadingOverlay').style.display = 'none';
        });

        function selectTemplate(type) {
            selectedType = type;
            document.querySelectorAll('.template-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tpl_' + type).classList.add('active');
            document.getElementById('aiBox').style.display = 'block';
            renderEditor();
        }

        function renderEditor() {
            const editor = document.getElementById('contentEditor');
            editor.innerHTML = (selectedType === 'quiz') ? `<div id="quiz_area"></div><button class="btn-add-item" onclick="addItem('quiz')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠</button>` 
                             : (selectedType === 'speech') ? `<div id="speech_area"></div><button class="btn-add-item" onclick="addItem('speech')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥</button>`
                             : `<p style="text-align:center; padding:20px;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...</p>`;
            if(['quiz','speech'].includes(selectedType)) addItem(selectedType);
        }

        function addItem(type, data = null) {
            const container = document.getElementById(type + '_area');
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            if(type === 'quiz') {
                div.innerHTML = `<input type="text" class="form-control q-title" value="${data?.q || ''}" placeholder="‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°">
                                 <input type="text" class="form-control q-ok" value="${data?.ok || ''}" placeholder="‡∏ñ‡∏π‡∏Å ‚úÖ">
                                 <input type="text" class="form-control q-no" value="${data?.no || ''}" placeholder="‡∏ú‡∏¥‡∏î ‚ùå">`;
            } else if(type === 'speech') {
                div.innerHTML = `<input type="text" class="form-control s-text" value="${data || ''}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥/‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ">`;
            }
            container.appendChild(div);
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gemini AI ---
        async function generateContent() {
            const promptInput = document.getElementById('aiPrompt').value;
            if(!promptInput) return alert('‡∏ö‡∏≠‡∏Å AI ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£?');

            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á System Instruction ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
                let instruction = `‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${selectedType} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ${promptInput} ‡πÇ‡∏î‡∏¢‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô `;
                if(selectedType === 'quiz') instruction += `‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: [{"q":"‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°","ok":"‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å","no":"‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î"}]`;
                if(selectedType === 'speech') instruction += `‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ["‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà 1", "‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà 2"]`;

                // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πá‡∏ö Key ‡∏Ç‡∏≠‡∏á Gemini ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const { data: config } = await sysDB.from('system_config').select('value').eq('key', 'GEMINI_API_KEY').single();
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${config.value}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: instruction }] }] })
                });

                const resData = await response.json();
                const aiText = resData.candidates[0].content.parts[0].text;
                const cleanJson = aiText.replace(/```json|```/g, "").trim();
                const result = JSON.parse(cleanJson);

                // ‡∏ô‡∏≥‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                const area = document.getElementById(selectedType + '_area');
                area.innerHTML = '';
                if(Array.isArray(result)) {
                    result.forEach(item => addItem(selectedType, item));
                }
                alert('AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üòä');

            } catch (err) {
                console.error(err);
                alert('AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function saveMission() {
            // (‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Table missions ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
            location.href = `classroom-detail.html?id=${currentClassId}`;
        }
    </script>
</body>
</html>
