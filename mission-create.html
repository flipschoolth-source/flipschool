<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mission Designer ‚ú® - FlipSchool</title>
    
    <link rel="icon" type="image/png" href="img/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <style>
        :root { 
            --primary-dark: #000046; --primary: #00008B; --primary-light: #0052D4;
            --accent: #FF8C00; --bg-body: #f4f7fe; --white: #ffffff;
            --ai-glow: #8e44ad;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-body); margin: 0; padding-bottom: 50px; }

        .page-header { 
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); 
            padding: 40px 20px; color: white; border-radius: 0 0 50px 50px; text-align: center;
        }

        .main-layout { display: grid; grid-template-columns: 1fr 400px; gap: 20px; max-width: 1400px; margin: -30px auto 0; padding: 0 20px; }
        @media (max-width: 1024px) { .main-layout { grid-template-columns: 1fr; } }

        .card { background: white; border-radius: 30px; padding: 25px; box-shadow: 0 15px 45px rgba(0,0,0,0.06); margin-bottom: 20px; }
        
        /* --- AI Logic Box --- */
        .ai-config { background: linear-gradient(135deg, #f5f0ff, #e8dbff); border: 2px solid var(--ai-glow); border-radius: 25px; padding: 20px; margin-bottom: 20px; }
        .api-key-input { background: rgba(255,255,255,0.7); border: 1px solid var(--ai-glow); padding: 10px; border-radius: 12px; width: 100%; margin-bottom: 10px; font-size: 12px; }

        /* --- Template Item --- */
        .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
        .template-item { 
            border: 2px solid #eee; border-radius: 20px; padding: 15px 10px; text-align: center; 
            cursor: pointer; transition: 0.3s; background: white; font-size: 13px;
        }
        .template-item.active { border-color: var(--ai-glow); background: var(--ai-glow); color: white; transform: scale(1.05); }
        .template-item span { font-size: 24px; display: block; margin-bottom: 5px; }

        /* --- Canvas Preview --- */
        .canvas-preview { 
            background: #2d3436; border-radius: 25px; height: 500px; position: sticky; top: 110px;
            display: flex; flex-direction: column; color: white; overflow: hidden; border: 8px solid #000;
        }
        .canvas-header { background: #000; padding: 10px; text-align: center; font-family: Kanit; font-size: 14px; color: var(--accent); }
        .canvas-body { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }

        .form-control { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 10px; font-family: Sarabun; }
        .btn-gen { background: var(--ai-glow); color: white; border: none; padding: 12px; border-radius: 12px; cursor: pointer; width: 100%; font-family: Kanit; font-weight: 600; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 15px; cursor: pointer; width: 100%; font-family: Kanit; font-size: 18px; margin-top: 10px; }

        .flexible-order { background: #fff8ef; border: 1px dashed var(--accent); padding: 15px; border-radius: 15px; margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="spinner-lg"></div></div>

    <header class="page-header">
        <h1 style="font-family:'Kanit'; margin:0;">AI Mission Designer üöÄ</h1>
        <p style="opacity:0.8;">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏ö‡∏ö‡πÑ‡∏£‡πâ‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏•‡∏±‡∏á Gemini</p>
    </header>

    <main class="main-layout">
        <div class="editor-side">
            <div class="ai-config">
                <label style="font-family:Kanit; font-weight:600; color:var(--ai-glow); display:block; margin-bottom:5px;">üîë ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Login/‡πÉ‡∏™‡πà Gemini API Key</label>
                <input type="password" id="geminiKey" class="api-key-input" placeholder="‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏£‡∏π)">
                
                <div class="form-group">
                    <label style="font-family:Kanit;">üß† ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ AI ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö (Prompt)</label>
                    <textarea id="aiPrompt" class="form-control" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏Ç‡∏≠‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏´‡∏°‡∏ß‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πâ 5 ‡∏Ñ‡∏≥ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏ß‡∏ô‡πÜ"></textarea>
                </div>
                <button class="btn-gen" onclick="askAI()">‡πÉ‡∏´‡πâ AI ‡∏£‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡πâ ‚ú®</button>
            </div>

            <div class="card">
                <label style="font-family:Kanit; font-weight:600; margin-bottom:10px; display:block;">üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</label>
                <div class="template-grid">
                    <div class="template-item" onclick="setTpl('quiz')" id="tpl_quiz"><span>‚ùì</span><strong>Quiz</strong></div>
                    <div class="template-item" onclick="setTpl('speech')" id="tpl_speech"><span>üé§</span><strong>Speak</strong></div>
                    <div class="template-item" onclick="setTpl('sort')" id="tpl_sort"><span>üì¶</span><strong>Sort</strong></div>
                    <div class="template-item" onclick="setTpl('match')" id="tpl_match"><span>üß©</span><strong>Match</strong></div>
                    <div class="template-item" onclick="setTpl('fill')" id="tpl_fill"><span>‚úèÔ∏è</span><strong>Fill</strong></div>
                </div>

                <div class="flexible-order">
                    <strong>‚öôÔ∏è Flexible Linking:</strong><br>
                    ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ö‡∏ô Journey Map ‡∏Ñ‡∏£‡∏π‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≤‡∏Å‡∏™‡∏•‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                </div>
            </div>

            <div class="card">
                <label style="font-family:Kanit;">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
                <div id="editorArea">
                    <p style="color:#999; text-align:center;">‡∏£‡∏≠ AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...</p>
                </div>
            </div>
        </div>

        <div class="preview-side">
            <div class="canvas-preview" id="canvas">
                <div class="canvas-header">üéÆ LIVE PREVIEW (‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</div>
                <div class="canvas-body" id="canvasBody">
                    <i class="fas fa-eye-slash" style="font-size:50px; opacity:0.2; margin-bottom:15px;"></i>
                    <p style="opacity:0.5;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•<br>‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ AI</p>
                </div>
            </div>
            <button class="btn-save" onclick="saveToDB()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚ú®</button>
            <button style="width:100%; background:none; border:none; color:#666; margin-top:10px; cursor:pointer;" onclick="history.back()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </main>

    <script>
        const classId = new URLSearchParams(window.location.search).get('cid');
        let currentType = 'quiz';
        let currentData = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // ‡∏î‡∏∂‡∏á Key ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á config (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            const { data } = await sysDB.from('system_config').select('value').eq('key', 'GEMINI_API_KEY').single();
            if(data) document.getElementById('geminiKey').value = data.value;
            document.getElementById('loadingOverlay').style.display = 'none';
        });

        function setTpl(type) {
            currentType = type;
            document.querySelectorAll('.template-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tpl_'+type).classList.add('active');
            updatePreview();
        }

        async function askAI() {
            const key = document.getElementById('geminiKey').value;
            const prompt = document.getElementById('aiPrompt').value;
            if(!key || !prompt) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£');

            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                const sysInstruction = `You are a game content designer for FlipSchool. Generate content for mission type "${currentType}" based on the topic: "${prompt}". 
                Respond ONLY with JSON format. 
                If type is quiz: [{"q":"question", "ok":"correct_ans", "no":"wrong_ans"}]
                If type is speech: ["word1", "word2"]
                If type is match: [{"k":"left_side", "v":"right_side"}]
                Strictly JSON only, no markdown tags.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: sysInstruction }] }] })
                });

                const resJson = await response.json();
                const text = resJson.candidates[0].content.parts[0].text;
                currentData = JSON.parse(text.replace(/```json|```/g, "").trim());
                
                updatePreview();
                renderEditorFields();
            } catch (e) {
                console.error(e);
                alert('AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à');
            }
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function updatePreview() {
            const canvas = document.getElementById('canvasBody');
            canvas.innerHTML = '';
            if(!currentData) return;

            if(currentType === 'quiz') {
                const item = currentData[0];
                canvas.innerHTML = `
                    <h2 style="font-family:Kanit; color:var(--accent);">‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å</h2>
                    <p style="font-size:24px;">${item.q}</p>
                    <div style="width:100%; display:grid; gap:10px; margin-top:20px;">
                        <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:15px; border:2px solid #2ecc71;">${item.ok} (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å)</div>
                        <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:15px;">${item.no}</div>
                    </div>
                `;
            } else if(currentType === 'speech') {
                canvas.innerHTML = `
                    <div style="font-size:60px; margin-bottom:20px;">üé§</div>
                    <p style="font-size:32px; font-family:Kanit;">"${currentData[0]}"</p>
                    <p style="color:#aaa;">‡∏Å‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î</p>
                `;
            }
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç type ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        }

        function renderEditorFields() {
            const area = document.getElementById('editorArea');
            area.innerHTML = `<pre style="background:#f4f4f4; padding:15px; border-radius:10px; font-size:12px; overflow:auto;">${JSON.stringify(currentData, null, 2)}</pre>
            <p style="font-size:12px; color:green;">‚ú® ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô AI ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>`;
        }

        async function saveToDB() {
            if(!currentData) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            const { error } = await sysDB.from('missions').insert({
                classroom_id: classId,
                title: document.getElementById('aiPrompt').value.substring(0, 50) || "‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà",
                mission_type: currentType,
                content_data: currentData,
                order_index: Date.now() // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Flexible Order
            });

            if(!error) {
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
                location.href = `classroom-detail.html?id=${classId}`;
            } else {
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    </script>
</body>
</html>
