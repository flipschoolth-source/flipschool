<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Canvas Designer - FlipSchool</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script src="js/supabase-db.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    body{margin:0;font-family:Sarabun;background:#f2f4f7}
    header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;text-align:center;padding:30px 20px;border-radius:0 0 30px 30px}
    main{max-width:1300px;margin:20px auto;padding:0 20px;display:grid;grid-template-columns:1fr 450px;gap:20px}
    @media(max-width:1024px){main{grid-template-columns:1fr}}
    
    .card{background:#fff;border-radius:20px;padding:20px;box-shadow:0 8px 25px rgba(0,0,0,.05);margin-bottom:20px}
    label{font-family:Kanit;font-weight:500;display:block;margin-bottom:5px}
    input, textarea, select {width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;box-sizing:border-box;margin-top:5px;font-family:inherit}
    
    button{border:none;border-radius:12px;padding:14px;background:#00b894;color:#fff;font-family:Kanit;cursor:pointer;width:100%;font-size:16px;transition:0.3s}
    button:hover{filter:brightness(1.1)}
    
    /* Mockup Phone */
    .phone{background:#111;border-radius:40px;padding:12px;height:750px;position:sticky;top:20px;border:4px solid #333}
    .screen{background:#fff;border-radius:30px;height:100%;overflow:hidden;position:relative}
    
    /* iframe rendering */
    #canvasIframe {width: 100%; height: 100%; border: none; background: white;}
    
    #codeEditor {background:#2d3436;color:#dfe6e9;padding:15px;border-radius:12px;font-size:12px;max-height:300px;overflow:auto;margin-top:10px}
    .status{display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:#bbb}
    .dot.on{background:#00b894;box-shadow:0 0 6px #00b894}
</style>
</head>
<body>

<header>
    <h1 style="font-family:Kanit;margin:0">AI Canvas Designer ‚ú®</h1>
    <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Code HTML/JS ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
</header>

<main>
    <section>
        <div class="card">
            <div class="status"><div id="dot" class="dot"></div><span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span></div>
            <label>üîë API Key</label>
            <input type="password" id="geminiKey" placeholder="AIzaSy...">
            <button onclick="testAndSaveKey()" style="background:#636e72;margin-top:10px">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå</button>
        </div>

        <div class="card">
            <label>ü§ñ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•</label>
            <select id="modelSelect">
                <option value="gemini-1.5-pro">Gemini 1.5 Pro (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Code)</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏ü‡∏£‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞)</option>
            </select>
        </div>

        <div class="card">
            <label>üé® ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£ AI (Prompt)</label>
            <textarea id="aiPrompt" rows="5" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏è‡∏à‡∏±‡∏Å‡∏£‡∏ô‡πâ‡∏≥ ‡∏°‡∏µ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏ù‡∏ô‡∏ï‡∏Å‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡πÜ ‡πÉ‡∏ä‡πâ Tailwind CSS ‡πÑ‡∏î‡πâ"></textarea>
            <button onclick="generateHTML()">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô Canvas</button>
        </div>

        <div class="card" id="codeCard" style="display:none">
            <label>üíª Source Code</label>
            <pre id="codeEditor"></pre>
        </div>
    </section>

    <aside>
        <div class="phone">
            <div class="screen">
                <iframe id="canvasIframe" title="Preview"></iframe>
            </div>
        </div>
    </aside>
</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
let teacherProfile = null;

document.addEventListener("DOMContentLoaded", async () => {
    const { data: { user } } = await sysDB.auth.getUser();
    if (!user) return window.location.href = 'teacher-login.html';
    const { data: profile } = await sysDB.from('teachers').select('*').eq('teacher_id', user.id).single();
    teacherProfile = profile;
    if (profile?.gemini_key) {
        document.getElementById('geminiKey').value = profile.gemini_key;
        document.getElementById('dot').classList.add('on');
        document.getElementById('statusText').textContent = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
    }
});

async function testAndSaveKey() {
    const key = document.getElementById('geminiKey').value;
    const res = await fetch(`${API_BASE}/models/gemini-1.5-flash?key=${key}`);
    const json = await res.json();
    if(json.error) return alert("‡∏Ñ‡∏µ‡∏¢‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    
    if(confirm("‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        await sysDB.from('teachers').update({gemini_key: key}).eq('teacher_id', teacherProfile.teacher_id);
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        location.reload();
    }
}

async function generateHTML() {
    const key = document.getElementById('geminiKey').value;
    const prompt = document.getElementById('aiPrompt').value;
    const model = document.getElementById('modelSelect').value;

    if(!prompt || !key) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Loading ‡πÉ‡∏ô Preview
    const iframe = document.getElementById('canvasIframe');
    iframe.srcdoc = "<html><body style='display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h3>‚ö° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h3></body></html>";

    const instruction = `
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô HTML5 Canvas ‡πÅ‡∏•‡∏∞ Web Design
    ‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏à 1 ‡∏´‡∏ô‡πâ‡∏≤ (Single File) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤: "${prompt}"
    ‡∏Å‡∏é:
    1. ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô HTML Code ‡πÄ‡∏û‡∏µ‡∏¢‡∏ß‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô
    2. ‡∏£‡∏ß‡∏° CSS ‡πÅ‡∏•‡∏∞ JS ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    3. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞ Responsive ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
    4. ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ CDN ‡πÄ‡∏ä‡πà‡∏ô Tailwind CSS ‡∏´‡∏£‡∏∑‡∏≠ FontAwesome ‡πÑ‡∏î‡πâ
    `;

    try {
        const res = await fetch(`${API_BASE}/models/${model}:generateContent?key=${key}`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ contents: [{ parts: [{ text: instruction }] }] })
        });
        const json = await res.json();
        let code = json.candidates[0].content.parts[0].text;
        
        // ‡∏•‡πâ‡∏≤‡∏á Markdown Backticks
        code = code.replace(/```html|```/g, "").trim();

        // ‡πÅ‡∏™‡∏î‡∏á Code
        document.getElementById('codeCard').style.display = 'block';
        document.getElementById('codeEditor').textContent = code;

        // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡∏á‡πÉ‡∏ô Iframe (Canvas)
        iframe.srcdoc = code;

    } catch (e) {
        alert("Error: " + e.message);
    }
}
</script>
</body>
</html>
