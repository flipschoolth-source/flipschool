<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Mission Designer - FlipSchool</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script src="js/supabase-db.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun&display=swap" rel="stylesheet">

<style>
/* ... CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ... */
body{margin:0;font-family:Sarabun;background:#f2f4f7}
header{background:linear-gradient(135deg,#141e30,#243b55);color:#fff;text-align:center;padding:40px 20px;border-radius:0 0 40px 40px}
main{max-width:1200px;margin:-30px auto 40px;padding:0 20px;display:grid;grid-template-columns:1fr 420px;gap:25px}
@media(max-width:1024px){main{grid-template-columns:1fr}}
.card{background:#fff;border-radius:25px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,.06);margin-bottom:20px}
label{font-family:Kanit;font-size:14px}
input,textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;box-sizing:border-box;margin-top:6px}
button{border:none;border-radius:12px;padding:12px;background:#8e44ad;color:#fff;font-family:Kanit;cursor:pointer;margin-top:10px;width:100%}
button.secondary{background:#34495e}
.status{display:flex;align-items:center;gap:8px;font-size:13px}
.dot{width:10px;height:10px;border-radius:50%;background:#bbb}
.dot.on{background:#2ecc71;box-shadow:0 0 6px #2ecc71}
.phone{background:#111;border-radius:40px;padding:12px;height:620px;position:sticky;top:20px}
.screen{background:#fff;border-radius:30px;height:100%;display:flex;flex-direction:column;padding:20px}
.quiz-q{font-family:Kanit;font-size:18px;margin-bottom:20px}
.choice{padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:10px;cursor:pointer}
.choice.correct{background:#eafaf1;border-color:#2ecc71}
.choice.wrong{background:#fdecea;border-color:#e74c3c}
.choice.disabled{pointer-events:none;opacity:.7}
.footer{margin-top:auto;font-size:13px;color:#888;text-align:center}
pre{background:#fafafa;padding:15px;border-radius:12px;font-size:12px;max-height:260px;overflow:auto}
</style>
</head>

<body>

<header>
<h1 style="font-family:Kanit;margin:0">AI Mission Creator üöÄ</h1>
<p>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏£‡∏π (Supabase)</p>
</header>

<main>
<section>
    <div class="card">
        <div class="status">
            <div id="dot" class="dot"></div>
            <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...</span>
        </div>

        <label>üîë Gemini API Key</label>
        <input type="password" id="geminiKey" placeholder="AIzaSy...">
        <button onclick="testApiKey()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
        <button class="secondary" onclick="listModels()">üìã ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•</button>
    </div>

    <div class="card">
        <label>ü§ñ ‡πÇ‡∏°‡πÄ‡∏î‡∏•</label>
        <select id="modelSelect">
            <option value="gemini-1.5-flash-latest">gemini-1.5-flash-latest</option>
        </select>
    </div>

    <div class="card">
        <label>üí° ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label>
        <textarea id="aiPrompt" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô Past Simple Tense"></textarea>
        <button onclick="generateByAI()">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏î‡πâ‡∏ß‡∏¢ AI</button>
    </div>

    <div class="card">
        <label>üì¶ JSON (‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)</label>
        <div id="dataEditor"></div>
    </div>
</section>

<aside>
    <div class="phone">
        <div class="screen" id="preview">
            <div class="footer">‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‚Ä¶</div>
        </div>
    </div>
</aside>
</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
let quizData = [];
let index = 0;
let score = 0;
let currentUser = null;

// ================= 1. LOAD USER & KEY FROM DB =================
document.addEventListener("DOMContentLoaded", async () => {
    // ‡∏î‡∏∂‡∏á User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const { data: { user } } = await sysDB.auth.getUser();
    if (!user) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
        window.location.href = "teacher-login.html";
        return;
    }
    currentUser = user;

    // ‡∏î‡∏∂‡∏á Key ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á teachers (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå gemini_key)
    const { data: profile } = await sysDB
        .from('teachers')
        .select('gemini_key')
        .eq('teacher_id', user.id)
        .single();

    if (profile && profile.gemini_key) {
        geminiKey.value = profile.gemini_key;
        updateStatus(true, "‡πÉ‡∏ä‡πâ API Key ‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
        listModels();
    } else {
        updateStatus(false, "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ API Key ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå");
    }
});

function updateStatus(on, text) {
    on ? dot.classList.add("on") : dot.classList.remove("on");
    statusText.textContent = text;
}

/* ================= 2. TEST & SAVE KEY ================= */
async function testApiKey(){
    const key = geminiKey.value.trim();
    if(!key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key");

    try{
        const res = await fetch(`${API_BASE}/models/gemini-1.5-flash-latest:generateContent?key=${key}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({ contents:[{parts:[{text:"ping"}]}] })
        });

        const json = await res.json();
        if(json.error) throw new Error(json.error.message);

        updateStatus(true, "API Key ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‚úî");

        // ‡∏ñ‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á DB ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
        if (confirm("‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Key ‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            const { error } = await sysDB
                .from('teachers')
                .update({ gemini_key: key })
                .eq('teacher_id', currentUser.id);

            if (error) throw error;
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

    } catch(e) {
        updateStatus(false, "API Key ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚ùå");
        alert("‚ùå "+e.message);
    }
}

/* ================= 3. LIST MODELS & GENERATE ================= */
async function listModels(){
    const key = geminiKey.value.trim();
    if(!key) return;

    try {
        const res = await fetch(`${API_BASE}/models?key=${key}`);
        const json = await res.json();
        if(json.error) return;

        modelSelect.innerHTML = "";
        json.models
            .filter(m=>m.supportedGenerationMethods?.includes("generateContent"))
            .forEach(m=>{
                const opt=document.createElement("option");
                const mName = m.name.replace("models/","");
                opt.value=mName;
                opt.textContent=mName;
                if(mName === "gemini-1.5-flash-latest") opt.selected = true;
                modelSelect.appendChild(opt);
            });
    } catch(err) { console.error(err); }
}

async function generateByAI(){
    const key = geminiKey.value.trim();
    const model = modelSelect.value;
    const prompt = aiPrompt.value.trim();
    if(!prompt) return alert("‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à");

    const instruction = `‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏™‡∏£‡πâ‡∏≤‡∏á Quiz 3 ‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "${prompt}" [{"q":"‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°","ok":"‡∏ñ‡∏π‡∏Å","no":"‡∏ú‡∏¥‡∏î"}]`;

    try {
        const res = await fetch(`${API_BASE}/models/${model}:generateContent?key=${key}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({ contents:[{parts:[{text:instruction}]}] })
        });

        const json = await res.json();
        if(json.error) throw new Error(json.error.message);

        let text = json.candidates[0].content.parts[0].text;
        quizData = JSON.parse(text.replace(/```json|```/g,""));

        dataEditor.innerHTML = `<pre>${JSON.stringify(quizData,null,2)}</pre>`;
        startPreview();
    } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message); }
}

/* ================= 4. PREVIEW ENGINE ================= */
function startPreview(){
    index = 0; score = 0;
    renderQuestion();
}

function renderQuestion(){
    const q = quizData[index];
    preview.innerHTML = `
        <div class="quiz-q">${index+1}. ${q.q}</div>
        <div class="choice" onclick="answer(true)">${q.ok}</div>
        <div class="choice" onclick="answer(false)">${q.no}</div>
        <div class="footer">‡∏Ç‡πâ‡∏≠ ${index+1}/${quizData.length}</div>
    `;
}

function answer(correct){
    const choices = document.querySelectorAll(".choice");
    choices.forEach(c=>c.classList.add("disabled"));
    if(correct){ score++; choices[0].classList.add("correct"); }
    else{ choices[1].classList.add("wrong"); choices[0].classList.add("correct"); }

    setTimeout(()=>{
        index++;
        index < quizData.length ? renderQuestion() : finish();
    },900);
}

function finish(){
    preview.innerHTML = `
        <h2 style="font-family:Kanit">üéâ ‡∏à‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h2>
        <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ${score} / ${quizData.length}</p>
        <button onclick="startPreview()">‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
    `;
}
</script>
</body>
</html>
