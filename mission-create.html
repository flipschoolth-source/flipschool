<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AI Mission Designer - FlipSchool</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root { 
    --primary: #00008B; --primary-light: #0052D4; --ai-glow: #8e44ad;
    --bg: #f8f9fa; --white: #ffffff; --success: #2ecc71; --error: #e74c3c;
}
body { margin:0; font-family: 'Sarabun', sans-serif; background: var(--bg); color: #333; }
header {
    background: linear-gradient(135deg, #000046, var(--primary-light));
    color: #fff; text-align: center; padding: 30px 20px 60px;
    border-radius: 0 0 40px 40px;
}
main {
    max-width: 1200px; margin: -40px auto 40px; padding: 0 20px;
    display: grid; grid-template-columns: 1fr 400px; gap: 25px;
}
@media(max-width:1024px){ main { grid-template-columns: 1fr; } }

.card {
    background: #fff; border-radius: 20px; padding: 25px;
    box-shadow: 0 10px 25px rgba(0,0,0,.05); margin-bottom: 20px;
}
label { font-family: 'Kanit'; font-weight: 500; display: block; margin-bottom: 8px; font-size: 15px; }
input, textarea, select {
    width: 100%; padding: 12px; border-radius: 12px;
    border: 1.5px solid #eee; box-sizing: border-box; font-family: inherit; font-size: 15px;
}
input:focus, textarea:focus { border-color: var(--ai-glow); outline: none; background: #fff; }

button {
    border: none; border-radius: 12px; padding: 14px;
    background: var(--ai-glow); color: #fff; font-family: Kanit;
    cursor: pointer; margin-top: 10px; width: 100%; font-size: 16px;
    transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
}
button:active { transform: scale(0.98); }
button.secondary { background: #34495e; }

.status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 20px; background: #eee; font-size: 12px; font-weight: 600; margin-bottom: 10px; }
.dot { width: 8px; height: 8px; border-radius: 50%; background: #bbb; }
.dot.on { background: var(--success); box-shadow: 0 0 8px var(--success); }

/* --- Mobile Preview Mockup --- */
.phone {
    background: #1a1a1a; border-radius: 50px; padding: 12px;
    height: 680px; position: sticky; top: 20px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.15); border: 4px solid #333;
}
.screen {
    background: #fff; border-radius: 40px; height: 100%;
    display: flex; flex-direction: column; overflow: hidden; position: relative;
}
.screen-top { height: 40px; background: #fff; width: 100%; display: flex; justify-content: center; align-items: flex-end; }
.notch { width: 100px; height: 20px; background: #1a1a1a; border-radius: 0 0 15px 15px; }

.canvas-area {
    flex: 1; padding: 20px; display: flex; flex-direction: column;
    align-items: center; justify-content: center; background: #fdfdfd;
}

/* --- Quiz UI inside Preview --- */
.quiz-card {
    width: 100%; background: #fff; padding: 20px; border-radius: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #f0f0f0;
}
.ans-btn {
    width: 100%; padding: 15px; margin-top: 10px; border-radius: 15px;
    border: 2px solid #eee; background: #fff; font-family: Sarabun;
    font-size: 15px; font-weight: 500; text-align: left; cursor: pointer; transition: 0.2s;
}
.ans-btn:hover { border-color: var(--primary-light); background: #f0f7ff; }
.ans-btn.correct { border-color: var(--success); background: #e8f7ef; color: #1e7e44; }
.ans-btn.wrong { border-color: var(--error); background: #fdf2f2; color: #a94442; }

#loadingOverlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(255,255,255,0.85); display:none;
    align-items:center; justify-content:center; z-index:9999;
}
.spinner {
    width: 40px; height: 40px; border: 4px solid #f3f3f3;
    border-top: 4px solid var(--ai-glow); border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div></div>

<header>
    <h1 style="font-family:Kanit; margin:0; letter-spacing: 1px;">AI MISSION DESIGNER üöÄ</h1>
    <p style="opacity: 0.9;">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå</p>
</header>

<main>
    <section>
        <div class="card">
            <div class="status-badge">
                <div id="dot" class="dot"></div>
                <span id="statusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API</span>
            </div>

            <label><i class="fa-solid fa-key"></i> Gemini API Key</label>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="password" id="geminiKey" placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...">
                <button onclick="testApiKey()" style="margin:0; width: auto; white-space: nowrap; padding: 0 20px;">‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
            </div>
            
            <label><i class="fa-solid fa-robot"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
            <select id="modelSelect" onchange="updateModelDesc()">
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ - ‡πÄ‡∏£‡πá‡∏ß/‡∏ü‡∏£‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞)</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro (‡∏â‡∏•‡∏≤‡∏î‡∏°‡∏≤‡∏Å/‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô)</option>
                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î/‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)</option>
            </select>
        </div>

        <div class="card">
            <label><i class="fa-solid fa-wand-magic-sparkles"></i> ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
            <textarea id="aiPrompt" rows="3" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏è‡∏à‡∏±‡∏Å‡∏£‡∏ô‡πâ‡∏≥ ‡∏õ.5 ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå 3 ‡∏Ç‡πâ‡∏≠"></textarea>
            <button onclick="generateByAI()">
                <i class="fa-solid fa-bolt"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ
            </button>
        </div>

        <div class="card" id="dataCard" style="display: none;">
            <label><i class="fa-solid fa-file-code"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (JSON)</label>
            <div id="dataEditor"></div>
            <button class="secondary" onclick="copyJSON()" style="margin-top: 15px;">
                <i class="fa-solid fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </section>

    <aside>
        <div class="phone">
            <div class="screen">
                <div class="screen-top"><div class="notch"></div></div>
                <div class="canvas-area" id="preview">
                    <div style="text-align: center; color: #ccc;">
                        <i class="fa-solid fa-wand-sparkles" style="font-size: 50px; margin-bottom: 15px;"></i>
                        <p>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢<br>‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à"</p>
                    </div>
                </div>
            </div>
        </div>
    </aside>
</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
let missionData = [];

document.addEventListener("DOMContentLoaded", () => {
    const savedKey = localStorage.getItem("gemini_api_key");
    if(savedKey) {
        document.getElementById('geminiKey').value = savedKey;
        testApiKey(true); // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö
    }
});

async function testApiKey(silent = false) {
    const key = document.getElementById('geminiKey').value;
    if(!key) return;

    try {
        const res = await fetch(`${API_BASE}/models?key=${key}`);
        const json = await res.json();
        if(json.error) throw new Error(json.error.message);

        document.getElementById('dot').classList.add("on");
        document.getElementById('statusText').textContent = "API ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà";
        localStorage.setItem("gemini_api_key", key);
        if(!silent) alert("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    } catch(e) {
        document.getElementById('dot').classList.remove("on");
        document.getElementById('statusText').textContent = "Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
        if(!silent) alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
    }
}

async function generateByAI() {
    const key = document.getElementById('geminiKey').value;
    const prompt = document.getElementById('aiPrompt').value;
    const model = document.getElementById('modelSelect').value;

    if(!key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key");
    if(!prompt) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á");

    document.getElementById('loadingOverlay').style.display = 'flex';

    const instruction = `‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° 3 ‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "${prompt}" 
‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: [{"q":"‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°","ok":"‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å","no":"‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î"}]`;

    try {
        const res = await fetch(`${API_BASE}/models/${model}:generateContent?key=${key}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: instruction }] }] })
        });

        const json = await res.json();
        if(json.error) throw new Error(json.error.message);

        let text = json.candidates[0].content.parts[0].text;
        text = text.replace(/```json|```/g, "").trim();
        missionData = JSON.parse(text);

        // ‡πÅ‡∏™‡∏î‡∏á JSON ‡πÉ‡∏ô Editor
        document.getElementById('dataCard').style.display = 'block';
        document.getElementById('dataEditor').innerHTML = `<pre>${JSON.stringify(missionData, null, 2)}</pre>`;

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Canvas (Preview)
        renderQuiz(0);

    } catch(e) {
        alert("‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + e.message);
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Canvas ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏à‡∏£‡∏¥‡∏á
function renderQuiz(index) {
    const item = missionData[index];
    const preview = document.getElementById('preview');
    
    // ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    const answers = [
        { text: item.ok, correct: true },
        { text: item.no, correct: false }
    ].sort(() => Math.random() - 0.5);

    preview.innerHTML = `
        <div style="width: 100%; text-align: left;">
            <div style="font-size: 12px; font-weight: bold; color: var(--ai-glow); margin-bottom: 10px;">
                ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${index + 1} / ${missionData.length}
            </div>
            <div class="quiz-card">
                <h3 style="margin: 0; font-size: 18px; line-height: 1.5;">${item.q}</h3>
            </div>
            <div style="margin-top: 20px;">
                ${answers.map(ans => `
                    <button class="ans-btn" onclick="checkAns(this, ${ans.correct}, ${index})">
                        ${ans.text}
                    </button>
                `).join('')}
            </div>
        </div>
    `;
}

function checkAns(btn, isCorrect, currentIndex) {
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô
    const buttons = document.querySelectorAll('.ans-btn');
    buttons.forEach(b => b.style.pointerEvents = 'none');

    if(isCorrect) {
        btn.classList.add('correct');
        btn.innerHTML += ' <i class="fa-solid fa-circle-check"></i>';
        setTimeout(() => {
            if(currentIndex < missionData.length - 1) {
                renderQuiz(currentIndex + 1);
            } else {
                finishPreview();
            }
        }, 1500);
    } else {
        btn.classList.add('wrong');
        btn.innerHTML += ' <i class="fa-solid fa-circle-xmark"></i>';
        setTimeout(() => renderQuiz(currentIndex), 1200); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà
    }
}

function finishPreview() {
    document.getElementById('preview').innerHTML = `
        <div style="text-align: center;">
            <i class="fa-solid fa-trophy" style="font-size: 60px; color: #f1c40f; margin-bottom: 15px;"></i>
            <h2 style="font-family: Kanit; margin: 0;">‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!</h2>
            <p>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
            <button onclick="generateByAI()" style="background: var(--primary); margin-top: 15px;">
                <i class="fa-solid fa-rotate-left"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>
    `;
}

function copyJSON() {
    const text = JSON.stringify(missionData);
    navigator.clipboard.writeText(text).then(() => alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß"));
}
</script>

</body>
</html>
