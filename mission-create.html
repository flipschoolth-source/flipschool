<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Magic Canvas - FlipSchool</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script src="js/supabase-db.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{margin:0;font-family:Sarabun;background:#f2f4f7}
header{
  background:linear-gradient(135deg,#141e30,#243b55);
  color:#fff;text-align:center;padding:35px 20px 70px;
  border-radius:0 0 50px 50px
}
main{
  max-width:1400px;margin:-40px auto 40px;padding:0 20px;
  display:grid;grid-template-columns:1fr 460px;gap:25px
}
@media(max-width:1024px){main{grid-template-columns:1fr}}
.card{
  background:#fff;border-radius:30px;padding:25px;
  box-shadow:0 15px 35px rgba(0,0,0,.08);margin-bottom:20px
}
label{font-family:Kanit;font-weight:500;margin-bottom:8px;display:block}
input,textarea{
  width:100%;padding:14px;border-radius:14px;
  border:1px solid #ddd;font-size:15px
}
button{
  width:100%;padding:14px;border:none;border-radius:14px;
  background:#8e44ad;color:#fff;
  font-family:Kanit;font-size:16px;
  cursor:pointer;display:flex;gap:10px;
  justify-content:center;align-items:center
}
button.secondary{background:#34495e}
.api-status{display:flex;align-items:center;gap:8px;font-size:13px}
.dot{width:10px;height:10px;border-radius:50%;background:#bbb}
.dot.on{background:#2ecc71;box-shadow:0 0 8px #2ecc71}

.phone{
  background:#111;border-radius:55px;padding:15px;
  height:760px;position:sticky;top:20px
}
.screen{
  background:#fff;border-radius:40px;height:100%;
  overflow:hidden
}
iframe{width:100%;height:100%;border:none}
</style>
</head>

<body>

<header>
<h1 style="font-family:Kanit;margin:0">AI Magic Canvas ‚ú®</h1>
<p>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
</header>

<main>

<section>

<div class="card">
  <div class="api-status">
    <div id="dot" class="dot"></div>
    <span id="statusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à API Key</span>
  </div>

  <label>üîë Gemini API Key</label>
  <input type="password" id="geminiKey" placeholder="AIzaSy...">
  <button class="secondary" onclick="testKey()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö API Key</button>
</div>

<div class="card">
  <label>ü§ñ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
  <input value="gemini-1.5-flash-latest" disabled>
</div>

<div class="card">
  <label>üé® ‡∏™‡∏±‡πà‡∏á AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</label>
  <textarea id="prompt" rows="6"
  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏∞ Interactive ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô"></textarea>
  <button onclick="generateCanvas()">
    <i class="fas fa-wand-magic-sparkles"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠
  </button>
</div>

</section>

<aside>
<div class="phone">
<div class="screen">
<iframe id="preview"
srcdoc="<body style='display:flex;justify-content:center;align-items:center;height:100vh;color:#bbb'>‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</body>">
</iframe>
</div>
</div>

<button id="saveBtn" style="margin-top:20px;display:none;background:#2ecc71"
onclick="saveMission()">
<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
</button>
</aside>

</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
const MODEL = "gemini-1.5-flash-latest";
let lastHTML = "";

/* ===== Test API KEY (‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á) ===== */
async function testKey(){
  const key = geminiKey.value.trim();
  if(!key) return alert("‡πÉ‡∏™‡πà API Key");

  try{
    const res = await fetch(
      `${API_BASE}/models/${MODEL}:generateContent?key=${key}`,
      {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          contents:[{parts:[{text:"ping"}]}]
        })
      }
    );
    const json = await res.json();
    if(json.error) throw new Error(json.error.message);

    dot.classList.add("on");
    statusText.textContent = "API Key ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‚úî";
  }catch(e){
    dot.classList.remove("on");
    statusText.textContent = "API Key ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚ùå";
    alert(e.message);
  }
}

/* ===== Generate Canvas ===== */
async function generateCanvas(){
  const key = geminiKey.value.trim();
  const p = prompt.value.trim();
  if(!key || !p) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

  preview.srcdoc = "<h3 style='text-align:center'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...</h3>";

  const instruction = `
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡πá‡∏ö HTML ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "${p}"
- ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
- Interactive
- Responsive
- ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HTML code ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
`;

  try{
    const res = await fetch(
      `${API_BASE}/models/${MODEL}:generateContent?key=${key}`,
      {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          contents:[{parts:[{text:instruction}]}]
        })
      }
    );
    const json = await res.json();
    if(json.error) throw new Error(json.error.message);

    let html = json.candidates[0].content.parts[0].text;
    html = html.replace(/```html|```/g,"").trim();
    lastHTML = html;

    preview.srcdoc = html;
    saveBtn.style.display = "block";
  }catch(e){
    preview.srcdoc = `<body>Error: ${e.message}</body>`;
  }
}

async function saveMission(){
  alert("‚úî ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Supabase (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)");
}
</script>

</body>
</html>
