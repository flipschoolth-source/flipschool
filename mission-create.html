<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Magic Canvas - FlipSchool</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script src="js/supabase-db.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{margin:0;font-family:Sarabun;background:#f2f4f7;color:#333}
header{
  background:linear-gradient(135deg,#141e30,#243b55);
  color:#fff;text-align:center;padding:35px 20px 70px;
  border-radius:0 0 50px 50px
}
main{
  max-width:1400px;margin:-40px auto 40px;padding:0 20px;
  display:grid;grid-template-columns:1fr 460px;gap:25px
}
@media(max-width:1024px){main{grid-template-columns:1fr}}
.card{
  background:#fff;border-radius:30px;padding:25px;
  box-shadow:0 15px 35px rgba(0,0,0,.08);margin-bottom:20px
}
label{font-family:Kanit;font-weight:500;margin-bottom:8px;display:block}
input,textarea{
  width:100%;padding:14px;border-radius:14px;
  border:1px solid #ddd;font-size:15px;box-sizing:border-box
}
textarea:focus,input:focus{
  outline:none;border-color:#8e44ad;
  box-shadow:0 0 8px rgba(142,68,173,.15)
}
button{
  width:100%;padding:14px;border:none;border-radius:14px;
  background:#8e44ad;color:#fff;
  font-family:Kanit;font-size:16px;
  cursor:pointer;display:flex;gap:10px;
  justify-content:center;align-items:center;
  transition:.2s
}
button:hover{transform:translateY(-1px);filter:brightness(1.05)}
button.secondary{background:#34495e}

.api-status{display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:12px}
.dot{width:10px;height:10px;border-radius:50%;background:#bbb}
.dot.on{background:#2ecc71;box-shadow:0 0 8px #2ecc71}

.phone{
  background:#111;border-radius:55px;padding:15px;
  height:760px;position:sticky;top:20px;
  box-shadow:0 25px 50px rgba(0,0,0,.25)
}
.screen{
  background:#fff;border-radius:40px;height:100%;
  overflow:hidden
}
iframe{width:100%;height:100%;border:none}

#loadingOverlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,.85);
  display:none;align-items:center;justify-content:center;
  z-index:9999
}
.spinner{
  width:48px;height:48px;border:5px solid #eee;
  border-top-color:#8e44ad;border-radius:50%;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div id="loadingOverlay"><div class="spinner"></div></div>

<header>
<h1 style="font-family:Kanit;margin:0">AI Magic Canvas ‚ú®</h1>
<p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô Interactive ‡∏î‡πâ‡∏ß‡∏¢ Gemini AI (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£)</p>
</header>

<main>

<section>

<div class="card">
  <div class="api-status">
    <div id="dot" class="dot"></div>
    <span id="statusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à API Key</span>
  </div>

  <label>üîë Gemini API Key</label>
  <input type="password" id="geminiKey" placeholder="AIzaSy...">
  <button class="secondary" onclick="testApiKey()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö API Key</button>
</div>

<div class="card">
  <label>ü§ñ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£)</label>
  <input value="gemini-1.5-flash" disabled>
</div>

<div class="card">
  <label>üé® ‡∏™‡∏±‡πà‡∏á AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</label>
  <textarea id="aiPrompt" rows="6"
    placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏∞ Interactive ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô"></textarea>
  <button onclick="generateCanvas()">
    <i class="fas fa-wand-magic-sparkles"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠
  </button>
</div>

</section>

<aside>
<div class="phone">
<div class="screen">
<iframe id="preview"
srcdoc="<body style='display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;color:#aaa;text-align:center'>‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</body>">
</iframe>
</div>
</div>

<button id="saveBtn" style="margin-top:20px;display:none;background:#2ecc71"
onclick="saveMission()">
<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
</button>
</aside>

</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
const MODEL = "gemini-1.5-flash";
let lastGeneratedHTML = "";

/* ================= Test API Key ================= */
async function testApiKey(){
  const key = geminiKey.value.trim();
  if(!key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key");

  loading(true);
  try{
    const res = await fetch(
      `${API_BASE}/models/${MODEL}:generateContent?key=${key}`,
      {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          contents:[{parts:[{text:"ping"}]}]
        })
      }
    );
    const json = await res.json();
    if(json.error) throw new Error(json.error.message);

    dot.classList.add("on");
    statusText.textContent = "API Key ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‚úî";
  }catch(e){
    dot.classList.remove("on");
    statusText.textContent = "API Key ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚ùå";
    alert("‚ùå "+e.message);
  }finally{
    loading(false);
  }
}

/* ================= Generate Canvas ================= */
async function generateCanvas(){
  const key = geminiKey.value.trim();
  const prompt = aiPrompt.value.trim();
  if(!key || !prompt) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

  loading(true);
  preview.srcdoc =
    "<body style='display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif'>‚ö° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠...</body>";

  const instruction = `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡πá‡∏ö HTML ‡∏´‡∏ô
