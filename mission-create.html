<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Magic Canvas - FlipSchool</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script src="js/supabase-db.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root { --primary: #141e30; --accent: #8e44ad; --bg: #f2f4f7; }
    body{margin:0; font-family:Sarabun; background:var(--bg); color:#333; overflow-x:hidden;}
    header{
        background:linear-gradient(135deg,#141e30,#243b55);
        color:#fff; text-align:center; padding:30px 20px 60px;
        border-radius:0 0 50px 50px;
    }
    main{
        max-width:1400px; margin:-40px auto 40px; padding:0 20px;
        display:grid; grid-template-columns: 1fr 450px; gap:25px;
    }
    @media(max-width:1024px){ main{ grid-template-columns:1fr; } }

    .card{ background:#fff; border-radius:30px; padding:25px; box-shadow:0 15px 35px rgba(0,0,0,.08); margin-bottom:20px; border: 1px solid rgba(255,255,255,0.3); }
    label{ font-family:Kanit; font-weight:500; margin-bottom:10px; display:block; color:var(--primary); }
    
    input, textarea, select {
        width:100%; padding:15px; border-radius:15px; border:1px solid #ddd;
        box-sizing:border-box; font-family:inherit; font-size:15px; transition:0.3s;
    }
    textarea:focus { border-color:var(--accent); outline:none; box-shadow: 0 0 10px rgba(142,68,173,0.1); }

    button{
        border:none; border-radius:15px; padding:15px; background:var(--accent);
        color:#fff; font-family:Kanit; cursor:pointer; font-size:16px; width:100%;
        transition:0.3s; display:flex; align-items:center; justify-content:center; gap:10px;
    }
    button:hover{ transform:translateY(-2px); filter:brightness(1.1); }
    
    /* Phone Mockup (Canvas) */
    .phone-container {
        background:#111; border-radius:55px; padding:15px;
        height:750px; position:sticky; top:20px;
        border: 5px solid #333; box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    }
    .screen {
        background:#fff; border-radius:40px; height:100%;
        overflow:hidden; position:relative; background-color: #f8f9fa;
    }
    iframe { width: 100%; height: 100%; border:none; }

    /* UI Status */
    .api-status { display:flex; align-items:center; gap:8px; font-size:12px; margin-bottom:15px; font-weight:600; }
    .dot { width:10px; height:10px; border-radius:50%; background:#bbb; }
    .dot.on { background:#2ecc71; box-shadow:0 0 10px #2ecc71; }

    #loadingOverlay {
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(255,255,255,0.9); display:none;
        align-items:center; justify-content:center; z-index:9999;
    }
    .spinner {
        width: 50px; height: 50px; border: 5px solid #f3f3f3;
        border-top: 5px solid var(--accent); border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div></div>

<header>
    <h1 style="font-family:Kanit;margin:0">AI Magic Canvas ‚ú®</h1>
    <p>‡πÄ‡∏ô‡∏£‡∏°‡∏¥‡∏ï‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô Interactive ‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏•‡∏±‡∏á Gemini Pro</p>
</header>

<main>
    <section>
        <div class="card">
            <div class="api-status">
                <div id="dot" class="dot"></div>
                <span id="statusText">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á API...</span>
            </div>
            <label>üîë Gemini API Key</label>
            <div style="display:flex; gap:10px;">
                <input type="password" id="geminiKey" placeholder="‡∏ß‡∏≤‡∏á API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
                <button onclick="testAndSaveKey()" style="width:auto; padding:0 20px; background:#34495e;">‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
            </div>
        </div>

        <div class="card">
            <label>ü§ñ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏∏‡∏°‡∏û‡∏•‡∏±‡∏á AI</label>
            <select id="modelSelect">
                <option value="gemini-1.5-pro">Gemini 1.5 Pro (‡∏â‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î - ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡∏Å)</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏ü‡∏£‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞)</option>
                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (‡∏ï‡∏±‡∏ß‡∏ó‡πá‡∏≠‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</option>
            </select>
        </div>

        <div class="card">
            <label>üé® ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏∞‡πÑ‡∏£? (‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Gemini Pro)</label>
            <textarea id="aiPrompt" rows="6" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏∞ ‡∏°‡∏µ‡∏î‡∏ß‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏°‡∏∏‡∏ô‡∏£‡∏≠‡∏ö‡πÜ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡∏ß‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡πÜ ‡∏°‡∏µ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏• ‡πÉ‡∏ä‡πâ Tailwind CSS"></textarea>
            <button onclick="magicGenerate()" style="margin-top:20px; background:linear-gradient(to right, #8e44ad, #c0392b);">
                <i class="fas fa-wand-magic-sparkles"></i> ‡πÄ‡∏ô‡∏£‡∏°‡∏¥‡∏ï‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô
            </button>
        </div>
    </section>

    <aside>
        <div class="phone-container">
            <div class="screen" id="canvasWrapper">
                <iframe id="previewFrame" srcdoc="<body style='display:flex;justify-content:center;align-items:center;height:90vh;font-family:sans-serif;color:#ccc;text-align:center;'><div>‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...<br>‡∏•‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡∏π‡∏™‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö</div></body>"></iframe>
            </div>
        </div>
        <button id="saveBtn" style="margin-top:20px; background:#2ecc71; display:none;" onclick="saveToDB()">
            <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </button>
    </aside>
</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
let teacherProfile = null;
let lastGeneratedCode = "";

// 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞ API Key ‡∏à‡∏≤‡∏Å Supabase ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î
document.addEventListener("DOMContentLoaded", async () => {
    const { data: { user } } = await sysDB.auth.getUser();
    if (!user) return window.location.href = 'teacher-login.html';

    const { data: profile } = await sysDB.from('teachers').select('*').eq('teacher_id', user.id).single();
    teacherProfile = profile;

    if (profile?.gemini_key) {
        document.getElementById('geminiKey').value = profile.gemini_key;
        updateStatusUI(true, "API Key ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå)");
    } else {
        updateStatusUI(false, "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key");
    }
});

function updateStatusUI(on, text) {
    document.getElementById('dot').className = on ? 'dot on' : 'dot';
    document.getElementById('statusText').textContent = text;
}

// 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ñ‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå
async function testAndSaveKey() {
    const key = document.getElementById('geminiKey').value.trim();
    document.getElementById('loadingOverlay').style.display = 'flex';
    try {
        const res = await fetch(`${API_BASE}/models?key=${key}`);
        const json = await res.json();
        if (json.error) throw new Error(json.error.message);

        updateStatusUI(true, "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        if (!teacherProfile?.gemini_key || teacherProfile.gemini_key !== key) {
            if (confirm("‚úÖ ‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ! ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå FlipSchool ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏ß‡∏£‡πÑ‡∏´‡∏°?")) {
                await sysDB.from('teachers').update({ gemini_key: key }).eq('teacher_id', teacherProfile.teacher_id);
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            }
        }
    } catch (e) {
        alert("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
        updateStatusUI(false, "‡∏Ñ‡∏µ‡∏¢‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô (Magic Generate)
async function magicGenerate() {
    const key = document.getElementById('geminiKey').value.trim();
    const model = document.getElementById('modelSelect').value;
    const prompt = document.getElementById('aiPrompt').value.trim();

    if (!prompt || !key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡∏µ‡∏¢‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

    document.getElementById('loadingOverlay').style.display = 'flex';
    const iframe = document.getElementById('previewFrame');
    iframe.srcdoc = "<body style='display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h3>‚ö° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡πà‡∏≤‡∏¢‡∏°‡∏ô‡∏ï‡∏£‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô...</h3></body>";

    // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô URL ‡∏ã‡πâ‡∏≠‡∏ô
    const cleanModel = model.replace('models/', '');
    const endpoint = `${API_BASE}/models/${cleanModel}:generateContent?key=${key}`;

    const instruction = `
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Creative Educational Tool
    ‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô 1 ‡∏´‡∏ô‡πâ‡∏≤ (Single HTML File) ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: "${prompt}"
    ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
    1. ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ (Modern UI) ‡πÅ‡∏•‡∏∞ Responsive ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
    2. ‡πÉ‡∏ä‡πâ Tailwind CSS, FontAwesome, ‡∏´‡∏£‡∏∑‡∏≠ Animate.css ‡∏ú‡πà‡∏≤‡∏ô CDN ‡πÑ‡∏î‡πâ
    3. ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô Interactive (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô, ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•, ‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°, ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö)
    4. ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ CODE HTML ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà Markdown backticks (‡πÄ‡∏ä‡πà‡∏ô \`\`\`html)
    5. ‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô Canva AI ‡∏´‡∏£‡∏∑‡∏≠ Gemini Pro
    `;

    try {
        const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: instruction }] }] })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);

        let code = data.candidates[0].content.parts[0].text;
        // Clean Code
        code = code.replace(/```html|```/g, "").trim();
        lastGeneratedCode = code;

        // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡∏á‡πÉ‡∏ô Canvas ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        iframe.srcdoc = code;
        document.getElementById('saveBtn').style.display = 'block';

    } catch (e) {
        alert("‚ùå AI ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: " + e.message);
        iframe.srcdoc = "<body>Error: " + e.message + "</body>";
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

async function saveToDB() {
    const cid = new URLSearchParams(window.location.search).get('cid');
    if (!cid) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");

    const { error } = await sysDB.from('missions').insert([{
        classroom_id: cid,
        title: document.getElementById('aiPrompt').value,
        mission_type: 'canvas_v2',
        mission_data: { html_code: lastGeneratedCode }
    }]);

    if (!error) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üéâ");
        window.location.href = `classroom-detail.html?id=${cid}`;
    }
}
</script>
</body>
</html>
