<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Canvas Mission - FlipSchool</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script src="js/supabase-db.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    body{margin:0;font-family:Sarabun;background:#f2f4f7;color:#333}
    header{background:linear-gradient(135deg,#141e30,#243b55);color:#fff;text-align:center;padding:30px 20px;border-radius:0 0-40px 40px}
    main{max-width:1300px;margin:20px auto;padding:0 20px;display:grid;grid-template-columns:1fr 450px;gap:20px}
    @media(max-width:1024px){main{grid-template-columns:1fr}}
    
    .card{background:#fff;border-radius:20px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,.05);margin-bottom:20px}
    label{font-family:Kanit;font-weight:500;display:block;margin-bottom:8px}
    input, textarea, select {width:100%;padding:12px;border-radius:12px;border:1.5px solid #ddd;box-sizing:border-box;margin-top:5px;font-family:inherit}
    
    button{border:none;border-radius:12px;padding:14px;background:#8e44ad;color:#fff;font-family:Kanit;cursor:pointer;width:100%;font-size:16px;transition:0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
    button:hover{filter:brightness(1.1);transform:translateY(-1px)}
    button.secondary{background:#34495e}

    /* AI Status */
    .status-box{display:flex;align-items:center;justify-content:space-between;background:#f8f9fa;padding:12px 20px;border-radius:15px;border:1px solid #eee;margin-bottom:20px}
    .dot{width:10px;height:10px;border-radius:50%;background:#bbb;margin-right:8px;display:inline-block}
    .dot.on{background:#2ecc71;box-shadow:0 0 8px #2ecc71}

    /* Phone Preview */
    .phone{background:#111;border-radius:50px;padding:12px;height:700px;position:sticky;top:20px;border:4px solid #333;box-shadow:0 25px 50px rgba(0,0,0,0.15)}
    .screen{background:#fff;border-radius:40px;height:100%;overflow:hidden;position:relative;display:flex;flex-direction:column}
    iframe{width:100%;height:100%;border:none;background:#fff}

    #codeView{background:#282c34;color:#abb2bf;padding:15px;border-radius:12px;font-size:12px;max-height:200px;overflow:auto;margin-top:10px;display:none}
</style>
</head>
<body>

<header>
    <h1 style="font-family:Kanit;margin:0">AI Canvas Designer üöÄ</h1>
    <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö Interactive (HTML/CSS/JS)</p>
</header>

<main>
    <section>
        <div class="card">
            <div class="status-box">
                <div><span id="dot" class="dot"></span><span id="statusText" style="font-size:13px;font-weight:600">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</span></div>
                <button onclick="testAndSaveKey()" style="width:auto;padding:5px 15px;font-size:12px;margin:0" class="secondary">‡∏ó‡∏î‡∏™‡∏≠‡∏ö & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå</button>
            </div>
            
            <label>üîë Gemini API Key</label>
            <input type="password" id="geminiKey" placeholder="‡∏ß‡∏≤‡∏á API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
        </div>

        <div class="card">
            <label>ü§ñ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•</label>
            <select id="modelSelect">
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (‡πÄ‡∏£‡πá‡∏ß/‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î)</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro (‡∏â‡∏•‡∏≤‡∏î/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏á)</option>
                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</option>
            </select>
        </div>

        <div class="card">
            <label>üé® ‡∏™‡∏±‡πà‡∏á AI ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏∑‡πà‡∏≠ (Prompt)</label>
            <textarea id="aiPrompt" rows="5" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ô‡πâ‡∏≥ 5 ‡∏Ñ‡∏≥ ‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ô‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ Tailwind CSS ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°"></textarea>
            <button onclick="generateCanvasContent()">
                <i class="fas fa-magic"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠ Interactive
            </button>
            <pre id="codeView"></pre>
        </div>
    </section>

    <aside>
        <div class="phone">
            <div class="screen">
                <iframe id="previewIframe" srcdoc="<body style='display:flex;justify-content:center;align-items:center;height:90vh;font-family:sans-serif;color:#ccc;'><div>‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div></body>"></iframe>
            </div>
        </div>
        <button id="saveBtn" style="margin-top:15px;background:#2ecc71;display:none" onclick="saveToSupabase()">
            <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </button>
    </aside>
</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
let teacherProfile = null;
let currentCode = "";

document.addEventListener("DOMContentLoaded", async () => {
    const { data: { user } } = await sysDB.auth.getUser();
    if (!user) return window.location.href = 'teacher-login.html';
    
    const { data: profile } = await sysDB.from('teachers').select('*').eq('teacher_id', user.id).single();
    teacherProfile = profile;

    if (profile?.gemini_key) {
        document.getElementById('geminiKey').value = profile.gemini_key;
        updateStatus(true, "‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
});

function updateStatus(ok, txt) {
    document.getElementById('dot').className = ok ? 'dot on' : 'dot';
    document.getElementById('statusText').textContent = txt;
}

async function testAndSaveKey() {
    const key = document.getElementById('geminiKey').value.trim();
    try {
        const res = await fetch(`${API_BASE}/models?key=${key}`);
        const json = await res.json();
        if (json.error) throw new Error(json.error.message);

        if (confirm("‚úÖ ‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÑ‡∏´‡∏°?")) {
            await sysDB.from('teachers').update({ gemini_key: key }).eq('teacher_id', teacherProfile.teacher_id);
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
        updateStatus(true, "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    } catch (e) {
        alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
        updateStatus(false, "‡∏Ñ‡∏µ‡∏¢‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
}

async function generateCanvasContent() {
    const key = document.getElementById('geminiKey').value.trim();
    const prompt = document.getElementById('aiPrompt').value.trim();
    const model = document.getElementById('modelSelect').value;

    if (!prompt || !key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

    const iframe = document.getElementById('previewIframe');
    iframe.srcdoc = "<html><body style='display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô...</h3></body></html>";

    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Model Name ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
    const cleanModel = model.replace('models/', '');
    const url = `${API_BASE}/models/${cleanModel}:generateContent?key=${key}`;

    const instruction = `
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Web Designer ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏•‡∏Å ‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á "‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö (Interactive)" ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: "${prompt}"
    ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö:
    1. ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô HTML/CSS/JS ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Single File) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    2. ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å Code
    3. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà Markdown Backticks (‡πÄ‡∏ä‡πà‡∏ô \`\`\`html)
    4. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏ö‡∏ö Mobile-First ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
    5. ‡πÉ‡∏ä‡πâ Tailwind CSS ‡∏ú‡πà‡∏≤‡∏ô CDN ‡πÑ‡∏î‡πâ
    `;

    try {
        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: instruction }] }] })
        });

        const json = await res.json();
        if (json.error) throw new Error(json.error.message);

        let code = json.candidates[0].content.parts[0].text;
        code = code.replace(/```html|```/g, "").trim();
        
        currentCode = code;
        iframe.srcdoc = code;
        
        document.getElementById('codeView').style.display = "block";
        document.getElementById('codeView').textContent = code;
        document.getElementById('saveBtn').style.display = "flex";

    } catch (e) {
        alert("‚ùå AI ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: " + e.message);
        iframe.srcdoc = "<body>Error: " + e.message + "</body>";
    }
}

async function saveToSupabase() {
    const cid = new URLSearchParams(window.location.search).get('cid');
    if (!cid) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");

    const { error } = await sysDB.from('missions').insert([{
        classroom_id: cid,
        title: document.getElementById('aiPrompt').value,
        mission_type: 'canvas',
        mission_data: { html: currentCode }
    }]);

    if (!error) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üéâ");
        window.location.href = `classroom-detail.html?id=${cid}`;
    }
}
</script>
</body>
</html>
