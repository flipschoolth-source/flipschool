<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>AI Mission Creator | FlipSchool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500&family=Sarabun&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #243b55; --accent: #8e44ad; }
        body { margin:0; font-family: Sarabun; background:#f2f4f7; }
        header { background: var(--primary); color:white; padding:30px; text-align:center; border-radius:0 0 40px 40px; }
        main { max-width:1200px; margin:-30px auto 40px; padding:0 20px; display:grid; grid-template-columns: 1fr 420px; gap:20px; }
        .card { background:#fff; border-radius:25px; padding:25px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
        .phone { background:#111; border-radius:45px; padding:12px; height:700px; position:sticky; top:20px; }
        .screen { background:#fff; border-radius:35px; height:100%; overflow:hidden; }
        iframe { width:100%; height:100%; border:none; }
        button { background:var(--accent); color:white; border:none; padding:15px; border-radius:12px; cursor:pointer; width:100%; font-family:Kanit; font-size:16px; }
    </style>
</head>
<body>

<header><h1 style="margin:0; font-family:Kanit;">AI Mission Creator üöÄ</h1></header>

<main>
    <section>
        <div class="card">
            <label style="font-family:Kanit">üéØ ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label>
            <input id="missionTitle" style="width:100%; padding:12px; margin:10px 0; border-radius:10px; border:1px solid #ddd;">
            
            <label style="font-family:Kanit">üí° ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á AI (Prompt)</label>
            <textarea id="aiPrompt" rows="5" style="width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; margin-top:10px;" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°‡∏™‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏è‡∏à‡∏±‡∏Å‡∏£‡∏ô‡πâ‡∏≥"></textarea>
            
            <button onclick="generateWithEdge()" style="margin-top:20px;">‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏î‡πâ‡∏ß‡∏¢ AI</button>
        </div>
        
        <div class="card" style="margin-top:20px;">
            <button onclick="saveMission()" style="background:#2ecc71;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        </div>
    </section>

    <aside>
        <div class="phone">
            <div class="screen">
                <iframe id="preview"></iframe>
            </div>
        </div>
    </aside>
</main>

<script>
// ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å js/config.js ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
let currentHTML = "";

async function generateWithEdge() {
    const prompt = document.getElementById('aiPrompt').value;
    if(!prompt) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á");

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Loading
    document.getElementById('preview').srcdoc = "<html><body style='display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h3>‚ö° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞...</h3></body></html>";

    try {
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Edge Function ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Google ‡∏ï‡∏£‡∏á‡πÜ
        const { data, error } = await supabase.functions.invoke('generate-mission', {
            body: { prompt: prompt }
        });

        if (error) throw error;

        currentHTML = data.html;
        document.getElementById('preview').srcdoc = currentHTML;
    } catch (e) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
    }
}

async function saveMission() {
    const title = document.getElementById('missionTitle').value;
    const cid = new URLSearchParams(location.search).get('cid'); // classroom_id ‡∏à‡∏≤‡∏Å URL

    if(!title || !currentHTML) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");

    const { error } = await supabase.from('missions').insert({
        classroom_id: cid,
        title: title,
        mission_type: 'canvas',
        content_data: { html: currentHTML },
        reward_points: 20
    });

    if(!error) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ");
    } else {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
    }
}
</script>
</body>
</html>
