<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Mission Create ‚ú® | FlipSchool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: "Sarabun", sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #333;
      min-height: 100vh;
    }

    header {
      padding: 40px 20px;
      text-align: center;
      color: white;
    }

    header h1 {
      margin: 0;
      font-size: 2.2rem;
      letter-spacing: 1px;
    }

    header p {
      opacity: 0.8;
      font-weight: 300;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 450px;
      gap: 30px;
      padding: 30px;
      max-width: 1300px;
      margin: auto;
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 12px;
      color: #1e293b;
      font-size: 1.1rem;
    }

    textarea {
      width: 100%;
      min-height: 180px;
      padding: 16px;
      font-size: 1rem;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      resize: vertical;
      font-family: inherit;
      box-sizing: border-box;
      outline: none;
      transition: border 0.3s;
    }

    textarea:focus {
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    button {
      margin-top: 20px;
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #7c3aed, #9333ea);
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
    }

    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .phone {
      background: #1e293b;
      border-radius: 40px;
      padding: 12px;
      height: 750px;
      border: 8px solid #334155;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      position: sticky;
      top: 20px;
    }

    .phone iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 30px;
      background: white;
    }

    .status {
      margin-top: 15px;
      font-size: 0.95rem;
      text-align: center;
      font-weight: 500;
      min-height: 24px;
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }
      .phone {
        height: 650px;
        max-width: 450px;
        margin: auto;
        position: static;
      }
    }
  </style>
</head>

<body>

<header>
  <h1>Mission Create ‚ú®</h1>
  <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (Powered by Gemini AI & Supabase)</p>
</header>

<div class="container">

  <div class="card">
    <label for="prompt">üß† ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£?</label>
    <textarea
      id="prompt"
      placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏õ.1 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏°‡∏≤‡∏ï‡∏£‡∏≤‡πÅ‡∏°‡πà‡∏Å‡∏° ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö 3 ‡∏Ç‡πâ‡∏≠"
    ></textarea>

    <button id="generateBtn" onclick="generateMission()">
      ‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á Mission
    </button>

    <div class="status" id="status"></div>
  </div>

  <div class="phone">
    <iframe id="preview" name="preview"></iframe>
  </div>

</div>

<script>
  // üîê CONFIG (Production)
  const SUPABASE_URL = "https://hznmvaxjlgjnrvtjosdt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bm12YXhqbGdqbnJ2dGpvc2R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NjQwMzMsImV4cCI6MjA4MjU0MDAzM30.o5W0oP8mnMOs9DWcvGgZ9F7E1EdysBuUu807UKdbqnE";

  const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function generateMission() {
    const promptEl = document.getElementById("prompt");
    const preview = document.getElementById("preview");
    const status = document.getElementById("status");
    const btn = document.getElementById("generateBtn");

    // ‡∏î‡∏∂‡∏á cid ‡∏à‡∏≤‡∏Å URL
    const urlParams = new URLSearchParams(window.location.search);
    const cid = urlParams.get('cid');

    const prompt = promptEl.value.trim();
    if (!prompt) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");
      return;
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    btn.disabled = true;
    status.style.color = "white";
    status.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ AI ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
    preview.srcdoc = `
      <div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:'Sarabun',sans-serif;flex-direction:column;gap:15px;color:#64748b;">
        <div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #7c3aed;border-radius:50%;animation:spin 1s linear infinite;"></div>
        <p>Gemini ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì...</p>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
      </div>
    `;

    try {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Edge Function "generate-mission"
      const { data, error } = await _supabase.functions.invoke("generate-mission", {
        body: { 
            prompt: prompt,
            cid: cid // ‡∏™‡πà‡∏á Course ID ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        }
      });

      if (error) throw error;

      if (data && data.html) {
        preview.srcdoc = data.html;
        status.textContent = "‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Mission ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
        status.style.color = "#4ade80";
      } else {
        throw new Error("‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• HTML ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö");
      }

    } catch (err) {
      console.error("Error details:", err);
      status.textContent = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (err.message || "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
      status.style.color = "#f87171";
      preview.srcdoc = `<div style="padding:20px;font-family:Sarabun;color:#f87171;"><h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3><p>${err.message}</p></div>`;
    } finally {
      btn.disabled = false;
    }
  }
</script>

</body>
</html>
