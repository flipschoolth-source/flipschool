<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mission Creator - FlipSchool</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body{margin:0;font-family:Sarabun, sans-serif;background:#f2f4f7;color:#333;}
        header{
            background:linear-gradient(135deg,#141e30,#243b55);
            color:#fff;text-align:center;padding:40px 20px;
            border-radius:0 0 40px 40px;box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        main{
            max-width:1200px;margin:-30px auto 40px;padding:0 20px;
            display:grid;grid-template-columns:1fr 420px;gap:25px
        }
        @media(max-width:1024px){main{grid-template-columns:1fr}}
        .card{
            background:#fff;border-radius:25px;padding:25px;
            box-shadow:0 10px 30px rgba(0,0,0,.06);margin-bottom:20px
        }
        label{font-family:Kanit;font-size:14px;font-weight:500;color:#555}
        input,textarea,select{
            width:100%;padding:12px;border-radius:12px;
            border:1px solid #ddd;box-sizing:border-box;margin-top:6px;font-family:inherit;
        }
        button{
            border:none;border-radius:12px;padding:12px;
            background:#8e44ad;color:#fff;
            font-family:Kanit;cursor:pointer;margin-top:10px;width:100%;
            transition: 0.3s;font-size:16px;
        }
        button:hover{opacity: 0.9; transform: translateY(-1px);}
        button.secondary{background:#34495e}
        .status{display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:10px}
        .dot{width:10px;height:10px;border-radius:50%;background:#bbb}
        .dot.on{background:#2ecc71;box-shadow:0 0 6px #2ecc71}

        .phone{
            background:#111;border-radius:45px;padding:12px;
            height:620px;position:sticky;top:20px;border: 4px solid #333;
        }
        .screen{
            background:#fff;border-radius:35px;height:100%;
            display:flex;flex-direction:column;
            padding:20px;overflow: hidden;position: relative;
        }
        .quiz-q{font-family:Kanit;font-size:18px;margin-bottom:20px;color: #141e30;}
        .choice{
            padding:12px;border-radius:12px;
            border:1px solid #ddd;margin-bottom:10px;
            cursor:pointer;transition: 0.2s;font-weight: 500;
        }
        .choice:hover{background: #f8f9fa;}
        .choice.correct{background:#eafaf1;border-color:#2ecc71;color:#1e7e44}
        .choice.wrong{background:#fdecea;border-color:#e74c3c;color:#a94442}
        .choice.disabled{pointer-events:none;opacity:.7}
        .footer{
            margin-top:auto;font-size:13px;color:#888;text-align:center;padding-bottom: 10px;
        }
        pre{
            background:#fafafa;padding:15px;border-radius:12px;
            font-size:12px;max-height:260px;overflow:auto;border: 1px solid #eee;
        }
        #loadingOverlay{
            position: fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(255,255,255,0.8);display:none;
            align-items:center;justify-content:center;z-index:9999;
        }
        .spinner {
            width: 40px;height: 40px;border: 4px solid #f3f3f3;
            border-top: 4px solid #8e44ad;border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>

<div id="loadingOverlay"><div class="spinner"></div></div>

<header>
    <h1 style="font-family:Kanit;margin:0">AI Mission Creator üöÄ</h1>
    <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏î‡πâ‡∏ß‡∏¢ Gemini AI x FlipSchool</p>
</header>

<main>
    <section>
        <div class="card">
            <div class="status">
                <div id="dot" class="dot"></div>
                <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            </div>

            <label><i class="fas fa-key"></i> Gemini API Key</label>
            <input type="password" id="geminiKey" placeholder="AIzaSy...">
            <button onclick="testApiKey()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
            <button class="secondary" onclick="listModels()">üìã ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•</button>
        </div>

        <div class="card">
            <label><i class="fas fa-robot"></i> ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ</label>
            <select id="modelSelect">
                <option value="gemini-1.5-flash-latest">gemini-1.5-flash-latest (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
            </select>
        </div>

        <div class="card">
            <label><i class="fas fa-lightbulb"></i> ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á, ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</label>
            <textarea id="aiPrompt" rows="3" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡πà‡∏≤ ‡∏õ.2"></textarea>
            <button onclick="generateByAI()" style="background: #243b55;">‚ú® ‡∏™‡∏±‡πà‡∏á AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
        </div>

        <div class="card">
            <label><i class="fas fa-code"></i> JSON Data (‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)</label>
            <div id="dataEditor"><p style="color:#ccc; font-size: 12px; text-align: center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>
        </div>
    </section>

    <aside>
        <div class="phone">
            <div class="screen" id="preview">
                <div style="text-align: center; margin-top: 50%;">
                    <i class="fas fa-mobile-alt" style="font-size: 50px; color: #eee;"></i>
                    <div class="footer">‡∏£‡∏≠‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‚Ä¶</div>
                </div>
            </div>
        </div>
        <button id="saveBtn" onclick="saveToClassroom()" style="margin-top: 20px; background: #2ecc71; display: none;">
            <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </button>
    </aside>
</main>

<script>
const API_BASE = "https://generativelanguage.googleapis.com/v1beta";
let quizData = [];
let index = 0;
let score = 0;
let teacherProfile = null;

// ================= ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏≤‡∏Å DB =================
document.addEventListener("DOMContentLoaded", async () => {
    const { data: { user } } = await sysDB.auth.getUser();
    if (!user) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
        window.location.href = 'teacher-login.html';
        return;
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ gemini_key ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÑ‡∏´‡∏°
    const { data: profile } = await sysDB
        .from('teachers')
        .select('*')
        .eq('teacher_id', user.id)
        .single();
    
    teacherProfile = profile;

    if (profile && profile.gemini_key) {
        document.getElementById('geminiKey').value = profile.gemini_key;
        testApiKey(true); // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ
    } else {
        document.getElementById('statusText').textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ API Key ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
    }
});

/* ================= API KEY TEST & SAVE ================= */
async function testApiKey(silent = false){
    const key = document.getElementById('geminiKey').value.trim();
    if(!key) return !silent ? alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key") : null;

    try{
        const res = await fetch(`${API_BASE}/models?key=${key}`);
        const json = await res.json();
        if(json.error) throw new Error(json.error.message);

        document.getElementById('dot').classList.add("on");
        document.getElementById('statusText').textContent = "API Key ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úî";
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô DB ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        if (!silent && (!teacherProfile || teacherProfile.gemini_key !== key)) {
            if (confirm("‚úÖ ‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                const { error } = await sysDB
                    .from('teachers')
                    .update({ gemini_key: key })
                    .eq('teacher_id', teacherProfile.teacher_id);
                
                if (!error) alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
            }
        }
        listModels(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

    }catch(e){
        document.getElementById('dot').classList.remove("on");
        document.getElementById('statusText').textContent = "API Key ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‚ùå";
        if(!silent) alert("‚ùå "+e.message);
    }
}

/* ================= LIST MODELS ================= */
async function listModels(){
    const key = document.getElementById('geminiKey').value.trim();
    if(!key) return;

    const res = await fetch(`${API_BASE}/models?key=${key}`);
    const json = await res.json();
    if(json.error) return;

    const select = document.getElementById("modelSelect");
    select.innerHTML = "";
    json.models
        .filter(m => m.supportedGenerationMethods?.includes("generateContent"))
        .forEach(m => {
            const opt = document.createElement("option");
            const name = m.name.replace("models/","");
            opt.value = name;
            opt.textContent = name;
            if(name === "gemini-1.5-flash-latest") opt.selected = true;
            select.appendChild(opt);
        });
}

/* ================= GENERATE BY AI ================= */
async function generateByAI(){
    const key = document.getElementById('geminiKey').value.trim();
    const model = document.getElementById('modelSelect').value;
    const prompt = document.getElementById('aiPrompt').value.trim();
    
    if(!key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key ‡∏Å‡πà‡∏≠‡∏ô");
    if(!prompt) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à");

    document.getElementById('loadingOverlay').style.display = 'flex';

    const instruction = `
    ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô
    ‡∏™‡∏£‡πâ‡∏≤‡∏á Quiz 3 ‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "${prompt}" 
    ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: [{"q":"‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°","ok":"‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å","no":"‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î"}]`;

    try {
        const res = await fetch(`${API_BASE}/models/${model}:generateContent?key=${key}`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                contents: [{parts: [{text: instruction}]}]
            })
        });

        const json = await res.json();
        if(json.error) throw new Error(json.error.message);

        let text = json.candidates[0].content.parts[0].text;
        // ‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏µ‡πà AI ‡∏≠‡∏≤‡∏à‡πÅ‡∏ñ‡∏°‡∏°‡∏≤
        text = text.replace(/```json|```/g, "").trim();
        quizData = JSON.parse(text);

        document.getElementById('dataEditor').innerHTML = `<pre>${JSON.stringify(quizData, null, 2)}</pre>`;
        document.getElementById('saveBtn').style.display = 'block';
        startPreview();
    } catch(e) {
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

/* ================= PREVIEW ENGINE ================= */
function startPreview(){
    index = 0; score = 0;
    renderQuestion();
}

function renderQuestion(){
    const q = quizData[index];
    // ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å-‡∏ú‡∏¥‡∏î
    const isOkFirst = Math.random() > 0.5;
    
    document.getElementById('preview').innerHTML = `
        <div class="quiz-q">${index+1}. ${q.q}</div>
        <div class="choice" onclick="answer(${isOkFirst})">${isOkFirst ? q.ok : q.no}</div>
        <div class="choice" onclick="answer(${!isOkFirst})">${!isOkFirst ? q.ok : q.no}</div>
        <div class="footer">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ${index+1}/${quizData.length}</div>
    `;
}

function answer(isCorrect){
    const choices = document.querySelectorAll(".choice");
    choices.forEach(c => c.classList.add("disabled"));

    // ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏™‡∏°‡∏≠ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)
    const allChoices = Array.from(choices);
    
    if(isCorrect){
        score++;
        event.target.classList.add("correct");
    } else {
        event.target.classList.add("wrong");
        // ‡πÄ‡∏â‡∏•‡∏¢‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å
        alert("‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠: " + quizData[index].ok);
    }

    setTimeout(() => {
        index++;
        index < quizData.length ? renderQuestion() : finish();
    }, 1000);
}

function finish(){
    document.getElementById('preview').innerHTML = `
        <div style="text-align:center; margin-top:30%;">
            <i class="fas fa-trophy" style="font-size:60px; color:#f1c40f;"></i>
            <h2 style="font-family:Kanit">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
            <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${score} / ${quizData.length}</p>
            <button onclick="startPreview()" class="secondary">‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
    `;
}

/* ================= SAVE TO DB (MISSION) ================= */
async function saveToClassroom() {
    const cid = new URLSearchParams(window.location.search).get('cid');
    if (!cid) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");

    const { error } = await sysDB.from('missions').insert([{
        classroom_id: cid,
        mission_type: 'quiz',
        mission_data: quizData,
        title: document.getElementById('aiPrompt').value
    }]);

    if (!error) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏•‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! üéâ");
        window.location.href = `classroom-detail.html?id=${cid}`;
    } else {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
    }
}
</script>

</body>
</html>
