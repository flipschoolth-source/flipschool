<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>สร้างห้องเรียนใหม่ - FlipSchool</title>
    <link rel="icon" href="img/favicon.png">

    <link rel="stylesheet" href="css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* CSS เฉพาะหน้านี้ (Gradient Presets) */
        .g-1 { background: linear-gradient(45deg, #ff9a9e, #fad0c4); }
        .g-2 { background: linear-gradient(45deg, #a18cd1, #fbc2eb); }
        .g-3 { background: linear-gradient(45deg, #84fab0, #8fd3f4); }
        .g-4 { background: linear-gradient(45deg, #fccb90, #d57eeb); }
        .g-5 { background: linear-gradient(45deg, #e0c3fc, #8ec5fc); }

        /* ปรับ Layout ฟอร์มให้เป็น Grid */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        
        /* ปุ่มเลือกสีแบบกำหนดเอง (+) */
        .custom-color-btn {
            background: #fff; border: 2px dashed #bbb;
            display: flex; justify-content: center; align-items: center;
            color: #888; font-size: 18px; overflow: hidden;
            width: 40px; height: 40px; border-radius: 50%; position: relative;
            cursor: pointer; transition: 0.2s;
        }
        .custom-color-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .custom-color-btn.selected { border: 2px solid #333; }
        
        /* Input Color ซ่อนอยู่ข้างใน */
        .custom-color-btn input[type="color"] {
            position: absolute; top: -10px; left: -10px;
            width: 200%; height: 200%;
            opacity: 0; cursor: pointer;
        }

        @media (max-width: 480px) { .form-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
    </style>
</head>
<body class="dashboard-page">

    <nav>
        <a href="#" class="nav-brand">
            <img src="img/favicon.png" alt="Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjNDM2MWVlIiBkPSJNMCAyNTZDMCAxMTQuNiAxMTQuNiAwIDI1NiAwczI1NiAxMTQuNiAyNTYgMjU2LTExNC42IDI1Ni0yNTYgMjU2UzAgMzk3LjQgMCAyNTZ6Ii8+PC9zdmc+'">
            <div>Flip<span>School</span></div>
        </a>
        <a href="teacher-dashboard.html" class="nav-btn" style="background:none; color:#666; font-size:24px;">
            <i class="fas fa-times"></i>
        </a>
    </nav>

    <div class="container">
        <div class="card-glass" style="max-width: 600px;">
            <div class="card-header">
                <i class="fas fa-plus-circle"></i>
                <h2>สร้างห้องเรียนใหม่</h2>
            </div>
            
            <form onsubmit="createClassroom(event)">
                <div class="form-grid">
                    
                    <div class="input-group full-width">
                        <label>ชื่อวิชา</label>
                        <input type="text" id="subject" placeholder="เช่น ภาษาไทย, คณิตศาสตร์" required>
                    </div>

                    <div class="input-group">
                        <label>ระดับชั้น/ห้อง</label>
                        <input type="text" id="room" placeholder="เช่น ป.1/1, ม.3/2" required>
                    </div>

                    <div class="input-group">
                        <label>ปีการศึกษา</label>
                        <input type="number" id="year" value="2568" required>
                    </div>

                    <div class="input-group full-width">
                        <label>ภาคเรียน</label>
                        <select id="semester">
                            <option value="1">ภาคเรียนที่ 1</option>
                            <option value="2">ภาคเรียนที่ 2</option>
                            <option value="ฤดูร้อน">ภาคฤดูร้อน</option>
                        </select>
                    </div>

                    <div class="input-group full-width">
                        <label>เลือกธีมสีการ์ด</label>
                        <div class="color-options">
                            <div class="color-option g-1 selected" onclick="selectPreset(this, 'linear-gradient(45deg, #ff9a9e, #fad0c4)')"></div>
                            <div class="color-option g-2" onclick="selectPreset(this, 'linear-gradient(45deg, #a18cd1, #fbc2eb)')"></div>
                            <div class="color-option g-3" onclick="selectPreset(this, 'linear-gradient(45deg, #84fab0, #8fd3f4)')"></div>
                            <div class="color-option g-4" onclick="selectPreset(this, 'linear-gradient(45deg, #fccb90, #d57eeb)')"></div>
                            
                            <div class="custom-color-btn" id="customColorBtn">
                                <i class="fas fa-plus" id="plusIcon"></i>
                                <input type="color" id="colorPicker" oninput="handleCustomColor(this)">
                            </div>
                        </div>
                    </div>

                </div>

                <button type="submit" class="btn-submit" id="btnSave">สร้างห้องเรียน</button>
            </form>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <script>
        let selectedGradient = 'linear-gradient(45deg, #ff9a9e, #fad0c4)'; // ค่าเริ่มต้น

        document.addEventListener('DOMContentLoaded', async () => {
            // เช็ค Auth ก่อน
            if (!sysDB) return;
            await checkAuthRedirect(); // ฟังก์ชันนี้อยู่ใน supabase-db.js แล้ว
        });

        // 1. ฟังก์ชันเลือกสีแบบ Preset
        function selectPreset(element, gradient) {
            document.querySelectorAll('.color-option, .custom-color-btn').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedGradient = gradient;

            // รีเซ็ตปุ่ม Custom
            const customBtn = document.getElementById('customColorBtn');
            customBtn.style.background = '#fff';
            document.getElementById('plusIcon').style.display = 'block';
        }

        // 2. ฟังก์ชันเมื่อเลือกสีเอง (Custom Color)
        function handleCustomColor(input) {
            const color = input.value;
            selectedGradient = `linear-gradient(45deg, ${color}, ${color})`;

            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            
            const customBtn = document.getElementById('customColorBtn');
            customBtn.classList.add('selected');
            customBtn.style.background = color;
            
            // ซ่อนไอคอนบวก
            document.getElementById('plusIcon').style.display = 'none';
        }

        // 3. ฟังก์ชันบันทึกข้อมูล
        async function createClassroom(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSave');
            btn.disabled = true; btn.innerText = 'กำลังสร้าง...';

            try {
                const { data: { user } } = await sysDB.auth.getUser();
                
                const newClass = {
                    teacher_id: user.id,
                    subject_name: document.getElementById('subject').value,
                    room_name: document.getElementById('room').value,
                    academic_year: document.getElementById('year').value,
                    semester: document.getElementById('semester').value,
                    color_code: selectedGradient
                };

                const { error } = await sysDB.from('classrooms').insert([newClass]);

                if (error) throw error;
                
                // สำเร็จ! กลับไป Dashboard
                window.location.href = 'teacher-dashboard.html';

            } catch (err) {
                console.error(err);
                alert('❌ เกิดข้อผิดพลาด: ' + err.message);
                btn.disabled = false; btn.innerText = 'สร้างห้องเรียน';
            }
        }
    </script>
</body>
</html>
