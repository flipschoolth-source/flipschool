<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>01สร้างห้องเรียนใหม่ - FlipSchool</title>
    <link rel="icon" href="img/favicon.png">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* CSS เดิม */
        .g-1 { background: linear-gradient(45deg, #ff9a9e, #fad0c4); }
        .g-2 { background: linear-gradient(45deg, #a18cd1, #fbc2eb); }
        .g-3 { background: linear-gradient(45deg, #84fab0, #8fd3f4); }
        .g-4 { background: linear-gradient(45deg, #fccb90, #d57eeb); }
        .g-5 { background: linear-gradient(45deg, #e0c3fc, #8ec5fc); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        
        .custom-color-btn {
            background: #fff; border: 2px dashed #bbb;
            display: flex; justify-content: center; align-items: center;
            color: #888; font-size: 18px; overflow: hidden;
            width: 40px; height: 40px; border-radius: 50%; position: relative;
            cursor: pointer; transition: 0.2s;
        }
        .custom-color-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .custom-color-btn.selected { border: 2px solid #333; }
        
        .custom-color-btn input[type="color"] {
            position: absolute; top: -10px; left: -10px;
            width: 200%; height: 200%; opacity: 0; cursor: pointer;
        }

        @media (max-width: 480px) { .form-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
    </style>
</head>
<body class="dashboard-page">

    <nav>
        <a href="teacher-dashboard.html" class="nav-brand">
            <img src="img/favicon.png" alt="Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjNDM2MWVlIiBkPSJNMCAyNTZDMCAxMTQuNiAxMTQuNiAwIDI1NiAwczI1NiAxMTQuNiAyNTYgMjU2LTExNC42IDI1Ni0yNTYgMjU2UzAgMzk3LjQgMCAyNTZ6Ii8+PC9zdmc+'">
            <div>Flip<span>School</span></div>
        </a>
        <a href="teacher-dashboard.html" class="back-link">
            <i class="fas fa-times"></i> ยกเลิก
        </a>
    </nav>

    <div class="container">
        <div class="card-glass" style="max-width: 600px;">
            <div class="card-header">
                <i class="fas fa-plus-circle"></i>
                <h2>สร้างห้องเรียนใหม่</h2>
            </div>
            
            <form onsubmit="createClassroom(event)">
                <div class="form-grid">
                    <div class="input-group full-width">
                        <label>ชื่อวิชา</label>
                        <input type="text" id="subject" placeholder="เช่น ภาษาไทย, คณิตศาสตร์" required>
                    </div>

                    <div class="input-group">
                        <label>ระดับชั้น/ห้อง</label>
                        <input type="text" id="room" placeholder="เช่น ป.1/1, ม.3/2" required>
                    </div>

                    <div class="input-group">
                        <label>ปีการศึกษา</label>
                        <input type="number" id="year" value="2569" required>
                    </div>

                    <div class="input-group full-width">
                        <label>ภาคเรียน</label>
                        <select id="semester">
                            <option value="1">ภาคเรียนที่ 1</option>
                            <option value="2">ภาคเรียนที่ 2</option>
                            <option value="ฤดูร้อน">ภาคฤดูร้อน</option>
                        </select>
                    </div>

                    <div class="input-group full-width">
                        <label>เลือกธีมสีการ์ด</label>
                        <div class="color-options">
                            <div class="color-option g-1 selected" onclick="selectPreset(this, 'linear-gradient(45deg, #ff9a9e, #fad0c4)')"></div>
                            <div class="color-option g-2" onclick="selectPreset(this, 'linear-gradient(45deg, #a18cd1, #fbc2eb)')"></div>
                            <div class="color-option g-3" onclick="selectPreset(this, 'linear-gradient(45deg, #84fab0, #8fd3f4)')"></div>
                            <div class="color-option g-4" onclick="selectPreset(this, 'linear-gradient(45deg, #fccb90, #d57eeb)')"></div>
                            <div class="custom-color-btn" id="customColorBtn">
                                <i class="fas fa-plus" id="plusIcon"></i>
                                <input type="color" id="colorPicker" oninput="handleCustomColor(this)">
                            </div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-submit" id="btnSave">สร้างห้องเรียน</button>
            </form>
        </div>
    </div>

    <script>
        // Config
        const SUPABASE_URL = 'https://hznmvaxjlgjnrvtjosdt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bm12YXhqbGdqbnJ2dGpvc2R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NjQwMzMsImV4cCI6MjA4MjU0MDAzM30.o5W0oP8mnMOs9DWcvGgZ9F7E1EdysBuUu807UKdbqnE';
        let sysDB = null;
        let selectedGradient = 'linear-gradient(45deg, #ff9a9e, #fad0c4)';

        document.addEventListener('DOMContentLoaded', async () => {
            if(window.supabase) {
                sysDB = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const { data: { user } } = await sysDB.auth.getUser();
                if (!user) window.location.href = 'teacher-login.html';
            }
        });

        function selectPreset(element, gradient) {
            document.querySelectorAll('.color-option, .custom-color-btn').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedGradient = gradient;
            document.getElementById('customColorBtn').style.background = '#fff';
            document.getElementById('plusIcon').style.display = 'block';
        }

        function handleCustomColor(input) {
            const color = input.value;
            selectedGradient = `linear-gradient(45deg, ${color}, ${color})`;
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            const customBtn = document.getElementById('customColorBtn');
            customBtn.classList.add('selected');
            customBtn.style.background = color;
            document.getElementById('plusIcon').style.display = 'none';
        }

        // --- ฟังก์ชันหลักที่แก้ไข ---
        async function createClassroom(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSave');
            btn.disabled = true; btn.innerText = 'กำลังตรวจสอบ...';

            const subject = document.getElementById('subject').value.trim();
            const room = document.getElementById('room').value.trim();
            const year = document.getElementById('year').value;
            const semester = document.getElementById('semester').value;

            try {
                const { data: { user } } = await sysDB.auth.getUser();
                if (!user) throw new Error("กรุณาเข้าสู่ระบบ");

                // 1. เช็คว่ามีห้องเรียนซ้ำหรือไม่?
                const { data: existingClass, error: checkError } = await sysDB
                    .from('classrooms')
                    .select('classroom_id')
                    .eq('teacher_id', user.id)
                    .eq('subject_name', subject)
                    .eq('room_name', room)
                    .eq('academic_year', year)
                    .eq('semester', semester);

                if (checkError) throw checkError;

                // ถ้าเจอข้อมูลซ้ำ (Length > 0) ให้แจ้งเตือนและหยุด
                if (existingClass && existingClass.length > 0) {
                    alert(`⚠️ มีห้องเรียน "${subject}" (${room}) ปี ${year} เทอม ${semester} อยู่แล้ว!`);
                    btn.disabled = false; 
                    btn.innerText = 'สร้างห้องเรียน';
                    return; // หยุดการทำงานตรงนี้ ไม่บันทึก
                }

                // 2. ถ้าไม่ซ้ำ ให้บันทึกตามปกติ
                btn.innerText = 'กำลังบันทึก...';

                // (Optional) ดึง school_id ถ้าจำเป็น
                const { data: teacherData } = await sysDB.from('teachers').select('school_id').eq('teacher_id', user.id).single();
                
                const newClass = {
                    teacher_id: user.id,
                    school_id: teacherData ? teacherData.school_id : null,
                    subject_name: subject,
                    room_name: room,
                    academic_year: year,
                    semester: semester,
                    color_code: selectedGradient
                };

                const { error: insertError } = await sysDB.from('classrooms').insert([newClass]);
                if (insertError) throw insertError;

                window.location.href = 'teacher-dashboard.html';

            } catch (err) {
                console.error(err);
                alert('❌ เกิดข้อผิดพลาด: ' + err.message);
                btn.disabled = false; btn.innerText = 'สร้างห้องเรียน';
            }
        }
    </script>
</body>
</html>
