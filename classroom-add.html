<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>สร้างห้องเรียนใหม่ - FlipSchool</title>
    <link rel="icon" href="img/favicon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #00008B;
            --primary-light: #0000cd;
            --accent: #FF8C00;
            --bg-body: #f4f7fe;
            --white: #ffffff;
        }

        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-body);
            display: flex;
            flex-direction: column;
            color: #2b2d42;
        }

        /* --- Navbar (Same as index.html) --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 40px; background-color: var(--white);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: sticky; top: 0; z-index: 1000; width: 100%; box-sizing: border-box;
        }
        .logo-container { display: flex; align-items: center; gap: 12px; text-decoration: none; cursor: pointer; }
        .logo-container img { height: 40px; }
        .brand-name { font-size: 22px; font-weight: 600; color: #333; font-family: 'Kanit'; }
        .brand-name span { color: var(--primary); }
        .back-link { 
            text-decoration: none; color: #666; font-size: 15px; 
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
            font-family: 'Kanit';
        }
        .back-link:hover { color: var(--primary); }

        /* --- Content --- */
        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
        }

        .container { width: 100%; max-width: 550px; }
        .card-form {
            background: var(--white); border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            padding: 40px; border: 1px solid #eee;
        }

        h2 { font-family: 'Kanit', sans-serif; margin-top: 0; color: var(--primary); font-size: 24px; display: flex; align-items: center; gap: 12px; }
        p.subtitle { color: #888; margin-bottom: 30px; margin-top: -10px; font-size: 14px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }

        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #444; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 12px 15px; border: 1.5px solid #eee;
            border-radius: 12px; font-family: 'Sarabun', sans-serif; font-size: 16px;
            box-sizing: border-box; transition: 0.3s; background: #fafafa;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: white; box-shadow: 0 0 0 4px rgba(0, 0, 139, 0.05); }

        /* Color Picker */
        .color-options { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 5px; }
        .color-option {
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            border: 3px solid white; transition: 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .color-option.selected { transform: scale(1.15); box-shadow: 0 0 0 2px var(--primary); }
        
        /* Gradients */
        .g-1 { background: linear-gradient(135deg, #00008B, #4361ee); }
        .g-2 { background: linear-gradient(135deg, #6a11cb, #2575fc); }
        .g-3 { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .g-4 { background: linear-gradient(135deg, #FF8C00, #ffae42); }

        .custom-color-btn {
            background: #f0f0f0; border: 2px dashed #ccc;
            display: flex; justify-content: center; align-items: center;
            color: #888; width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; position: relative; overflow: hidden;
        }
        .custom-color-btn input[type="color"] { position: absolute; opacity: 0; cursor: pointer; }

        .btn-submit {
            width: 100%; padding: 15px; border: none; border-radius: 50px;
            background: var(--primary); color: white;
            font-family: 'Kanit', sans-serif; font-size: 18px; font-weight: 600;
            cursor: pointer; margin-top: 30px; transition: 0.3s;
        }
        .btn-submit:hover:not(:disabled) { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 139, 0.2); }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

        .footer { width: 100%; padding: 25px; font-size: 0.9rem; color: #888; text-align: center; background: #fff; border-top: 1px solid #eee; box-sizing: border-box; }

        @media (max-width: 480px) { .form-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
    </style>
</head>
<body>

    <nav>
        <a href="teacher-dashboard.html" class="logo-container">
            <img src="img/favicon.png" alt="Logo">
            <div class="brand-name">Flip<span>School</span></div>
        </a>
        <a href="teacher-dashboard.html" class="back-link">
            <i class="fas fa-times"></i> ยกเลิก
        </a>
    </nav>

    <div class="main-content">
        <div class="container">
            <div class="card-form">
                <h2><i class="fas fa-plus-circle"></i> สร้างห้องเรียนใหม่</h2>
                <p class="subtitle">ระบุรายละเอียดวิชาเพื่อเริ่มต้นจัดการเรียนรู้แบบ GLORY Model</p>
                
                <form onsubmit="createClassroom(event)">
                    <div class="form-grid">
                        <div class="input-group full-width">
                            <label>ชื่อวิชา *</label>
                            <input type="text" id="subject" placeholder="เช่น ภาษาไทย, เทคโนโลยี" required>
                        </div>

                        <div class="input-group">
                            <label>ระดับชั้น/ห้อง *</label>
                            <input type="text" id="room" placeholder="เช่น ป.1/1, ม.3/2" required>
                        </div>

                        <div class="input-group">
                            <label>ปีการศึกษา (พ.ศ.) *</label>
                            <input type="number" id="year" value="2569" required>
                        </div>

                        <div class="input-group full-width">
                            <label>ภาคเรียน</label>
                            <select id="semester">
                                <option value="1">ภาคเรียนที่ 1</option>
                                <option value="2">ภาคเรียนที่ 2</option>
                                <option value="ฤดูร้อน">ภาคฤดูร้อน</option>
                            </select>
                        </div>

                        <div class="input-group full-width">
                            <label>เลือกธีมสีห้องเรียน</label>
                            <div class="color-options">
                                <div class="color-option g-1 selected" onclick="selectPreset(this, 'linear-gradient(135deg, #00008B, #4361ee)')"></div>
                                <div class="color-option g-2" onclick="selectPreset(this, 'linear-gradient(135deg, #6a11cb, #2575fc)')"></div>
                                <div class="color-option g-3" onclick="selectPreset(this, 'linear-gradient(135deg, #11998e, #38ef7d)')"></div>
                                <div class="color-option g-4" onclick="selectPreset(this, 'linear-gradient(135deg, #FF8C00, #ffae42)')"></div>
                                
                                <div class="custom-color-btn" id="customColorBtn">
                                    <i class="fas fa-eye-dropper" id="plusIcon"></i>
                                    <input type="color" id="colorPicker" oninput="handleCustomColor(this)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-submit" id="btnSave">ยืนยันการสร้างห้องเรียน</button>
                </form>
            </div>
        </div>
    </div>

    <footer class="footer">
        &copy; 2026 FlipSchool. วิจัยและพัฒนานวัตกรรมเพื่อการจัดการเรียนรู้ GLORY Model
    </footer>

    

    <script src="js/config.js"></script>
    <script src="js/supabase-db.js"></script>

    <script>
        let selectedGradient = 'linear-gradient(135deg, #00008B, #4361ee)'; 

        document.addEventListener('DOMContentLoaded', async () => {
            if (!sysDB) { alert('ระบบฐานข้อมูลไม่พร้อมใช้งาน'); return; }
            
            const { data: { user } } = await sysDB.auth.getUser();
            if (!user) window.location.href = 'teacher-login.html';
        });

        function selectPreset(element, gradient) {
            document.querySelectorAll('.color-option, .custom-color-btn').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedGradient = gradient;
            
            const customBtn = document.getElementById('customColorBtn');
            customBtn.style.background = '#f0f0f0';
        }

        function handleCustomColor(input) {
            const color = input.value;
            selectedGradient = `linear-gradient(135deg, ${color}, ${color})`;
            
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            const customBtn = document.getElementById('customColorBtn');
            customBtn.classList.add('selected');
            customBtn.style.background = color;
        }

        async function createClassroom(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSave');
            
            // 1. ดึงข้อมูลและทำความสะอาด
            const subject = document.getElementById('subject').value.trim();
            const room = document.getElementById('room').value.trim();
            const year = document.getElementById('year').value;
            const semester = document.getElementById('semester').value;

            if (!subject || !room) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบข้อมูล...';

            try {
                const { data: { user } } = await sysDB.auth.getUser();
                
                // 2. ดึงข้อมูลครูเพื่อเอา school_id
                const { data: teacher, error: tErr } = await sysDB
                    .from('teachers')
                    .select('school_id')
                    .eq('teacher_id', user.id)
                    .single();

                if (tErr || !teacher.school_id) throw new Error("ไม่พบข้อมูลโรงเรียนของคุณ");

                // 3. ตรวจสอบห้องเรียนซ้ำ (Manual Check เพื่อความแม่นยำและการแจ้งเตือน)
                const { data: existing, error: checkErr } = await sysDB
                    .from('classrooms')
                    .select('classroom_id')
                    .eq('teacher_id', user.id)
                    .eq('subject_name', subject)
                    .eq('room_name', room)
                    .eq('academic_year', year)
                    .eq('semester', semester)
                    .maybeSingle();

                if (existing) {
                    alert(`⚠️ คุณมีห้องเรียนวิชา "${subject}" สำหรับ "${room}" ในปี/เทอมนี้อยู่แล้วครับ`);
                    btn.disabled = false;
                    btn.innerText = 'ยืนยันการสร้างห้องเรียน';
                    return;
                }

                // 4. บันทึกข้อมูล
                const { error: insErr } = await sysDB.from('classrooms').insert([{
                    teacher_id: user.id,
                    school_id: teacher.school_id,
                    subject_name: subject,
                    room_name: room,
                    academic_year: year,
                    semester: semester,
                    color_code: selectedGradient
                }]);

                if (insErr) throw insErr;

                // 5. สำเร็จ
                window.location.href = 'teacher-dashboard.html';

            } catch (err) {
                console.error(err);
                alert('❌ เกิดข้อผิดพลาด: ' + err.message);
                btn.disabled = false;
                btn.innerText = 'ยืนยันการสร้างห้องเรียน';
            }
        }
    </script>
</body>
</html>
